\documentclass[a4paper]{amsart}

%                  Trash .aux file after toggling
\usepackage{stmaryrd}
\usepackage{graphicx}
\usepackage[margin=1in]{geometry}
\usepackage[lutzsyntax]{virginialake}\aftrianglefalse
\usepackage[pdfborder={0 0 0}]{hyperref}
\usepackage[urw-garamond]{mathdesign}

%--------- Theorem etc
\newtheorem{thm}{Theorem}[section]
\newtheorem{cor}[thm]{Corollary}
\newtheorem{lem}[thm]{Lemma}
\newtheorem{pro}[thm]{Proposition}

\theoremstyle{remark}
\newtheorem{rem}[thm]{Remark}
\newtheorem{exa}[thm]{Example}

\theoremstyle{definition}
\newtheorem{defi}[thm]{Definition}
%---------

\begin{document}

\title[Normalisation Control in Deep Inference   via Atomic Flows II]
      {Normalisation Control in Deep Inference\\ via Atomic Flows II}

\author{Alessio Guglielmi and Tom Gundersen}
%\address{University of Bath, Bath BA2 7AY, UK}

\thanks{This work was in part funded by an Overseas Research Scholarship and a Research Studentship, both from the University of Bath, and by the British Council Alliance Programme.}

\keywords{Normalisation, deep inference, cut elimination, atomic flows}

\subjclass{F.4.1 Mathematical Logic---Proof theory}

% \begin{abstract}
% \end{abstract}

\maketitle

%===============================================================================
\section{Background on Deep Inference}

Deep inference is a relatively recent development in proof theory. It is a methodology according to which several formalisms can be defined with excellent structural properties. The calculus of structures \cite{Gugl:06:A-System:kl} is one of them and is now well developed for classical \cite{Brun:03:Atomic-C:oz,Brun:06:Cut-Elim:cq,Brun:06:Locality:zh,BrunTiu:01:A-Local-:mz,Brun:06:Deep-Inf:qy}, intuitionistic \cite{Tiu:06:A-Local-:gf}, linear \cite{Stra:02:A-Local-:ul,Stra:03:MELL-in-:oy}, modal \cite{Brun::Deep-Seq:ay,GoreTiu:06:Classica:uq,Stou:06:A-Deep-I:rt} and commutative/non-commutative logics \cite{Gugl:06:A-System:kl,Tiu:06:A-System:ai,Stra:03:Linear-L:lp,Brus:02:A-Purely:wd,Di-G:04:Structur:wy,GuglStra:01:Non-comm:rp,GuglStra:02:A-Non-co:lq,GuglStra:02:A-Non-co:dq,Kahr:06:Reducing:hc,Kahr:07:System-B:fk}. The basic proof complexity properties of the calculus of structures are known \cite{BrusGugl:07:On-the-P:fk}. The calculus of structures promoted the discovery of a new class of proof nets for classical and linear logic \cite{LamaStra:05:Construc:qq,LamaStra:05:Naming-P:ov,LamaStra:06:From-Pro:et,StraLama:04:On-Proof:ec} (see also \cite{Guir:06:The-Thre:qt}). There exist implementations in Maude of deep-inference proof systems \cite{Kahr:07:Maude-as:lr}. For a better introduction than this, we refer the reader to \cite{Brun:03:Atomic-C:oz}.

\newcommand{\fff}{\mathsf f}
\newcommand{\ttt}{\mathsf t}

%---------------------------------------
\begin{defi}
\emph{Formulae}, $\alpha$, $\beta$, $\gamma$, $\delta$ are freely built from: \emph{units}, $\fff$ (false), $\ttt$ (true); \emph{atoms}, $a$, $b$, $c$, $d$, $e$; \emph{disjunction} and \emph{conjunction}, ${\vlsbr[\alpha.\beta]}$ and $\vlsbr(\alpha.\beta)$. On the set of atoms a (non-identical) involution $\bar\cdot$ is defined, and dual atom occurrences, as $a$ and $\bar a$, can appear in formulae. We denote \emph{contexts}, \emph{i.e.}, formulae with a hole, by $\xi\vlhole$ and $\zeta\vlhole$; we also use \emph{multiple} contexts, $\xi\vlhole\cdots\vlhole$, \emph{i.e.}, formulae with many holes; for example, if $\xi\{a\}$ is $\vls(b.[a.c])$, then $\xi\vlhole$ is $\vls(b.[\vlhole.c])$, $\xi\{b\}$ is $\vls(b.[b.c])$ and $\xi\vlscn(a.d)$ is $\vls(b.[(a.d).c])$; if $\xi\{a\}\{b\}\{c\}$ is $\vls(b.[(a.d).c])$ then $\xi\{b\}\{c\}\{a\}$ is $\vls(c.[(b.d).a])$.
\end{defi}

%---------------------------------------
\begin{rem}
Negation is only defined for atoms, which is not a limitation thanks to De Morgan laws.
\end{rem}

Note that when we write $\xi\{a\}$, we mean that an occurrence of $a$ exists in the formula, we singled it out and we refer specifically to that occurrence. It is important to distinguish between an atom $a$ and a set of occurrences of atom $a$ inside a formula or a derivation. In the following, we mark in various ways occurrences of atoms, and we perform several substitutions of formulae in the place of atom occurrences.

\newcommand{\one}{{\mathchoice{\scriptstyle\mathbf1}
                              {\scriptstyle\mathbf1}
                              {\scriptstyle\mathbf1}
                              {\scriptscriptstyle\mathbf1}}}
\newcommand{\two}{{\mathchoice{\scriptstyle\mathbf2}
                              {\scriptstyle\mathbf2}
                              {\scriptstyle\mathbf2}
                              {\scriptscriptstyle\mathbf2}}}
%---------------------------------------
\begin{defi}
\emph{Inference rules}, $\rho$, have one \emph{premiss} and one \emph{conclusion}, and their \emph{instances} are used in \emph{inference steps} to rewrite inside formulae. A \emph{derivation}, $\Phi$, from $\alpha$ (\emph{premiss}) to $\beta$ (\emph{conclusion}) is a chain of inference steps with $\alpha$ at the top and $\beta$ at the bottom, and is usually indicated by $\vlder{\Phi}{\mathcal S}{\beta}{\alpha}$, where $\mathcal S$ is the name of the deductive system or a set of inference rules; a \emph{proof} is a derivation from $\ttt$; besides $\Phi$, we denote derivations with $\Psi$. We denote with $\xi\{\Phi\}$ the result of including every formula of the derivation $\Phi$ from $\alpha$ to $\beta$ into the context $\xi\vlhole$: since we adopt deep inference, $\xi\{\Phi\}$ from $\xi\{\alpha\}$ to $\xi\{\beta\}$ is a valid derivation. Furthermore, $\xi\left\{\vlder{}{}{\beta_1}{\alpha_1}\right\}\cdots\left\{\vlder{}{}{\beta_n}{\alpha_n}\right\}$ denotes
\[
\vlderivation
{
 \vlin{=}{}{\xi\{\beta_1\}\cdots\{\beta_{n-1}\}\left\{\vlder{}{}{\beta_n}{\alpha_n}\right\}}
 {
  \vlin{=}{}{\vdots}
  {
   \vlin{=}{}{\xi\{\beta_1\}\cdots\{\beta_{i-1}\}\left\{\vlder{}{}{\beta_i}{\alpha_i}\right\}\{\alpha_{i+1}\}\cdots\{\alpha_n\}}
   {
    \vlin{=}{}{\vdots}
    {
     \vlhy{\xi\left\{\vlder{}{}{\beta_1}{\alpha_1}\right\}\{\alpha_2\}\cdots\{\alpha_n\}}
    }
   }
  }
 }
}\quad.
\]
\end{defi}

% TODO: Redo (see handwritten notes)
%\begin{rem}
%Although the caluclus of structures does not allow for independent parts of a derivation to happen in parallell, it is a natural and more efficient way of thinking of derivations and this motivated the above notation. In a new formalism being developed by us and others, Formalism A, derivations written in parallell is a representative of the equivalence class of all possible interleavings of the said derivations. In this paper we do not need the full power of Formalism A, so for the sake of efficiency we chose a parallell derivation to stand for one particular calculus of structures derivation rather than an equivelance class.
%\end{rem}

\newcommand{\KS}{\mathsf{KS}}
\newcommand{\SKS}{\mathsf{SKS}}
Now we define the two standard deductive systems for classical propositional logic in deep inference that are used throughout the paper. $\KS$ is analytic, in the sense that premisses only contain subformulae of conclusions, and $\SKS$ is not \cite{Brun:03:Atomic-C:oz,Brun:06:Cut-Elim:cq,Brun:06:Locality:zh,BrunTiu:01:A-Local-:mz}.

\newcommand{\ai}{\mathsf{ai}}
\newcommand{\aw}{\mathsf{aw}}
\newcommand{\ac}{\mathsf{ac}}
\newcommand{\aid}{{\ai{\downarrow}}}
\newcommand{\awd}{{\aw{\downarrow}}}
\newcommand{\acd}{{\ac{\downarrow}}}
\newcommand{\aiu}{{\ai{\uparrow}}}
\newcommand{\awu}{{\aw{\uparrow}}}
\newcommand{\acu}{{\ac{\uparrow}}}
\newcommand{\swi}{\mathsf{s}}
\newcommand{\med}{\mathsf{m}}
%---------------------------------------
\begin{defi}
System $\SKS$ in the calculus of structures is defined by the following \emph{structural} rules:
\[
\begin{array}{@{}c@{}c@{}c@{}}
      \vlinf{\aid}{}{\vls[a.{\bar a}]}{\ttt}&
\qquad\vlinf{\awd}{}a\fff&
\qquad\vlinf{\acd}{}a{\vls[a.a]}\\
\noalign{\smallskip}
      \emph{interaction}&
\qquad\emph{weakening}&
\qquad\emph{contraction}\\
\noalign{\bigskip}
      \vlinf{\aiu}{}\fff{\vls(a.{\bar a})}&
\qquad\vlinf{\awu}{}\ttt a&
\qquad\vlinf{\acu}{}{\vls (a.a)}a\\
\noalign{\smallskip}
      \emph{cointeraction}&
\qquad\emph{coweakening}&
\qquad\emph{cocontraction}\\
\end{array}\quad,
\]
and by the two \emph{logical} rules:
\[
\begin{array}{@{}c@{}c@{}}
\vlinf{\swi}{}{\vls[(\alpha.\beta).\gamma]}{\vls(\alpha.[\beta.\gamma])}&\qquad
\vlinf{\med}{}{\vls([\alpha.\gamma].[\beta.\delta])}
              {\vls[(\alpha.\beta).(\gamma.\delta)]}\\
\noalign{\smallskip}
\emph{switch}&\qquad\emph{medial}\\
\end{array}\quad.
\]
The rule cointeraction is also called an (\emph{atomic}) \emph{cut}. In addition to the rules shown, there is a rule $\vldownsmash{\vlinf={}\delta\gamma}$, such that $\gamma$ and $\delta$ are opposite sides in one of the following equations:
\vlstore{
\vls[\alpha.\beta]         &=\vls[\beta.\alpha]         \quad,&
\vls[\alpha.\fff]          &=\vls[\alpha]               \quad,\\
\vls(\alpha.\beta)         &=\vls(\beta.\alpha)         \quad,&
\vls(\alpha.\ttt)          &=\vls(\alpha)               \quad,\\
\vls[[\alpha.\beta].\gamma]&=\vls[\alpha.[\beta.\gamma]]\quad,&
\vls[\ttt.\ttt]            &=\vls[\ttt]                 \quad,\\
\vls((\alpha.\beta).\gamma)&=\vls(\alpha.(\beta.\gamma))\quad,&
\vls(\fff.\fff)            &=\vls(\fff)                 \quad\vldot}
\begin{align*}
\vlread
\end{align*}
We do not always show the instances of rule $=$, and when we do show them, we gather several contiguous instances into one. System $\KS$ is the same as $\SKS$, but without the rules $\aiu$, $\awu$ and $\acu$. A \emph{cut-free} derivation is a derivation where $\aiu$ is not used. All derivations in this paper are in $\SKS$, unless indicated otherwise.
\end{defi}

% TODO: Redo
%\begin{rem}
%It is important not to confuse the repersenetation of a derivation with the actual derivation. Although the representation of derivations we use in this paper might be slightly ambigous, the actual derivations they represent contain all the needed information to disambiguate them. In particular we often ommit or collapse many equations into one, but the actual derivation contains each equation instance, and in particular it contains information about which equation was used and exactly which subformula is mapped to which metavariable in the rule. Consider the following representation of an inference rule $\vlinf{=}{}{\vls(a.(a.a))}{\vls((a.a).a)}$, this does not contain enough information to determine which $a$ in the conclusion corresponds to which $a$ in the premiss. However, the actual inference rule will also tell us if the commutative or associative equaiton was used, so this is not a problem.
%\end{rem}

Note that all the structural rules only apply to atoms. As shown later, equivalent structural rules applying to formulae instead of atoms can be derived from the atomic ones together with the logical rules. The fact that we can work only with atomic structural rules is essential later on.

Instead of the term `axiom' we use `interaction'; the reason is that, in deep inference, axioms do not close derivation branches. However, it is not misleading to think of interaction instances as axiom instances in the sequent calculus. In several papers, including \cite{Brun:03:Atomic-C:oz}, the reader can find explanations of how reducing a proof in $\SKS$ to a proof in $\KS$ is a cut-elimination process in the traditional sense. In other words, the rules $\aiu$, $\awu$ and $\acu$ are, together, morally equivalent to a cut in the sequent calculus.

%===============================================================================

\subsection{Atomic Flows and Derivations}

% TODO: The proof that every derivation is sequentiable is from AFI

Atomic flows are somewhat similar to proof nets. However, we prove that, no matter how we freely build an atomic flow (as opposed to a proof net structure), the flow is associated with some derivation. So, atomic flows are always `sequentialisable', in proof-net parlance. In fact, atomic flows carry much less information than derivations do, because they do not keep track of the logical relations between the atoms they trace, only their structural information is retained (in the sense of structural rules, as opposed to logical ones).

We can think of atomic flows as composite diagrams that are freely generated from a set of six elementary diagrams. Technically, atomic flows are special kinds of labelled directed acyclic graphs, and the properties of their vertices are dictated by their labels, which we define as follows.

%---------------------------------------
\begin{defi}
We call the following six diagrams (\emph{atomic-flow}) \emph{labels}:
\[
\begin{array}{@{}c@{}c@{}c@{}}
      \vcenter{\afaid{}{}{}{}{}{}}&
\qquad\vcenter{\afawd{}{}{}{}}&
\qquad\vcenter{\afacd{}{}{}{}{}{}}\\
\noalign{\smallskip}
      \mbox{$\aid$ or \emph{interaction}}&
\qquad\mbox{$\awd$ or \emph{weakening}}&
\qquad\mbox{$\acd$ or \emph{contraction}}\\
\noalign{\bigskip}
      \vcenter{\afaiu{}{}{}{}{}{}}&
\qquad\vcenter{\afawu{}{}{}{}}&
\qquad\vcenter{\afacu{}{}{}{}{}{}}\\
\noalign{\smallskip}
      \mbox{$\aiu$ or \emph{cointeraction}}&
\qquad\mbox{$\awu$ or \emph{coweakening}}&
\qquad\mbox{$\acu$ or \emph{cocontraction}}\\
\end{array}\quad.
\]
Cointeraction is also called \emph{cut}.
\end{defi}

% TODO: sometimes we do not name the edges

\newcommand{\ppl  }{{\mathchoice{\scriptstyle+}
                                {\scriptstyle+}
                                {\scriptstyle+}
                                {\scriptscriptstyle+}}}
\newcommand{\pmi  }{{\mathchoice{\scriptstyle-}
                                {\scriptstyle-}
                                {\scriptstyle-}
                                {\scriptscriptstyle-}}}
\newcommand{\three}{{\mathchoice{\scriptstyle\mathbf3}
                                {\scriptstyle\mathbf3}
                                {\scriptstyle\mathbf3}
                                {\scriptscriptstyle\mathbf3}}}
\newcommand{\four }{{\mathchoice{\scriptstyle\mathbf4}
                                {\scriptstyle\mathbf4}
                                {\scriptstyle\mathbf4}
                                {\scriptscriptstyle\mathbf4}}}
\newcommand{\five }{{\mathchoice{\scriptstyle\mathbf5}
                                {\scriptstyle\mathbf5}
                                {\scriptstyle\mathbf5}
                                {\scriptscriptstyle\mathbf5}}}
\newcommand{\six  }{{\mathchoice{\scriptstyle\mathbf6}
                                {\scriptstyle\mathbf6}
                                {\scriptstyle\mathbf6}
                                {\scriptscriptstyle\mathbf6}}}
\newcommand{\seven}{{\mathchoice{\scriptstyle\mathbf7}
                                {\scriptstyle\mathbf7}
                                {\scriptstyle\mathbf7}
                                {\scriptscriptstyle\mathbf7}}}
\newcommand{\eight}{{\mathchoice{\scriptstyle\mathbf8}
                                {\scriptstyle\mathbf8}
                                {\scriptstyle\mathbf8}
                                {\scriptscriptstyle\mathbf8}}}
\newcommand{\nine }{{\mathchoice{\scriptstyle\mathbf9}
                                {\scriptstyle\mathbf9}
                                {\scriptstyle\mathbf9}
                                {\scriptscriptstyle\mathbf9}}}
\newcommand{\card}[1]{\mathord\vert #1\mathord\vert}
\newcommand{\up}{{\mathit up}}
\newcommand{\lo}{{\mathit lo}}
%---------------------------------------
\begin{defi}
An (\emph{atomic}) \emph{flow} is a tuple $(V,E,\eta,\up,\lo)$ such that:
\begin{enumerate}
%-------------------
\item $V$ is a finite set of \emph{vertices}, denoted by $\nu$;
%-------------------
\item $E$ is a finite set of \emph{edges}, denoted by $\epsilon$;
%-------------------
\item $\eta\colon V\to\{\aid,\aiu,\awd,\awu,\acd,\acu\}$ maps vertices to their \emph{labels};
%-------------------
\item $\up\colon E\to V\cup\{\top\}$ and $\lo\colon E\to V\cup\{\bot\}$ are, respectively, the \emph{upper} and \emph{lower} maps, and $\top$ and $\bot$ are special vertices not belonging to $V$; we define, for every $\nu\in V\cup\{\top,\bot\}$, the set $L_\nu=\{\,\epsilon\mid\up(\epsilon)=\nu\,\}$ of \emph{lower edges of $\nu$}, the set $U_\nu=\{\,\epsilon\mid\lo(\epsilon)=\nu\,\}$ of \emph{upper edges of $\nu$}, and the set $E_\nu=L_\nu\cup U_\nu$ of \emph{edges of $\nu$};
%-------------------
\item if $\card S$ denotes the cardinality of set $S$, we have that
\begin{align*}
\mbox{if $\eta(\nu)=\aid$ then $\card{L_\nu}=2$ and $\card{U_\nu}=0$,}&\\
\mbox{if $\eta(\nu)=\aiu$ then $\card{L_\nu}=0$ and $\card{U_\nu}=2$,}&\\
\mbox{if $\eta(\nu)=\awd$ then $\card{L_\nu}=1$ and $\card{U_\nu}=0$,}&\\
\mbox{if $\eta(\nu)=\awu$ then $\card{L_\nu}=0$ and $\card{U_\nu}=1$,}&\\
\mbox{if $\eta(\nu)=\acd$ then $\card{L_\nu}=1$ and $\card{U_\nu}=2$,}&\\
\mbox{if $\eta(\nu)=\acu$ then $\card{L_\nu}=2$ and $\card{U_\nu}=1$;}&
\end{align*}
%-------------------
\item\label{ItAcycl} there is no sequence $\epsilon_1,\dots,\epsilon_h$ of edges of $V$ such that $\up(\epsilon_i)=\lo(\epsilon_{i+1\pmod h})$, for $1\le i\le h$;
%-------------------
\item\label{ItPol} there is a \emph{polarity assignment} $\pi\colon E\to\{\pmi,\ppl\}$ such that, for every $\nu\in V$,
\begin{enumerate}
%---------
\item if $\eta(\nu)\in\{\acd,\acu\}$ then $\pi(E_\nu)=\{\pmi\}$ or $\pi(E_\nu)=\{\ppl\}$;
%---------
\item if $\eta(\nu)\in\{\aid,\aiu\}$ then $\pi(E_\nu)=\{\pmi,\ppl\}$.
\end{enumerate}
\end{enumerate}
Besides $\epsilon$, we use small numerals $\one$, $\two$, \dots\ to denote edges. Atomic flows are denoted with $A$, $B$. Given an atomic flow $A$, we say that the sets $L_\top=\{\epsilon_1,\dots,\epsilon_h\}$ and $U_\bot=\{\epsilon'_1,\dots,\epsilon'_k\}$ contain, respectively, the \emph{upper} and \emph{lower edges of $A$}; in such a case, we can represent $A$ as
\[
\atomicflow{
( 2,10)*{\afvjum4{\epsilon_1}{\epsilon_h}};
( 5, 6)*{\aflabelleft A};
( 2, 5)*{\affr66};
( 2, 0)*{\afvjdm4{\epsilon'_1}{\epsilon'_k}};
(-2, 0)*{\invisiblemark};
( 6, 0)*{\invisiblemark}}
\quad.
\]

In general, we represent atomic flows as directed-graph diagrams, except that the special vertices $\top$ and $\bot$ are not shown, and the labels of the vertices are explicitly shown as graphical elements. When we refer to the vertices of an atomic flow, we do not include $\top$ and $\bot$. Sometimes we identify vertices with their labels. 
\end{defi}

An atomic flow is a directed graph, whose edges are associated to atom occurrences in derivations, and the direction of the edges corresponds to the up-down direction in a derivation. Vertices are associated to points in the derivation where atom occurrences are created or destroyed, and the nature of each vertex is described by its label. Naturally, these graphs are acyclic (condition~\ref{ItAcycl}). The two special vertices $\top$ and $\bot$ represent the top and bottom of a derivation: we can consider $\top$ the vertex that creates all the atom occurrences in the premiss and $\bot$ the vertex that destroys all atom occurrences in the conclusion.

The polarity assignment condition (\ref{ItPol}) ensures that atoms in(co)contractions have the same polarity, and those in (co)interactions have dual polarities (as happens in derivations). Every atomic flow has $2^n$ polarity assignments, where $n$ is the number of connected components in the graph. We should not be worried about the apparent complexity of the polarity assignment condition: in fact, we could equivalently consider two sorts of (co)contraction and (co)weakening labels, the negative and the positive ones, and ask for vertices to be joined by respecting their polarities. This is clearly a locally checkable property, much simpler than, for example, some global correctness criterion for proof nets.

%---------------------------------------
\begin{exa}
Consider the atomic flow
\begin{align*}
A=(&\{\;\nu_1\;,\;\nu_2\;,\;\nu_3\;\},\\
   &\{\;\one\;,\;\two\;,\;\three\;,\;\four\;,\;\five\;\},\\
   &\{\;\nu_1\mapsto\aiu\;,\;\nu_2\mapsto\acu\;,\;\nu_3\mapsto\aiu\;\},\\
   &\{\;\one\mapsto\top\;,\;\two\mapsto\top\;,\;\three\mapsto\nu_2\;,\;
        \four\mapsto\nu_2\;,\;\five\mapsto\top\;\},\\
   &\{\;\one\mapsto\nu_1\;,\;\two\mapsto\nu_2\;,\;\three\mapsto\nu_1\;,\;
        \four\mapsto\nu_3\;,\;\five\mapsto\nu_3\;\})
\quad;
\end{align*}
the following are three of its possible representations:
\[
\atomicflow{
(10,8)*{\afacu\four{}{}{}{}\two};
( 0,8)*{\afvjd8\one{}};
( 4,8)*{\afvjd8{}\five};
( 6,2)*{\afaiunw{}{}};
( 6,0)*{\afaiuex{}{}{}\three{}{}31}}
\quad,\qquad
\aflower{\atomicflow{
( 0  ,6)*{\afvjd{8}\one\ppl};
( 6  ,6)*{\afacu\three{}{}\four\two\pmi};
(12  ,6)*{\afvjd{8}\ppl\five};
(10  ,0)*{\afaiunw{}{}};
( 2  ,0)*{\afaiunw{}{}};
(-1.5,0)*{\invisiblemark};
(13.5,0)*{\invisiblemark}}}
\qquad\hbox{and}\qquad
\atomicflow{
( 8  ,10)*{\afacu{}\three{}\four\two\ppl};
( 0  , 8)*{\afvjd{12}\one\pmi};
( 4  ,10)*{\afvjd{8}\five\pmi};
( 5  , 4)*{\afex24};
(10  , 4)*{\afvj4};
( 2  , 0)*{\afaiunw{}{}};
( 8  , 0)*{\afaiunw{}{}};
(-1.5, 0)*{\invisiblemark};
(11.5, 0)*{\invisiblemark}}
\quad;
\]
\afnegspace
in the last two diagrams, we also indicated each of the two possible polarity assignments. This flow has one cocontraction and two cointeraction vertices; it has three upper edges, $\one$, $\two$ and $\five$, and no lower edges.
\end{exa}

%---------------------------------------
\afnegspace
\begin{exa}
The graph
$\atomicflow{
(0,4)*{\afaidnw{}{}};
(0,0)*{\afacd{}{}{}{}{}{}}}$
is not an atomic flow, for lack of a polarity assignment.
\end{exa}

We now define the mapping from derivations to atomic flows. As we said, the idea is that structural rules map to the respective atomic-flow vertices, and the edges trace the atoms between inference steps. We first state a fact, whose proof is immediate.

%---------------------------------------
\begin{pro}\label{PropUnFl}
Given an\/ $\SKS$ derivation\/ $\Phi$, there is a unique atomic flow $A$ (modulo isomorphisms) such that:
\begin{enumerate}
%-------------------
\item there is a surjective map between the set of atom occurrences of\/ $\Phi$ and the set of edges of $A$;
%-------------------
\item for each inference step $\vlsmash{\vlinf{\rho}{}{\xi\{\beta\}}{\xi\{\alpha\}}}$ of\/ $\Phi$, where $\rho\in\{\aid,\aiu,\awd,\awu,\acd,\acu\}$ and $\vlinf{\rho}{}{\beta}{\alpha}$ is a rule instance, all atom occurrences in $\xi\vlhole$ in the premiss are respectively mapped to the same edges of $A$ as the atom occurrences in $\xi\vlhole$ in the conclusion; the atom occurrences in $\vlinf{\rho}{}{\beta}{\alpha}$ are mapped to edges of $A$ such that the edges are related with vertices as indicated below, for each possible case of the inference step:
\[
\begin{array}{@{}ccc@{}ccc@{}}
\vlinf{\aid}{}{\vls[a^\one.{\bar a^\two}]}{\ttt}&\mbox{to\/}&
\vcenter{\afaid\one{}{}\two{}{}}
\quad,&\qquad
\vlinf{\aiu}{}{\fff}{\vls(a^\one.{\bar a^\two})}&\mbox{to\/}&
\vcenter{\afaiu\one{}{}\two{}{}}
\quad,\\
\noalign{\medskip}
\vlinf{\awd}{}{a^\one}{\fff}                    &\mbox{to\/}&
\vcenter{\afawd{}{}{}\one{}} 
\quad,&\qquad
\vlinf{\awu}{}{\ttt}{a^\one}                    &\mbox{to\/}&
\vcenter{\afawu{}{}{}\one{}}
\quad,\\
\noalign{\medskip}
\vlinf{\acd}{}{a^\three}{\vls[a^\one.a^\two]}   &\mbox{to\/}&
\vcenter{\afacd\one{}{}\two{}\three}
\quad,&\qquad
\vlinf{\acu}{}{\vls(a^\two.a^\three)}{a^\one}   &\mbox{to\/}&
\vcenter{\afacu\two{}{}\three{}\one}
\quad,\\
\end{array}
\]
where the mapping is indicated by small numerals.
%-------------------
\item for each inference step of\/ $\Phi$ of kind
\[\hss
\begin{array}{@{}r@{}l@{}}
\vlinf{\swi}{}{\xi\vlscn[(\alpha.\beta).\gamma]}
              {\xi\vlscn(\alpha.[\beta.\gamma])}           \quad,&\qquad
\vlinf{\med}{}{\xi\vlscn([\alpha.\gamma].[\beta.\delta])}
              {\xi\vlscn[(\alpha.\beta).(\gamma.\delta)]}  \quad,      \\
\noalign{\smallskip}
\vlinf={}{\xi\vlscn[\beta.\alpha]}{\xi\vlscn[\alpha.\beta]}\quad,&\qquad
\vlinf={}{\xi\vlscn(\beta.\alpha)}{\xi\vlscn(\alpha.\beta)}\quad,      \\
\noalign{\smallskip}
\vlinf={}{\xi\vlscn[\alpha.[\beta.\gamma]]}
         {\xi\vlscn[[\alpha.\beta].\gamma]}                \quad,&\qquad
\vlinf={}{\xi\vlscn[[\alpha.\beta].\gamma]}
         {\xi\vlscn[\alpha.[\beta.\gamma]]}                \quad,      \\
\noalign{\smallskip}
\vlinf={}{\xi\vlscn(\alpha.(\beta.\gamma))}
         {\xi\vlscn((\alpha.\beta).\gamma)}                \quad,&\qquad
\vlinf={}{\xi\vlscn((\alpha.\beta).\gamma)}
         {\xi\vlscn(\alpha.(\beta.\gamma))}                \quad,      \\
\noalign{\smallskip}
\vlinf={}{\xi\{\alpha\}}{\xi\vlscn[\alpha.\fff]}           \quad,\qquad
\vlinf={}{\xi\vlscn[\alpha.\fff]}{\xi\{\alpha\}}           \quad,&\qquad
\vlinf={}{\xi\{\alpha\}}{\xi\vlscn(\alpha.\ttt)}        \qquad\hbox{and\/}\qquad
\vlinf={}{\xi\vlscn(\alpha.\ttt)}{\xi\{\alpha\}}
\end{array}
\]
all the atom occurrences in $\xi\vlhole$, $\alpha$, $\beta$, $\gamma$ and $\delta$ in the premiss are respectively mapped to the same edges of $A$ as the atom occurrences in $\xi\vlhole$, $\alpha$, $\beta$, $\gamma$ and $\delta$ in the conclusion.
\end{enumerate}
\end{pro}

%---------------------------------------
\begin{defi}
Given a derivation $\Phi$, we say that the unique atomic flow $A$ defined in Proposition~\ref{PropUnFl} is the atomic flow \emph{associated with} the derivation $\Phi$. Sometimes, when an atom occurrence $a$ in $\Phi$ maps to an edge $\epsilon$ in $A$, we decorate $\epsilon$ with the label $a$.
\end{defi}

%---------------------------------------
\begin{exa}
Figure~\ref{FigExAF} has some examples of atomic flows associated with derivations.
\end{exa}

\newcommand{\RD}[1]{#1}
\newcommand{\GR}[1]{#1}
\newcommand{\DO}[1]{#1}
\newcommand{\PB}[1]{#1}
\newcommand{\MG}[1]{#1}
\newcommand{\SG}[1]{#1}
\newcommand{\RS}[1]{#1}
\newcommand{\YO}[1]{#1}
\newcommand{\PW}[1]{#1}
%---------------------------------------
\begin{figure}[tbp]
\[
\begin{array}{@{}c@{}c@{}c@{}}
\vlderivation                                                  {
\vlin{=   }{}{\ttt                                  }         {
\vlin{\aiu}{}{\vls[\fff.\ttt]                       }        {
\vlin{=   }{}{\vls[(\GR{a}.\RD{\bar a}).\ttt]       }       {
\vlin{\swi}{}{\vls[[(\RD{\bar a}.\GR{a}).\ttt].\ttt]}      {
\vlin{=   }{}{\vls[(\RD{\bar a}.[\GR{a}.\ttt]).\ttt]}     {
\vlin{\swi}{}{\vls[([\GR{a}.\ttt].\RD{\bar a}).\ttt]}    {
\vlin{=   }{}{\vls([\GR{a}.\ttt].[\RD{\bar a}.\ttt])}   {
\vlin{\med}{}{\vls([\GR{a}.\ttt].[\ttt.\RD{\bar a}])}  {
\vlin{=   }{}{\vls[(\GR{a}.\ttt).(\ttt.\RD{\bar a})]} {
\vlin{\aid}{}{\vls[\GR{a}.\RD{\bar a}]              }{
\vlhy        {\ttt                                  }}}}}}}}}}}}
\qquad&
\vlderivation                                                              {
\vlin{\aiu}{}
   {\vls(\DO{a}.\fff)                                            }        {
\vlin{=   }{}
   {\vls(\DO{a}.(\PB{a}.\MG{\bar a}))                            }       {
\vlin{\acu}{}
   {\vls((\DO{a}.\PB{a}).\MG{\bar a})                            }      {
\vlin{=   }{}
   {\vls(\SG{a}.\MG{\bar a})                                     }     {
\vlin{\aiu}{}
   {\vls([\fff.\SG{a}].\MG{\bar a})                              }    {
\vlin{\acd}{}
   {\vls([(\RD{a}.\RS{\bar a}).\SG{a}].\MG{\bar a})              }   {
\vlin{\swi}{}
   {\vls([(\RD{a}.[\GR{\bar a}.\YO{\bar a}]).\SG{a}].\MG{\bar a})}  {
\vlin{=   }{}
   {\vls((\RD{a}.[[\GR{\bar a}.\YO{\bar a}].\SG{a}]).\MG{\bar a})} {
\vlin{\aid}{}
   {\vls(\RD{a}.[\GR{\bar a}.[\YO{\bar a}.\SG{a}]].\MG{\bar a})  }{
\vlhy        
   {\vls(\RD{a}.[\GR{\bar a}.\ttt].\MG{\bar a})                  }}}}}}}}}}}
\qquad&
\vlderivation                                                              {
\vlin{=   }{}{\vls(([\RS{a}.\YO{b}].\PW{c}).([\GR{a}.\DO{b}].\SG{c}))}    {
\vlin{\med}{}{\vls(([\RS{a}.\YO{b}].[\GR{a}.\DO{b}]).(\PW{c}.\SG{c}))}   {
\vlin{\acu}{}{\vls([(\RS{a}.\GR{a}).(\YO{b}.\DO{b})].(\PW{c}.\SG{c}))}  {
\vlin{\acu}{}{\vls([(\RS{a}.\GR{a}).(\YO{b}.\DO{b})].\MG{c})         } {
\vlin{\acu}{}{\vls([(\RS{a}.\GR{a}).\PB{b}].\MG{c})                  }{
\vlhy        {\vls([\RD{a}.\PB{b}].\MG{c})                           }}}}}}}\\
\atomicflow{
(0,0)*{\afaiucol{}{}{}{}{}{}{Green}{Red}{}};
(0,4)*{\afaidnw{}{}}}
\qquad&
\atomicflow{
( 2,14)*{\afvjcol4{Green}};
( 0,10)*{\afvjcol{12}{Red}};
(16,10)*{\afvjcol{12}{Magenta}};
( 4, 8)*{\afacdcol{}{}{}{}{}{}{Green}{YellowOrange}{RawSienna}};
(10, 8)*{\afacucol{}{}{}{}{}{}{DarkOrchid}{ProcessBlue}{SpringGreen}};
( 2, 2)*{\afaiunw{}{}};
( 8, 2)*{\afvjcol4{DarkOrchid}};
(14, 2)*{\afaiunw{}{}};
( 8,12)*{\afaidnw{}{}}}
\qquad&
\atomicflow{
( 0,0)*{\afacucol{}{}{}{}{}{}{RawSienna}{Green}{Red}};
(10,0)*{\afacucol{}{}{}{}{}{}{YellowOrange}{DarkOrchid}{ProcessBlue}};
(20,0)*{\afacucol{}{}{}{}{}{}{Periwinkle}{SpringGreen}{Magenta}}}
\end{array}
\]
\caption{Examples of atomic flows associated with derivations.}
\label{FigExAF}
\end{figure}

Inference rules are usually called linear when they do not `create' nor `destroy' atoms. Linear rules of $\SKS$ are switch, medial and (every equation defining) rule $=$. Note that linear inference rules do not introduce any vertices in atomic flows.

We now define the notion of paths in atomic flows. Paths are sequences of adjacent edges that only `go down' or only `go up'.
%---------------------------------------
% TODO: define maximal paths
% TODO: put this where it belongs:
% Given a path $\epsilon_1,\dots,\epsilon_n$ such that $n=1$ or $up(\epsilon_1)=lo(\epsilon_2)$, we say that \emph{$\epsilon_1$ is the bottom edge} and \emph{$\epsilon_n$ is the top edge} of $\epsilon_1,\dots,\epsilon_n$.
\begin{defi}
Given an atomic flow $(V,E,\eta,\up,\lo)$ and $\epsilon_1,\dots,\epsilon_h\in E$ such that, for $1\le i<h$, we have $\lo(\epsilon_i)=\up(\epsilon_{i+1})$, $\up(\epsilon_1)=\nu$ and $\lo(\epsilon_h)=\nu'$, we say that $\epsilon_1,\dots,\epsilon_h$ is a \emph{path from $\nu$ to $\nu'$} and that $\epsilon_h,\dots,\epsilon_1$ is a \emph{path from $\nu'$ to $\nu$}.
\end{defi}
%===============================================================================
\section{Preliminaries}

\begin{lem}\label{LemSuperSwitch}
Given a context $\xi\vlhole$ and a formula $\alpha$ there exist derivations $\vlder{}{\{\swi\}}{\xi\{\alpha\}}{\vls(\alpha.\xi\{\ttt\})}$ and $\vlder{}{\{\swi\}}{\vls[\xi\{\fff\}.\alpha]}{\xi\{\alpha\}}$.
\end{lem}

\begin{proof}
We show how to construct the first derivation, the second one can be done by symmetry. We argue by induction on the number of atoms in $\xi\vlhole$. The base case, $\xi\vlhole=\vlhole$, is trivial and the inductive cases are:

\[
\vlderivation
{
 \vlin{=}{}{\xi\{\alpha\}}
 {
  \vlin{\swi}{}{\vls[\vlder{\Psi}{\{\swi\}}{\xi'\{\alpha\}}{\vls(\alpha.\xi'\{\ttt\})}.\beta]}
  {
   \vlin{=}{}{\vls(\alpha.[\xi'\{\ttt\}.\beta])}
   {
    \vlhy{\vls(\alpha.\xi\{\ttt\})}
   }
  }
 }
}\qquad\mbox{and}\qquad
\vlderivation
{
 \vlin{=}{}{\xi\{\alpha\}}
 {
  \vlin{=}{}{\vls(\vlder{\Psi'}{\{\swi\}}{\xi'\{\alpha\}}{\vls(\alpha.\xi'\{\ttt\})}.\beta)}
  {
   \vlhy{\vls(\alpha.\xi\{\ttt\})}
  }
 }
}\quad,
\]
for some $\xi'\vlhole, \beta$ where $\beta$ is not a unit and $\Psi$ and $\Psi'$ exist by the inductive hypothesis.
\end{proof}

\newcommand{\contr}{\mathsf{c}}
\newcommand{\cod}{{\contr{\downarrow}}}
\newcommand{\cou}{{\contr{\uparrow}}}

\begin{lem}\label{LemGenericContraction}
Given a formula $\alpha$ and a positive integer $n$, there exist derivations $\vlder{}{\{\acd,\med\}}{\alpha}{\bigvee_{i=1}^{n}\alpha}$ and $\vlder{}{\{\acu,\med\}}{\bigwedge_{i=1}^{n}\alpha}{\alpha}$.
\end{lem}

\begin{proof}
Routine.
\end{proof}

\begin{rem}
In the non-atomic version of system $\SKS$ the above derivations correspond to repeated applications of (co)contractions. For this reason we sometimes write the inference rules $\vlinf{\cod}{}{\alpha}{\vls[\alpha.\alpha]}$ and $\vlinf{\cou}{}{\vls(\alpha.\alpha)}{\alpha}$ instead of the derivations $\vlder{}{\{\acd,\med\}}{\alpha}{\vls[\alpha.\alpha]}$ and $\vlder{}{\{\acu,\med\}}{\vls(\alpha.\alpha)}{\alpha}$.
\end{rem}

\subsection{Cores}

% TODO: somehow express that a_1,\dots,a_n are all of them

\begin{defi}\label{DefCore}
Given a derivation $\Phi$ from $\alpha$ to $\beta$ and all the distinct and pairwise non-dual atoms $a_1,\dots,a_n$ each of which appears in both interaction and cointeraction instances in $\Phi$, a \emph{core of\/ $\Phi$} is defined as a derivation 
\[
\vlder{}{}{\vls[\beta.(a_n.\bar a_n).\cdots.(a_1.\bar a_1)]}{\vls([a_1.\bar a_1].\cdots.[a_n.\bar a_n].\alpha)}
\]
where the atoms $a_1,\dots,a_n$ do not occur in any interaction nor cointeraction instances.
\end{defi}

\begin{lem}\label{LemCoreExistence}
For any derivation $\Phi$ from $\alpha$ to $\beta$ a core of\/ $\Phi$ can be constructed.
\end{lem}

\begin{proof}
Let $a_1,\dots,a_n$ be the distinct and pairwise non-dual atoms each of which appears in both interaction and cointeraction instances in $\Phi$. For each $a$ in $a_1,\dots,a_n$ consider the instances of $\aid$ and $\aiu$ where $a$ occurs. Using Lemma~\ref{LemSuperSwitch} apply the following transformations to said rule instances:
\[
\vlderivation
{
 \vlde{\Psi'}{}{\beta}
 {
  \vlin{\aid}{}{\xi\vlsbr[a.{\bar a}]}
  {
   \vlde{\Psi}{}{\xi\{\ttt\}}
   {
    \vlhy{\alpha}
   }
  }
 }
}\quad\rightarrow\quad
\vlderivation
{
 \vlde{\Psi'}{}{\beta}
 {
  \vlde{}{\{\swi\}}{\xi\vlsbr[a.{\bar a}]}
  {
   \vlhy{\vlsbr([a.{\bar a}].\vlder{\Psi}{}{\xi\{\ttt\}}{\alpha})}
  }
 }
}\qquad\mbox{and}\qquad
\vlderivation
{
 \vlde{\Psi'}{}{\beta}
 {
  \vlin{\aid}{}{\xi\{\fff\}}
  {
   \vlde{\Psi}{}{\xi\vlsbr(a.{\bar a})}
   {
    \vlhy{\alpha}
   }
  }
 }
}\quad\rightarrow\quad
\vlderivation
{
 \vlde{}{\{\swi\}}{\vlsbr[\vlder{\Psi'}{}{\beta}{\xi\{\fff\}}.(a.{\bar a})]}
 {
  \vlde{\Psi}{}{\xi\vlsbr(a.{\bar a})}
  {
   \vlhy{\alpha}
  }
 }
}\quad,
\]
to obtain
\[
\vlder{\Phi'}{}{\vls[\beta.(a_n.\bar a_n).\cdots.(a_n.\bar a_n).\cdots.(a_1.\bar a_1).\cdots.(a_1.\bar a_1)]}{\vls([a_1.\bar a_1].\cdots.[a_1.\bar a_1].\cdots.[a_n.\bar a_n].\cdots.[a_n.\bar a_n].\alpha)}\quad.
\]

We now construct a core of $\Phi$ from $\Phi'$ by using Lemma~\ref{LemContr}:
\[
\vlderivation
{
 \vlde{}{\{\acd,\med\}}{\vls[\beta.(a_n.{\bar a_n}).\cdots.(a_1.{\bar a_1})]}
 {
  \vlde{\Phi'}{}{\vls[\beta.(a_n.\bar a_n).\cdots.(a_n.\bar a_n).\cdots.(a_1.\bar a_1).\cdots.(a_1.\bar a_1)]}
  {
   \vlde{}{\{\acu,\med\}}{\vls([a_1.\bar a_1].\cdots.[a_1.\bar a_1].\cdots.[a_n.\bar a_n].\cdots.[a_n.\bar a_n].\alpha)}
   {
    \vlhy{\vls([a_1.{\bar a_1}].\cdots.[a_n.{\bar a_n}].\alpha)}
   }
  }
 }
}\quad.
\]
\end{proof}

\newcommand{\Core}{\mathsf{Core}}

% TODO: define associativity of contractions

Note that the core obtained using the construction in the above proof is not unique, several choices are made. However, we would like to argue that the cores only differ for inessential details, and in fact from the point of view of atomic flows they are all the same.

\begin{pro}\label{PropUniqueCore}
Given a derivation $\Phi$ with atomic flow
\[
\atomicflow
{
(-21, 6)*{\afvjm{4}};
(-13, 8)*{\afaidm{}{}{}{}{}{}};
( -5, 6)*{\afvjm{4}};
(-18, 0)*{\affr{8}{8}};
(-16, 2)*{A_1};
( -8, 0)*{\affr{8}{8}};
( -6, 2)*{B_1};
( -5,-6)*{\afvjm{4}};
(-13,-8)*{\afaium{}{}{}{}{}{}};
(-21,-6)*{\afvjm{4}};
%------------
(0,0)*{\cdots};
%------------
(21, 6)*{\afvjm{4}};
(13, 8)*{\afaidm{}{}{}{}{}{}};
( 5, 6)*{\afvjm{4}};
( 8, 0)*{\affr{8}{8}};
(10, 2)*{A_n};
(18, 0)*{\affr{8}{8}};
(20, 2)*{B_n};
( 5,-6)*{\afvjm{4}};
(13,-8)*{\afaium{}{}{}{}{}{}};
(21,-6)*{\afvjm{4}};}\quad,
\]
where $A_1,B_1,\dots,A_n,B_n$ do not contain interaction nor cointeraction nodes, the atomic flow of a core of $\Phi$ obtained as described in the proof of Lemma~\ref{LemCoreExistence} is
\[
\atomicflow
{
(-18,15)*{\afvj2};
(-18,10)*{\affr{8}{8}};
(-18, 5)*{\afvjm{2}};
(-18, 0)*{\affr{8}{8}};
(-16, 2)*{A_1};
(-18,-5)*{\afvjm{2}};
(-18,-10)*{\affr{8}{8}};
(-18,-15)*{\afvj2};
%
( -8,15)*{\afvj2};
( -8,10)*{\affr{8}{8}};
( -8, 5)*{\afvjm{2}};
( -8, 0)*{\affr{8}{8}};
( -6, 2)*{B_1};
( -8,-5)*{\afvjm{2}};
( -8,-10)*{\affr{8}{8}};
( -8,-15)*{\afvj2};
%------------
(0,0)*{\cdots};
%------------
( 8,15)*{\afvj2};
( 8,10)*{\affr{8}{8}};
( 8, 5)*{\afvjm{2}};
( 8, 0)*{\affr{8}{8}};
(10, 2)*{A_n};
( 8,-5)*{\afvjm{2}};
( 8,-10)*{\affr{8}{8}};
( 8,-15)*{\afvj2};
%
(18,15)*{\afvj2};
(18,10)*{\affr{8}{8}};
(18, 5)*{\afvjm{2}};
(18, 0)*{\affr{8}{8}};
(20, 2)*{B_n};
(18,-5)*{\afvjm{2}};
(18,-10)*{\affr{8}{8}};
(18,-15)*{\afvj2};
}\quad.
\]
\end{pro}

% TODO: we are talking about cores obtained as in Lemma...

In other words the atomic flow of two cores are equal modulo associativity of contractions, which justifies the following definition, where we refer to a core as if it is unique.

\begin{defi}\label{DefCanonicalCore}
A core of a derivation $\Phi$, constructed as described in the proof of Lemma~\ref{LemCoreExistence}, is called \emph{a canonical core of\/ $\Phi$}, written $\Core(\Phi)$.
\end{defi}

\subsection{Experiments}

\begin{defi}
Given
\begin{itemize}
 \item a proof $\Phi$ of $\beta$ and
 \item distinct and pairwise non-dual atoms $a_1,\dots,a_n$,
\end{itemize}
an \emph{experiment on $\Phi$ with respect to $a_1,\dots,a_n$} is a derivation from $\vls(a_1.\cdots.)$ to $\beta$ which does not contain any cointeraction instances.
\end{defi}

\begin{defi}
Given a derivation $\Phi$ containing the atom occurrence $a$, let $A$ be the atomic flow of $\Phi$ and let $\epsilon$ be the edge such that $a$ maps to $\epsilon$. The \emph{cone of $\epsilon$} is the set of edges in the paths starting with $\epsilon$ and the \emph{cone of $a$} is the set of atom occurrences mapping to edges in the cone of $\epsilon$.
\end{defi}

\begin{defi}
Given distinct and pairwise non-dual atoms, $b_1,\dots,b_n$, an \emph{assignment to $b_1,\dots,b_n$} is a $a_1,\dots,a_n$ such that $a_i\in\{b_i,\bar b_i\}$ for every $1\leq i \leq n$.
\end{defi}

The number of different assignments to a sequence of $n$ atoms is $2^n$.

%TODO: maximal paths

\begin{rem}\label{RemAllWeak}
Let $A$ be an atomic flow and let $\nu$ be a vertex in $A$, then a path from $\nu$ goes to either a weakening vertex, an interaction vertex or to the $\top$ vertex. We note for later use that in the special case where $\Phi$ is a proof and $A$ is the atomic flow of $\Core(\Phi)$ a path from $\nu$ must go to a weakening; it cannot go to an interaction vertex because if the atomic flow of $\Phi$ contained a path from a cointeraction to an interaction, $\nu$ would not be in $\Core(\Phi)$; for the same reason it cannot go to $\top$ because since $\Phi$ is a proof the only paths that go to the $\top$ are the ones that go to an interaction vertex in $\Phi$.
\end{rem}

% TODO: swap a_i with b_i?

\begin{lem}\label{LemConstrExp}
Given a proof, $\Phi$, of $\beta$, let $b_1,\dots,b_n$ be the distinct and pairwise non-dual atoms each of which occurs in both interaction and cointeraction instances and let $a_1,\dots,a_n$ be an assignment to $b_1,\dots,b_n$, then there exists an experiment on $\Phi$ with respect to $a_1,\dots,a_n$.
\end{lem}

\newcommand{\mk}[1]{{#1}^{\scriptscriptstyle\bullet}}

\begin{proof}
Consider $\vlder{\Core(\Phi)}{}{\vls[\beta.(a_1.\bar a_1).\cdots.(a_n.\bar a_n)]}{\vls([a_1.\bar a_1].\cdots.[a_n.\bar a_n])}$. We now mark the following atom occurrences with$\mk\ $:
\begin{itemize}
\item the cones of the occurrences of $\bar a_1,\dots,\bar a_n$ in the conclusion of $\Core(\Phi)$ which are not in $\beta$ and
\item the cones of both the atom occurrences appearing in cointeraction instances.
\end{itemize}
This gives us
\[
\vlderivation
{
 \vlde{}{}{\vls[\beta.(a_1.\mk{\bar a_1}).\cdots.(a_n.\mk{\bar a_n})]}
 {
  \vlde{}{}{\xi_1\left\{\vlinf{\aiu}{}{\fff}{\vls(\mk b_1.\mk{\bar b_1})}\right\}}
  {
   \vlde{}{}{\vdots}
   {
    \vlde{}{}{\xi_k\left\{\vlinf{\aiu}{}{\fff}{\vls(\mk b_m.\mk{\bar b_m})}\right\}}
    {
     \vlhy{\vls([a_1.\mk{\bar a_1}].\cdots.[a_n.\mk{\bar a_n}])}
    }
   }
  }
 }
}\quad,
\]
for some $b_1,\dots,b_m,\xi_1\vlhole,\xi_k\vlhole$.

Then perform the following substitutions to obtain $\Psi$:
\begin{itemize}
  \item substitute each marked atom occurrence, $\mk c$, with $\fff$ and
  \item substitute each structural inference rule instance in which $\mk c$ occurs as follows
\[
\begin{array}{c}
\vlinf{\awd}{}{\mk c}{\fff}
\quad\rightarrow\quad
\vlinf{=}{}{\fff}{\fff}\quad,
\\
\noalign{\bigskip}
\vlinf{\acd}{}{\mk c}{\vls[\mk c.\mk c]}
\quad\rightarrow\quad
\vlinf{=}{}{\fff}{\fff}\quad,
\\
\noalign{\bigskip}
\vlinf{\acu}{}{\vls(\mk c.c)}{\mk c}
\quad\rightarrow\quad
\vlinf{\awd}{}{\vls(\fff.c)}{\fff}\quad,
\\
\noalign{\bigskip}
\vlinf{\aiu}{}{\fff}{\vls(\mk c.\mk {\bar c})}
\quad\rightarrow\quad
\vlinf{=}{}{\fff}{\vls(\fff.\fff)}\quad.
\end{array}
\]
\end{itemize}
By Remark~\ref{RemAllWeak} we know that no cone will ever contain an atom occurrence appearing in an interaction instance, so the result of the substitution gives a valid derivation:
\[
\Psi=
\vlder{}{}{\vls[\beta.(a_1.\fff).\cdots.(a_n.\fff)]}
{\vls([a_1.\fff].\cdots.[a_n.\fff])}\quad.
\]

Finally, consider the experiment:
\[
\vlderivation
{
 \vlde{\Psi}{}{\vls[\beta.(\vlinf{\awu}{}{\ttt}{a_1}.\fff).\cdots.(\vlinf{\awu}{}{\ttt}{a_n}.\fff)]}
 {
  \vlhy{\vls(a_1.\cdots.a_n)}
 }
}\quad.
\]
\end{proof}

% TODO: work on the remarks
% TODO: add reference to AFI

\begin{rem}
Another approach to obtaining an experiment on $\Phi$ with respect to $a_1,\dots,a_n$ is to consider the derivation
\[
\Psi=\vlder{\Core(\Phi)}{}{\vls[\beta.\vlinf{\aiu}{}{\fff}{\vls(a_1.\bar a_1)}.\cdots.\vlinf{\aiu}{}{\fff}{\vls(a_n.\bar a_n)}]}{\vls([a_1.\vlinf{\awd}{}{\bar a_1}{\fff}].\cdots.[a_n.\vlinf{\awd}{}{\bar a_n}{\fff}])}\quad.
\]
Note that all maximal paths from a cointeraction vertex in the atomic flow of $\Psi$ go to a weakening vertex. Hence applying weakening reductions to $\Psi$ will eliminate all the cuts and yield the required experiment. 
\end{rem}

\begin{rem}
It might be surprising that we choose to use the substitution
\[
\vlinf{\aiu}{}{\fff}{\vls(c.\bar c)}
\quad\rightarrow\quad
\vlinf{=}{}{\fff}{\vls(\fff.\fff)}\quad,
\]
instead of the more natural
\[
\vlinf{\aiu}{}{\fff}{\vls(c.\bar c)}
\quad\rightarrow\quad
\vlinf{=}{}{\fff}{\vls(\fff.\ttt)}\quad.
\]
We chose to do it this way for efficiency, had we chosen to use the latter approach we would have to have twice as many substitution rules (dealing with $\ttt$ in addition to $\fff$).
The reason the former substitution works is that we are essentially in the following situation (possibly after some weakening reductions):
\[
\vlinf{\aiu}{}{\fff}{\vls(\vlinf{\awd}{}{c}{\fff}.\vlinf{\awd}{}{\bar c}{\fff})}\quad.
\]
\end{rem}


\newcommand{\Exp}{\mathsf{Exp}}

\begin{defi}
An experiment on a derivation $\Phi$ with respect to $a_1,\dots,a_n$, constructed as described in the proof of Lemma~\ref{LemConstrExp}, is called \emph{a canonical experiment on $\Phi$ with respect to $a_1,\dots,a_n$}, written $\Exp(\Phi,a_1,\dots,a_n)$.
\end{defi}

\begin{pro}
Given two canonical experiments on the same derivation with respect to the same atoms the atomic flows of the two experiments are equal modulo associativity of contractions.
\end{pro}

\section{Cut-elimination}

% TODO: big remark or section on philosophy
% TODO: remark on symmetry/confluence

\newcommand{\Assignments}{\mathcal A}
\newcommand{\Sym}{\mathsf{Sym}}

% TODO: is it bad to give a name to something before arguing that it is unique?
% TODO: swap a_i with b_i?

\begin{defi}
Given a sequence of distinct and pairwaise non-dual atoms, $b_1,\dots,b_n$, let $\Assignments_n$ be all possible assignments to $b_1,\dots,b_n$, then a \emph{symmetric proof of }$\bigvee_{\{a_1,\dots,a_n\}\in\Assignments}\vlsbr(a_1.\cdots.a_n)$, denoted $\Sym(b_1,\dots,b_n)$, is defined by induction on $n$:

The base case, $n=0$, is trivial and the inductive case is:
\[
\Sym(a_1,\dots,a_n)\quad=\quad
\vlderivation
{
 \vlin{=}{}{\bigvee_{\{a_1,\dots,a_n\}\in \Assignments_n}\vlsbr(a_1.\cdots.a_n)}
 {
  \vlde{}{\{\swi\}}{\bigvee_{\{a_1,\dots,a_{n-1}\}\in \Assignments_{n-1}}\vlsbr[(a_1.\cdots.a_{n-1}.a_n).(a_1.\cdots.a_{n-1}.\bar a_n)]}
  {
   \vlde{}{\{\swi\}}{\bigvee_{\{a_1,\dots,a_{n-1}\}\in \Assignments_{n-1}}\vlsbr([a_n.\bar a_n].a_1.\cdots.a_{n-1}.a_1.\cdots.a_{n-1})}
   {
    \vlde{}{\{\med,\acu\}}{\vls(\bigwedge_{i=1}^{2^{n-1}}[a_n.\bar a_n].\bigvee_{\{a_1,\dots,a_{n-1}\}\in \Assignments_{n-1}}(a_1.\cdots.a_{n-1}.a_1.\cdots.a_{n-1}))}
    {
     \vlin{\aid}{}{\vls([a_n.\bar a_n].\bigvee_{\{a_1,\dots,a_{n-1}\}\in \Assignments_{n-1}}(a_1.\cdots.a_{n-1}))}
     {
      \vlpr{\Sym(a_1,\dots,a_{n-1})}{\{\aid,\acu,\swi,\med\}}{\bigvee_{\{a_1,\dots,a_{n-1}\}\in \Assignments_{n-1}}\vlsbr(a_1.\cdots.a_{n-1})}
     }
    }
   }
  }
 }
}\quad.
\]
\end{defi}

\begin{pro}
Given two symmetric proofs of\/ $\bigvee_{\{a_1,\dots,a_n\}\in\Assignments}\vlsbr(a_1.\cdots.a_n)$ the atomic flows of the two proofs are equal modulo associativity of contractions.
\end{pro}


\begin{defi}
Given a proof,\/ $\Phi$, of $\beta$ in $\SKS$, let $b_1,\dots,b_n$ be all the distinct and pairwise non-dual atoms which occur in both interaction and cointeraction instances in $\Phi$ and let $\Assignments$ be all the possible assignments to $b_1,\dots,b_n$, then \emph{a symmetric cut-free proof obtained from $\Phi$} is:
\[
\vlderivation
{
 \vlin{(2^n-1)\times\cod}{}{\beta}
 {
  \vlpr{\Sym(b_1,\dots,b_n)}{\{\aid,\acu,\swi,\med\}}{\bigvee_{\{a_1,\dots,a_n\}\in\Assignments}\left(\vlder{\Exp(\Phi,a_1,\dots,a_n)}{\SKS\setminus\{\aiu\}}{\beta}{\vls(a_1.\cdots.a_n)}\right)}
 }
}
\]
\end{defi}

\begin{pro}
Given a proof $\Phi$ and two symmetric cut-free proofs obtained from $\Phi$ the atomic flows of the two canonical cut-free proofs are equal modulo associativity of contraction.
\end{pro}

% TODO: Check literature about rewriting modulo

% TODO: maybe put this somewhere else
%
% \begin{cor}
% Given a proof of $\alpha$ in $\SKS$ there exists a canonical proof of $\alpha$ in $\KS$.
% \end{cor}


%===============================================================================
\section{Normaliser}

\newcommand{\Norm}{\mathsf{Norm}}

\begin{defi}
The \emph{normaliser}, $\Norm(\Phi,a_1,\dots,a_n)$, is an operator taking as input a sequence of atoms and a derivation of the form
\[
\vlder{\Phi}{}{\vls[\beta.(a_n.{\bar a_n}).\cdots.(a_1.{\bar a_1})]}{\vls([a_1.{\bar a_1}].\cdots.[a_n.{\bar a_n}].\alpha)}\quad,
\]
where $\alpha$ and $\beta$ are formulae and returning a derivation of the form
\[
\vlder{\Norm(\Phi,a_1,\dots,a_n)}{}{\beta}{\alpha}\quad.
\]

We define $\Norm$ inductively on the number of arguments. Let $\Norm(\Phi)=\Phi$ and for $n>0$ let $\Norm(\Phi,a_1,\dots,a_n)$ be
\newbox\DeltaTopK
\setbox\DeltaTopK=
\hbox{$
\vlderivation
{
 \vlde{\Norm(\Phi,a_1,\dots,a_{n-1})}{}{\vls[\beta.(\vlinf{\awu}{}{\ttt}{a_n}.\bar a_n)]}
 {
  \vlhy{\vls(\vlinf{\aid}{}{\vls[a_n.\bar a_n]}{\ttt}.\alpha)}
 }
}$
}
\newbox\DeltaBotK
\setbox\DeltaBotK=
\hbox{
$\vlderivation
{
 \vlde{\Norm(\Phi,a_1,\dots,a_{n-1})}{}{\vls[\beta.\vlinf{\aiu}{}{\fff}{\vls(a_n.\bar a_n)}]}
 {
  \vlhy{\vls([a_n.\vlinf{\awd}{}{\bar a_n}{\fff}].\alpha)}
 }
}$
}
\newbox\DeltaK
\setbox\DeltaK=
\hbox{$
\vlderivation
{
 \vlde{\Norm(\Phi,a_1,\dots,a_{n-1})}{}{\vls[\beta.(a_n.\vlinf{\awu}{}{\ttt}{\bar a_n})]}
 {
  \vlhy{\vls([\vlinf{\awd}{}{a_n}{\fff}.\bar a_n].\alpha)}
 }
}$
}
\[
\vlderivation
{
 \vlin{\cod}{}{\beta}
 {
  \vlin{\swi}{}{\vls[\vlinf{\cod}{}{\beta}{\vls[\beta.\beta]}.\box\DeltaBotK]}
  {
   \vlin{\swi}{}{\vls([\beta.\box\DeltaK].\alpha)}
   {
    \vlin{\cou}{}{\vls(\box\DeltaTopK.\vlinf{\cou}{}{\vls(\alpha.\alpha)}{\alpha})}
    {
     \vlhy{\alpha}
    }
   }
  }
 }
}\quad.
\]
\end{defi}

% TODO: define weakly streamlined

\begin{thm}
Given a derivation $\Phi$ from $\alpha$ to $\beta$, where $a_1,\dots,a_n$ are all the atoms that appear in both interaction and cointeraction instances then $\Norm(\Core(\Phi),a_1,\dots,a_n)$ is weakly streamlined.
\end{thm}

\begin{proof}
We argue by induction on $n$. The base case follows by the definition of $\Core$.

Consider the atomic flow of $\Norm(\Core(\Phi),a_1,\dots,a_{n-1})$ where the edges mapped to by $a_n$, $\bar a_n$ instances in the premiss and conclusion, but not in $\alpha$ or $\beta$ are singled out. Since this atomic flow is weakly streamlined we can represent it as follows:

\[
\atomicflow
{
(-8, 6)*{\afvjm{4}};
(-2, 6)*{\afvj{4}};
( 2, 6)*{\afvj{4}};
( 8, 6)*{\afvjm{4}};
(-5, 0)*{\affr{8}{8}};
(-3, 2)*{A};
( 5, 0)*{\affr{8}{8}};
( 7, 2)*{B};
( 8,-6)*{\afvjm{4}};
( 2,-6)*{\afvj{4}};
(-2,-6)*{\afvj{4}};
(-8,-6)*{\afvjm{4}};
}\quad.
\]

Now consider the atomic flow of $\Norm(\Core(\Phi),a_1,\dots,a_n)$,
\[
\atomicflow
{
% cocontractions
%  outer
(-13.5,36.5)*{\afacumexsqcol{}{}{}{}{}{}{33}{4}{}{Green}{Green}};
(  2.5,36.5)*{\afacumexsqcol{}{}{}{}{}{}{33}{4}{}{Green}{Green}};
%  inner
( -8, 13)*{\afvjmcol{18}{Green}};
( 14,  0)*{\afvjmcol{44}{Green}};
(  3, 26)*{\afacumnwexsqcol{}{}{}{}{11}{2}{Green}{Green}};
(  8, 13)*{\afvjm{18}};
( 30, 0)*{\afvjmcol{44}{Green}};
( 19, 26)*{\afacumnwexsqcol{}{}{}{}{11}{2}{}{Green}};
% top boxes
(-22, 34)*{\afaidcol{}{}{}{}{}{}{Red}{Red}};
(-27, 26)*{\affr{8}{8}};
(-25, 28)*{A_1};
(-17, 26)*{\affr{8}{8}};
(-15, 28)*{B_1};
(-24, 18)*{\afawucol{}{}{}{}{}{Red}};
( -9, 13)*{\afcjlcol{22}{18}{Red}};
% middle boxes
( -2,  8)*{\afawdcol{}{}{}{}{}{Green}};
(-5, 0)*{\affr{8}{8}};
(-3, 2)*{A_2};
( 5, 0)*{\affr{8}{8}};
( 7, 2)*{B_2};
(  2, -8)*{\afawucol{}{}{}{}{}{Red}};
% bottom boxes
( 22,-34)*{\afaiucol{}{}{}{}{}{}{Green}{Green}};
( 17,-26)*{\affr{8}{8}};
( 19,-24)*{A_3};
( 27,-26)*{\affr{8}{8}};
( 29,-24)*{B_3};
( 24,-18)*{\afawdcol{}{}{}{}{}{Green}};
(  9,-13)*{\afcjlcol{22}{18}{Green}};
% contractions
%  inner
( -8,-12.75)*{\afvjm{17.5}};
(-30,0.25)*{\afvjmcol{43.5}{Red}};
(-19,-27.5)*{\afacdmnwexsqcol{}{}{}{}{11}{2}{Red}{}};
(  8,-12.75)*{\afvjmcol{17.5}{Red}};
(-14,0.25)*{\afvjmcol{43.5}{Red}};
( -3,-27.5)*{\afacdmnwexsqcol{}{}{}{}{11}{2}{Red}{Red}};
%  outer
( 13.5,-36)*{\afacdmexsqcol{}{}{}{}{}{}{33}{4}{Red}{}{Red}};
( -2.5,-36)*{\afacdmexsqcol{}{}{}{}{}{}{33}{4}{Red}{}{Red}};
}\quad,
\]
where $A_1,A_2,A_3$ are isomorphic to $A$ and $B_1,B_2,B_3$ are isomorphic to $B$.

% TODO: passive form...

With the assistance of the atomic flow observe the following:
\begin{itemize}
\item The only paths between $A_1,A_2,A_3,A_4,B_1,B_2,B_3,B_4$ are paths mapped to from $a_n$ or $\bar a_n$, so since $\Norm(\Core(\Phi),a_1,\dots,a_{n-1})$ is weakly streamlined, there is no path from an interaction vertex to a cointeraction vertex which is mapped to by $a_1,\dots,a_{n-1}$.
\item None of the edges that could possibly be in a path from the interaction vertex (red) coincide with any of the edges that could possibly be in a path from the cointeraction vertex (green).
\end{itemize}

Since there are no paths from interaction vertices to cointeraction vertices, $\Norm(\Core(\Phi),a_1,\dots,a_n)$ is weakly streamlined.
\end{proof}



% \iflmcs\else\let\oldurl\url\renewcommand{\url}[1]{\hfill\break\oldurl{#1}}\fi
%
% \bibliographystyle{alpha}
% \bibliography{di-biblio}

\end{document}