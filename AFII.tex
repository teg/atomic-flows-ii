\documentclass[a4paper]{amsart}

%                  Trash .aux file after toggling
\usepackage{stmaryrd}
\usepackage{graphicx}
\usepackage[margin=1in]{geometry}
\usepackage[lutzsyntax]{virginialake}\aftrianglefalse
\usepackage[pdfborder={0 0 0}]{hyperref}
\usepackage[urw-garamond]{mathdesign}

%--------- Theorem etc
\newtheorem{thm}{Theorem}[section]
\newtheorem{cor}[thm]{Corollary}
\newtheorem{lem}[thm]{Lemma}
\newtheorem{pro}[thm]{Proposition}

\theoremstyle{remark}
\newtheorem{rem}[thm]{Remark}
\newtheorem{exa}[thm]{Example}

\theoremstyle{definition}
\newtheorem{defi}[thm]{Definition}
%---------

\begin{document}

\title[Normalisation Control in Deep Inference   via Atomic Flows II]
      {Normalisation Control in Deep Inference\\ via Atomic Flows II}

\author{Alessio Guglielmi and Tom Gundersen}
%\address{University of Bath, Bath BA2 7AY, UK}

\thanks{This work was in part funded by an Overseas Research Scholarship and a Research Studentship, both from the University of Bath, and by the British Council Alliance Programme.}

\keywords{Normalisation, deep inference, cut elimination, atomic flows}

\subjclass{F.4.1 Mathematical Logic---Proof theory}

% \begin{abstract}
% \end{abstract}

\maketitle

%===============================================================================
\section{Background on Deep Inference}

Deep inference is a relatively recent development in proof theory. It is a methodology according to which several formalisms can be defined with excellent structural properties. The calculus of structures \cite{Gugl:06:A-System:kl} is one of them and is now well developed for classical \cite{Brun:03:Atomic-C:oz,Brun:06:Cut-Elim:cq,Brun:06:Locality:zh,BrunTiu:01:A-Local-:mz,Brun:06:Deep-Inf:qy}, intuitionistic \cite{Tiu:06:A-Local-:gf}, linear \cite{Stra:02:A-Local-:ul,Stra:03:MELL-in-:oy}, modal \cite{Brun::Deep-Seq:ay,GoreTiu:06:Classica:uq,Stou:06:A-Deep-I:rt} and commutative/non-commutative logics \cite{Gugl:06:A-System:kl,Tiu:06:A-System:ai,Stra:03:Linear-L:lp,Brus:02:A-Purely:wd,Di-G:04:Structur:wy,GuglStra:01:Non-comm:rp,GuglStra:02:A-Non-co:lq,GuglStra:02:A-Non-co:dq,Kahr:06:Reducing:hc,Kahr:07:System-B:fk}. The basic proof complexity properties of the calculus of structures are known \cite{BrusGugl:07:On-the-P:fk}. The calculus of structures promoted the discovery of a new class of proof nets for classical and linear logic \cite{LamaStra:05:Construc:qq,LamaStra:05:Naming-P:ov,LamaStra:06:From-Pro:et,StraLama:04:On-Proof:ec} (see also \cite{Guir:06:The-Thre:qt}). There exist implementations in Maude of deep-inference proof systems \cite{Kahr:07:Maude-as:lr}. For a better introduction than this, we refer the reader to \cite{Brun:03:Atomic-C:oz}.

% TODO: define substitutions

\newcommand{\fff}{\mathsf f}
\newcommand{\ttt}{\mathsf t}
\newcommand{\ot}{\mathbin\shortleftarrow}

% TODO: check that we only every use the variable names in the following definition

%---------------------------------------
\begin{defi}
\emph{Formulae}, $\alpha$, $\beta$, $\gamma$, $\delta$ are freely built from: \emph{units}, $\fff$ (false), $\ttt$ (true); \emph{atoms}, $a$, $b$, $c$, $d$; \emph{disjunction} and \emph{conjunction}, ${\vlsbr[\alpha.\beta]}$ and $\vlsbr(\alpha.\beta)$. On the set of atoms a (non-identical) involution $\bar\cdot$ is defined, and dual atom occurrences, as $a$ and $\bar a$, can appear in formulae. We denote \emph{contexts}, \emph{i.e.}, formulae with a hole, by $\xi\vlhole$ and $\zeta\vlhole$; we also use \emph{multiple} contexts, $\xi\vlhole\cdots\vlhole$, \emph{i.e.}, formulae with many holes; for example, if $\xi\{a\}$ is $\vls(b.[a.c])$, then $\xi\vlhole$ is $\vls(b.[\vlhole.c])$, $\xi\{b\}$ is $\vls(b.[b.c])$ and $\xi\vlscn(a.d)$ is $\vls(b.[(a.d).c])$; if $\xi\{a\}\{b\}\{c\}$ is $\vls(b.[(a.d).c])$ then $\xi\{b\}\{c\}\{a\}$ is $\vls(c.[(b.d).a])$.
\end{defi}

%---------------------------------------
\begin{rem}
Negation is only defined for atoms, which is not a limitation thanks to De Morgan laws.
\end{rem}

Note that when we write $\xi\{a\}$, we mean that an occurrence of $a$ exists in the formula, we singled it out and we refer specifically to that occurrence. It is important to distinguish between an atom $a$ and a set of occurrences of atom $a$ inside a formula or a derivation. In the following, we mark in various ways occurrences of atoms, and we perform several substitutions of formulae in the place of atom occurrences.

\newcommand{\one}{{\mathchoice{\scriptstyle\mathbf1}
                              {\scriptstyle\mathbf1}
                              {\scriptstyle\mathbf1}
                              {\scriptscriptstyle\mathbf1}}}
\newcommand{\two}{{\mathchoice{\scriptstyle\mathbf2}
                              {\scriptstyle\mathbf2}
                              {\scriptstyle\mathbf2}
                              {\scriptscriptstyle\mathbf2}}}
%---------------------------------------
\begin{defi}
\emph{Inference rules}, $\rho$, have one \emph{premiss} and one \emph{conclusion}, and their \emph{instances} are used in \emph{inference steps} to rewrite inside formulae. A \emph{derivation}, $\Phi$, from $\alpha$ (\emph{premiss}) to $\beta$ (\emph{conclusion}) is a chain of inference steps with $\alpha$ at the top and $\beta$ at the bottom, and is usually indicated by $\vlder{\Phi}{\mathcal S}{\beta}{\alpha}$, where $\mathcal S$ is the name of the deductive system or a set of inference rules; a \emph{proof} is a derivation from $\ttt$; besides $\Phi$, we denote derivations with $\Psi$. We denote with $\xi\{\Phi\}$ the result of including every formula of the derivation $\vlder{\Phi}{}{\beta}{\alpha}$ into the context $\xi\vlhole$. Since we adopt deep inference, $\vlder{\xi\{\Phi\}}{}{\xi\{\beta\}}{\xi\{\alpha\}}$ is a valid derivation. Furthermore, $\xi\left\{\vlder{}{}{\beta_1}{\alpha_1}\right\}\cdots\left\{\vlder{}{}{\beta_n}{\alpha_n}\right\}$ denotes
\[
\vlderivation
{
 \vlin{=}{}{\xi\{\beta_1\}\cdots\{\beta_{n-1}\}\left\{\vlder{}{}{\beta_n}{\alpha_n}\right\}}
 {
  \vlin{=}{}{\vdots}
  {
   \vlin{=}{}{\xi\{\beta_1\}\cdots\{\beta_{i-1}\}\left\{\vlder{}{}{\beta_i}{\alpha_i}\right\}\{\alpha_{i+1}\}\cdots\{\alpha_n\}}
   {
    \vlin{=}{}{\vdots}
    {
     \vlhy{\xi\left\{\vlder{}{}{\beta_1}{\alpha_1}\right\}\{\alpha_2\}\cdots\{\alpha_n\}}
    }
   }
  }
 }
}\quad.
\]
\end{defi}

% TODO: Redo (see handwritten notes)
%\begin{rem}
%Although the caluclus of structures does not allow for independent parts of a derivation to happen in parallell, it is a natural and more efficient way of thinking of derivations and this motivated the above notation. In a new formalism being developed by us and others, Formalism A, derivations written in parallell is a representative of the equivalence class of all possible interleavings of the said derivations. In this paper we do not need the full power of Formalism A, so for the sake of efficiency we chose a parallell derivation to stand for one particular calculus of structures derivation rather than an equivelance class.
%\end{rem}

\newcommand{\KS}{\mathsf{KS}}
\newcommand{\SKS}{\mathsf{SKS}}
Now we define the two standard deductive systems for classical propositional logic in deep inference that are used throughout the paper. $\KS$ is analytic, in the sense that premisses only contain subformulae of conclusions, and $\SKS$ is not \cite{Brun:03:Atomic-C:oz,Brun:06:Cut-Elim:cq,Brun:06:Locality:zh,BrunTiu:01:A-Local-:mz}.

\newcommand{\ai}{\mathsf{ai}}
\newcommand{\aw}{\mathsf{aw}}
\newcommand{\ac}{\mathsf{ac}}
\newcommand{\aid}{{\ai{\downarrow}}}
\newcommand{\awd}{{\aw{\downarrow}}}
\newcommand{\acd}{{\ac{\downarrow}}}
\newcommand{\aiu}{{\ai{\uparrow}}}
\newcommand{\awu}{{\aw{\uparrow}}}
\newcommand{\acu}{{\ac{\uparrow}}}
\newcommand{\swi}{\mathsf{s}}
\newcommand{\med}{\mathsf{m}}
%---------------------------------------
\begin{defi}
System $\SKS$ in the calculus of structures is defined by the following \emph{structural} rules:
\[
\begin{array}{@{}c@{}c@{}c@{}}
      \vlinf{\aid}{}{\vls[a.{\bar a}]}{\ttt}&
\qquad\vlinf{\awd}{}a\fff&
\qquad\vlinf{\acd}{}a{\vls[a.a]}\\
\noalign{\smallskip}
      \emph{interaction}&
\qquad\emph{weakening}&
\qquad\emph{contraction}\\
\noalign{\bigskip}
      \vlinf{\aiu}{}\fff{\vls(a.{\bar a})}&
\qquad\vlinf{\awu}{}\ttt a&
\qquad\vlinf{\acu}{}{\vls (a.a)}a\\
\noalign{\smallskip}
      \emph{cointeraction}&
\qquad\emph{coweakening}&
\qquad\emph{cocontraction}\\
\end{array}\quad,
\]
and by the two \emph{logical} rules:
\[
\begin{array}{@{}c@{}c@{}}
\vlinf{\swi}{}{\vls[(\alpha.\beta).\gamma]}{\vls(\alpha.[\beta.\gamma])}&\qquad
\vlinf{\med}{}{\vls([\alpha.\gamma].[\beta.\delta])}
              {\vls[(\alpha.\beta).(\gamma.\delta)]}\\
\noalign{\smallskip}
\emph{switch}&\qquad\emph{medial}\\
\end{array}\quad.
\]
The rule cointeraction is also called an (\emph{atomic}) \emph{cut}. In addition to the rules shown, there is a rule $\vldownsmash{\vlinf={}\delta\gamma}$, such that $\gamma$ and $\delta$ are opposite sides in one of the following equations:
\vlstore{
\vls[\alpha.\beta]         &=\vls[\beta.\alpha]         \quad,&
\vls[\alpha.\fff]          &=\vls[\alpha]               \quad,\\
\vls(\alpha.\beta)         &=\vls(\beta.\alpha)         \quad,&
\vls(\alpha.\ttt)          &=\vls(\alpha)               \quad,\\
\vls[[\alpha.\beta].\gamma]&=\vls[\alpha.[\beta.\gamma]]\quad,&
\vls[\ttt.\ttt]            &=\vls[\ttt]                 \quad,\\
\vls((\alpha.\beta).\gamma)&=\vls(\alpha.(\beta.\gamma))\quad,&
\vls(\fff.\fff)            &=\vls(\fff)                 \quad\vldot}
\begin{align*}
\vlread
\end{align*}
We do not always show the instances of rule $=$, and when we do show them, we gather several contiguous instances into one. System $\KS$ is the same as $\SKS$, but without the rules $\aiu$, $\awu$ and $\acu$. A \emph{cut-free} derivation is a derivation where $\aiu$ is not used. All derivations in this paper are in $\SKS$, unless indicated otherwise.
\end{defi}

% TODO: Redo
%\begin{rem}
%It is important not to confuse the repersenetation of a derivation with the actual derivation. Although the representation of derivations we use in this paper might be slightly ambigous, the actual derivations they represent contain all the needed information to disambiguate them. In particular we often ommit or collapse many equations into one, but the actual derivation contains each equation instance, and in particular it contains information about which equation was used and exactly which subformula is mapped to which metavariable in the rule. Consider the following representation of an inference rule $\vlinf{=}{}{\vls(a.(a.a))}{\vls((a.a).a)}$, this does not contain enough information to determine which $a$ in the conclusion corresponds to which $a$ in the premiss. However, the actual inference rule will also tell us if the commutative or associative equaiton was used, so this is not a problem.
%\end{rem}

Note that all the structural rules only apply to atoms. As shown later, equivalent structural rules applying to formulae instead of atoms can be derived from the atomic ones together with the logical rules. The fact that we can work only with atomic structural rules is essential later on.

Instead of the term `axiom' we use `interaction'; the reason is that, in deep inference, axioms do not close derivation branches. However, it is not misleading to think of interaction instances as axiom instances in the sequent calculus. In several papers, including \cite{Brun:03:Atomic-C:oz}, the reader can find explanations of how reducing a proof in $\SKS$ to a proof in $\KS$ is a cut-elimination process in the traditional sense. In other words, the rules $\aiu$, $\awu$ and $\acu$ are, together, morally equivalent to a cut in the sequent calculus.

%===============================================================================

\subsection{Atomic Flows and Derivations}

% TODO: The proof that every derivation is sequentiable is from AFI

Atomic flows are somewhat similar to proof nets. However, no matter how we freely build an atomic flow (as opposed to a proof net structure), the flow is associated with some derivation. So, atomic flows are always `sequentialisable', in proof-net parlance. In fact, atomic flows carry much less information than derivations do, because they do not keep track of the logical relations between the atoms they trace, only their structural information is retained (in the sense of structural rules, as opposed to logical ones).

We can think of atomic flows as composite diagrams that are freely generated from a set of six elementary diagrams. Technically, atomic flows are special kinds of labelled directed acyclic graphs, and the properties of their vertices are dictated by their labels, which we define as follows.

%---------------------------------------
\begin{defi}
We call the following six diagrams (\emph{atomic-flow}) \emph{labels}:
\[
\begin{array}{@{}c@{}c@{}c@{}}
      \vcenter{\afaid{}{}{}{}{}{}}&
\qquad\vcenter{\afawd{}{}{}{}}&
\qquad\vcenter{\afacd{}{}{}{}{}{}}\\
\noalign{\smallskip}
      \mbox{$\aid$ or \emph{interaction}}&
\qquad\mbox{$\awd$ or \emph{weakening}}&
\qquad\mbox{$\acd$ or \emph{contraction}}\\
\noalign{\bigskip}
      \vcenter{\afaiu{}{}{}{}{}{}}&
\qquad\vcenter{\afawu{}{}{}{}}&
\qquad\vcenter{\afacu{}{}{}{}{}{}}\\
\noalign{\smallskip}
      \mbox{$\aiu$ or \emph{cointeraction}}&
\qquad\mbox{$\awu$ or \emph{coweakening}}&
\qquad\mbox{$\acu$ or \emph{cocontraction}}\\
\end{array}\quad.
\]
Cointeraction is also called \emph{cut}.
\end{defi}

% TODO: sometimes we do not name the edges

\newcommand{\ppl  }{{\mathchoice{\scriptstyle+}
                                {\scriptstyle+}
                                {\scriptstyle+}
                                {\scriptscriptstyle+}}}
\newcommand{\pmi  }{{\mathchoice{\scriptstyle-}
                                {\scriptstyle-}
                                {\scriptstyle-}
                                {\scriptscriptstyle-}}}
\newcommand{\three}{{\mathchoice{\scriptstyle\mathbf3}
                                {\scriptstyle\mathbf3}
                                {\scriptstyle\mathbf3}
                                {\scriptscriptstyle\mathbf3}}}
\newcommand{\four }{{\mathchoice{\scriptstyle\mathbf4}
                                {\scriptstyle\mathbf4}
                                {\scriptstyle\mathbf4}
                                {\scriptscriptstyle\mathbf4}}}
\newcommand{\five }{{\mathchoice{\scriptstyle\mathbf5}
                                {\scriptstyle\mathbf5}
                                {\scriptstyle\mathbf5}
                                {\scriptscriptstyle\mathbf5}}}
\newcommand{\six  }{{\mathchoice{\scriptstyle\mathbf6}
                                {\scriptstyle\mathbf6}
                                {\scriptstyle\mathbf6}
                                {\scriptscriptstyle\mathbf6}}}
\newcommand{\seven}{{\mathchoice{\scriptstyle\mathbf7}
                                {\scriptstyle\mathbf7}
                                {\scriptstyle\mathbf7}
                                {\scriptscriptstyle\mathbf7}}}
\newcommand{\eight}{{\mathchoice{\scriptstyle\mathbf8}
                                {\scriptstyle\mathbf8}
                                {\scriptstyle\mathbf8}
                                {\scriptscriptstyle\mathbf8}}}
\newcommand{\nine }{{\mathchoice{\scriptstyle\mathbf9}
                                {\scriptstyle\mathbf9}
                                {\scriptstyle\mathbf9}
                                {\scriptscriptstyle\mathbf9}}}
\newcommand{\card}[1]{\mathord\vert #1\mathord\vert}
\newcommand{\up}{{\mathit up}}
\newcommand{\lo}{{\mathit lo}}
%---------------------------------------
\begin{defi}
An (\emph{atomic}) \emph{flow} is a tuple $(V,E,\eta,\up,\lo)$ such that:
\begin{enumerate}
%-------------------
\item $V$ is a finite set of \emph{vertices}, denoted by $\nu$;
%-------------------
\item $E$ is a finite set of \emph{edges}, denoted by $\epsilon$;
%-------------------
\item $\eta\colon V\to\{\aid,\aiu,\awd,\awu,\acd,\acu\}$ maps vertices to their \emph{labels};
%-------------------
\item $\up\colon E\to V\cup\{\top\}$ and $\lo\colon E\to V\cup\{\bot\}$ are, respectively, the \emph{upper} and \emph{lower} maps, and $\top$ and $\bot$ are special vertices not belonging to $V$; we define, for every $\nu\in V\cup\{\top,\bot\}$, the set $L_\nu=\{\,\epsilon\mid\up(\epsilon)=\nu\,\}$ of \emph{lower edges of $\nu$}, the set $U_\nu=\{\,\epsilon\mid\lo(\epsilon)=\nu\,\}$ of \emph{upper edges of $\nu$}, and the set $E_\nu=L_\nu\cup U_\nu$ of \emph{edges of $\nu$};
%-------------------
\item if $\card S$ denotes the cardinality of set $S$, we have that
\begin{align*}
\mbox{if $\eta(\nu)=\aid$ then $\card{L_\nu}=2$ and $\card{U_\nu}=0$,}&\\
\mbox{if $\eta(\nu)=\aiu$ then $\card{L_\nu}=0$ and $\card{U_\nu}=2$,}&\\
\mbox{if $\eta(\nu)=\awd$ then $\card{L_\nu}=1$ and $\card{U_\nu}=0$,}&\\
\mbox{if $\eta(\nu)=\awu$ then $\card{L_\nu}=0$ and $\card{U_\nu}=1$,}&\\
\mbox{if $\eta(\nu)=\acd$ then $\card{L_\nu}=1$ and $\card{U_\nu}=2$,}&\\
\mbox{if $\eta(\nu)=\acu$ then $\card{L_\nu}=2$ and $\card{U_\nu}=1$;}&
\end{align*}
%-------------------
\item\label{ItAcycl} there is no sequence $\epsilon_1,\dots,\epsilon_h$ of edges of $V$ such that $\up(\epsilon_i)=\lo(\epsilon_{i+1\pmod h})$, for $1\le i\le h$;
%-------------------
\item\label{ItPol} there is a \emph{polarity assignment} $\pi\colon E\to\{\pmi,\ppl\}$ such that, for every $\nu\in V$,
\begin{enumerate}
%---------
\item if $\eta(\nu)\in\{\acd,\acu\}$ then $\pi(E_\nu)=\{\pmi\}$ or $\pi(E_\nu)=\{\ppl\}$;
%---------
\item if $\eta(\nu)\in\{\aid,\aiu\}$ then $\pi(E_\nu)=\{\pmi,\ppl\}$.
\end{enumerate}
\end{enumerate}
Besides $\epsilon$, we use small numerals $\one$, $\two$, \dots\ to denote edges. Atomic flows are denoted with $A$, $B$. Given an atomic flow $A$, we say that the sets $L_\top=\{\epsilon_1,\dots,\epsilon_h\}$ and $U_\bot=\{\epsilon'_1,\dots,\epsilon'_k\}$ contain, respectively, the \emph{upper} and \emph{lower edges of $A$}; in such a case, we can represent $A$ as
\[
\atomicflow{
( 2,10)*{\afvjum4{\epsilon_1}{\epsilon_h}};
( 5, 6)*{\aflabelleft A};
( 2, 5)*{\affr66};
( 2, 0)*{\afvjdm4{\epsilon'_1}{\epsilon'_k}};
(-2, 0)*{\invisiblemark};
( 6, 0)*{\invisiblemark}}
\quad.
\]

In general, we represent atomic flows as directed-graph diagrams, except that the special vertices $\top$ and $\bot$ are not shown, and the labels of the vertices are explicitly shown as graphical elements. When we refer to the vertices of an atomic flow, we do not include $\top$ and $\bot$. Sometimes we identify vertices with their labels. 
\end{defi}

An atomic flow is a directed graph, whose edges are associated to atom occurrences in derivations, and the direction of the edges corresponds to the up-down direction in a derivation. Vertices are associated to points in the derivation where atom occurrences are created or destroyed, and the nature of each vertex is described by its label. Naturally, these graphs are acyclic (condition~\ref{ItAcycl}). The two special vertices $\top$ and $\bot$ represent the top and bottom of a derivation: we can consider $\top$ the vertex that creates all the atom occurrences in the premiss and $\bot$ the vertex that destroys all atom occurrences in the conclusion.

The polarity assignment condition (\ref{ItPol}) ensures that atoms in(co)contractions have the same polarity, and those in (co)interactions have dual polarities (as happens in derivations). Every atomic flow has $2^n$ polarity assignments, where $n$ is the number of connected components in the graph. We should not be worried about the apparent complexity of the polarity assignment condition: in fact, we could equivalently consider two sorts of (co)contraction and (co)weakening labels, the negative and the positive ones, and ask for vertices to be joined by respecting their polarities. This is clearly a locally checkable property, much simpler than, for example, some global correctness criterion for proof nets.

%---------------------------------------
\begin{exa}
Consider the atomic flow
\begin{align*}
A=(&\{\;\nu_1\;,\;\nu_2\;,\;\nu_3\;\},\\
   &\{\;\one\;,\;\two\;,\;\three\;,\;\four\;,\;\five\;\},\\
   &\{\;\nu_1\mapsto\aiu\;,\;\nu_2\mapsto\acu\;,\;\nu_3\mapsto\aiu\;\},\\
   &\{\;\one\mapsto\top\;,\;\two\mapsto\top\;,\;\three\mapsto\nu_2\;,\;
        \four\mapsto\nu_2\;,\;\five\mapsto\top\;\},\\
   &\{\;\one\mapsto\nu_1\;,\;\two\mapsto\nu_2\;,\;\three\mapsto\nu_1\;,\;
        \four\mapsto\nu_3\;,\;\five\mapsto\nu_3\;\})
\quad;
\end{align*}
the following are three of its possible representations:
\[
\atomicflow{
(10,8)*{\afacu\four{}{}{}{}\two};
( 0,8)*{\afvjd8\one{}};
( 4,8)*{\afvjd8{}\five};
( 6,2)*{\afaiunw{}{}};
( 6,0)*{\afaiuex{}{}{}\three{}{}31}}
\quad,\qquad
\aflower{\atomicflow{
( 0  ,6)*{\afvjd{8}\one\ppl};
( 6  ,6)*{\afacu\three{}{}\four\two\pmi};
(12  ,6)*{\afvjd{8}\ppl\five};
(10  ,0)*{\afaiunw{}{}};
( 2  ,0)*{\afaiunw{}{}};
(-1.5,0)*{\invisiblemark};
(13.5,0)*{\invisiblemark}}}
\qquad\hbox{and}\qquad
\atomicflow{
( 8  ,10)*{\afacu{}\three{}\four\two\ppl};
( 0  , 8)*{\afvjd{12}\one\pmi};
( 4  ,10)*{\afvjd{8}\five\pmi};
( 5  , 4)*{\afex24};
(10  , 4)*{\afvj4};
( 2  , 0)*{\afaiunw{}{}};
( 8  , 0)*{\afaiunw{}{}};
(-1.5, 0)*{\invisiblemark};
(11.5, 0)*{\invisiblemark}}
\quad;
\]
\afnegspace
in the last two diagrams, we also indicated each of the two possible polarity assignments. This flow has one cocontraction and two cointeraction vertices; it has three upper edges, $\one$, $\two$ and $\five$, and no lower edges.
\end{exa}

%---------------------------------------
\afnegspace
\begin{exa}
The graph
$\atomicflow{
(0,4)*{\afaidnw{}{}};
(0,0)*{\afacd{}{}{}{}{}{}}}$
is not an atomic flow, for lack of a polarity assignment.
\end{exa}

We now define the mapping from derivations to atomic flows. As we said, the idea is that structural rules map to the respective atomic-flow vertices, and the edges trace the atoms between inference steps. We first state a fact, whose proof is immediate.

%---------------------------------------
\begin{pro}\label{PropUnFl}
Given an\/ $\SKS$ derivation\/ $\Phi$, there is a unique atomic flow $A$ (modulo isomorphisms) such that:
\begin{enumerate}
%-------------------
\item there is a surjective map between the set of atom occurrences of\/ $\Phi$ and the set of edges of $A$;
%-------------------
\item for each inference step $\vlsmash{\vlinf{\rho}{}{\xi\{\beta\}}{\xi\{\alpha\}}}$ of\/ $\Phi$, where $\rho\in\{\aid,\aiu,\awd,\awu,\acd,\acu\}$ and $\vlinf{\rho}{}{\beta}{\alpha}$ is a rule instance, all atom occurrences in $\xi\vlhole$ in the premiss are respectively mapped to the same edges of $A$ as the atom occurrences in $\xi\vlhole$ in the conclusion; the atom occurrences in $\vlinf{\rho}{}{\beta}{\alpha}$ are mapped to edges of $A$ such that the edges are related with vertices as indicated below, for each possible case of the inference step:
\[
\begin{array}{@{}ccc@{}ccc@{}}
\vlinf{\aid}{}{\vls[a^\one.{\bar a^\two}]}{\ttt}&\mbox{to\/}&
\vcenter{\afaid\one{}{}\two{}{}}
\quad,&\qquad
\vlinf{\aiu}{}{\fff}{\vls(a^\one.{\bar a^\two})}&\mbox{to\/}&
\vcenter{\afaiu\one{}{}\two{}{}}
\quad,\\
\noalign{\medskip}
\vlinf{\awd}{}{a^\one}{\fff}                    &\mbox{to\/}&
\vcenter{\afawd{}{}{}\one{}} 
\quad,&\qquad
\vlinf{\awu}{}{\ttt}{a^\one}                    &\mbox{to\/}&
\vcenter{\afawu{}{}{}\one{}}
\quad,\\
\noalign{\medskip}
\vlinf{\acd}{}{a^\three}{\vls[a^\one.a^\two]}   &\mbox{to\/}&
\vcenter{\afacd\one{}{}\two{}\three}
\quad,&\qquad
\vlinf{\acu}{}{\vls(a^\two.a^\three)}{a^\one}   &\mbox{to\/}&
\vcenter{\afacu\two{}{}\three{}\one}
\quad,\\
\end{array}
\]
where the mapping is indicated by small numerals.
%-------------------
\item for each inference step of\/ $\Phi$ of kind
\[\hss
\begin{array}{@{}r@{}l@{}}
\vlinf{\swi}{}{\xi\vlscn[(\alpha.\beta).\gamma]}
              {\xi\vlscn(\alpha.[\beta.\gamma])}           \quad,&\qquad
\vlinf{\med}{}{\xi\vlscn([\alpha.\gamma].[\beta.\delta])}
              {\xi\vlscn[(\alpha.\beta).(\gamma.\delta)]}  \quad,      \\
\noalign{\smallskip}
\vlinf={}{\xi\vlscn[\beta.\alpha]}{\xi\vlscn[\alpha.\beta]}\quad,&\qquad
\vlinf={}{\xi\vlscn(\beta.\alpha)}{\xi\vlscn(\alpha.\beta)}\quad,      \\
\noalign{\smallskip}
\vlinf={}{\xi\vlscn[\alpha.[\beta.\gamma]]}
         {\xi\vlscn[[\alpha.\beta].\gamma]}                \quad,&\qquad
\vlinf={}{\xi\vlscn[[\alpha.\beta].\gamma]}
         {\xi\vlscn[\alpha.[\beta.\gamma]]}                \quad,      \\
\noalign{\smallskip}
\vlinf={}{\xi\vlscn(\alpha.(\beta.\gamma))}
         {\xi\vlscn((\alpha.\beta).\gamma)}                \quad,&\qquad
\vlinf={}{\xi\vlscn((\alpha.\beta).\gamma)}
         {\xi\vlscn(\alpha.(\beta.\gamma))}                \quad,      \\
\noalign{\smallskip}
\vlinf={}{\xi\{\alpha\}}{\xi\vlscn[\alpha.\fff]}           \quad,\qquad
\vlinf={}{\xi\vlscn[\alpha.\fff]}{\xi\{\alpha\}}           \quad,&\qquad
\vlinf={}{\xi\{\alpha\}}{\xi\vlscn(\alpha.\ttt)}        \qquad\hbox{and\/}\qquad
\vlinf={}{\xi\vlscn(\alpha.\ttt)}{\xi\{\alpha\}}
\end{array}
\]
all the atom occurrences in $\xi\vlhole$, $\alpha$, $\beta$, $\gamma$ and $\delta$ in the premiss are respectively mapped to the same edges of $A$ as the atom occurrences in $\xi\vlhole$, $\alpha$, $\beta$, $\gamma$ and $\delta$ in the conclusion.
\end{enumerate}
\end{pro}

%---------------------------------------
\begin{defi}
Given a derivation $\Phi$, we say that the unique atomic flow $A$ defined in Proposition~\ref{PropUnFl} is the atomic flow \emph{associated with} the derivation $\Phi$. Sometimes, when an atom occurrence $a$ in $\Phi$ maps to an edge $\epsilon$ in $A$, we decorate $\epsilon$ with the label $a$.
\end{defi}

%---------------------------------------
\begin{exa}
Figure~\ref{FigExAF} has some examples of atomic flows associated with derivations.
\end{exa}

\newcommand{\RD}[1]{#1}
\newcommand{\GR}[1]{#1}
\newcommand{\DO}[1]{#1}
\newcommand{\PB}[1]{#1}
\newcommand{\MG}[1]{#1}
\newcommand{\SG}[1]{#1}
\newcommand{\RS}[1]{#1}
\newcommand{\YO}[1]{#1}
\newcommand{\PW}[1]{#1}
%---------------------------------------
\begin{figure}[tbp]
\[
\begin{array}{@{}c@{}c@{}c@{}}
\vlderivation                                                  {
\vlin{=   }{}{\ttt                                  }         {
\vlin{\aiu}{}{\vls[\fff.\ttt]                       }        {
\vlin{=   }{}{\vls[(\GR{a}.\RD{\bar a}).\ttt]       }       {
\vlin{\swi}{}{\vls[[(\RD{\bar a}.\GR{a}).\ttt].\ttt]}      {
\vlin{=   }{}{\vls[(\RD{\bar a}.[\GR{a}.\ttt]).\ttt]}     {
\vlin{\swi}{}{\vls[([\GR{a}.\ttt].\RD{\bar a}).\ttt]}    {
\vlin{=   }{}{\vls([\GR{a}.\ttt].[\RD{\bar a}.\ttt])}   {
\vlin{\med}{}{\vls([\GR{a}.\ttt].[\ttt.\RD{\bar a}])}  {
\vlin{=   }{}{\vls[(\GR{a}.\ttt).(\ttt.\RD{\bar a})]} {
\vlin{\aid}{}{\vls[\GR{a}.\RD{\bar a}]              }{
\vlhy        {\ttt                                  }}}}}}}}}}}}
\qquad&
\vlderivation                                                              {
\vlin{\aiu}{}
   {\vls(\DO{a}.\fff)                                            }        {
\vlin{=   }{}
   {\vls(\DO{a}.(\PB{a}.\MG{\bar a}))                            }       {
\vlin{\acu}{}
   {\vls((\DO{a}.\PB{a}).\MG{\bar a})                            }      {
\vlin{=   }{}
   {\vls(\SG{a}.\MG{\bar a})                                     }     {
\vlin{\aiu}{}
   {\vls([\fff.\SG{a}].\MG{\bar a})                              }    {
\vlin{\acd}{}
   {\vls([(\RD{a}.\RS{\bar a}).\SG{a}].\MG{\bar a})              }   {
\vlin{\swi}{}
   {\vls([(\RD{a}.[\GR{\bar a}.\YO{\bar a}]).\SG{a}].\MG{\bar a})}  {
\vlin{=   }{}
   {\vls((\RD{a}.[[\GR{\bar a}.\YO{\bar a}].\SG{a}]).\MG{\bar a})} {
\vlin{\aid}{}
   {\vls(\RD{a}.[\GR{\bar a}.[\YO{\bar a}.\SG{a}]].\MG{\bar a})  }{
\vlhy        
   {\vls(\RD{a}.[\GR{\bar a}.\ttt].\MG{\bar a})                  }}}}}}}}}}}
\qquad&
\vlderivation                                                              {
\vlin{=   }{}{\vls(([\RS{a}.\YO{b}].\PW{c}).([\GR{a}.\DO{b}].\SG{c}))}    {
\vlin{\med}{}{\vls(([\RS{a}.\YO{b}].[\GR{a}.\DO{b}]).(\PW{c}.\SG{c}))}   {
\vlin{\acu}{}{\vls([(\RS{a}.\GR{a}).(\YO{b}.\DO{b})].(\PW{c}.\SG{c}))}  {
\vlin{\acu}{}{\vls([(\RS{a}.\GR{a}).(\YO{b}.\DO{b})].\MG{c})         } {
\vlin{\acu}{}{\vls([(\RS{a}.\GR{a}).\PB{b}].\MG{c})                  }{
\vlhy        {\vls([\RD{a}.\PB{b}].\MG{c})                           }}}}}}}\\
\atomicflow{
(0,0)*{\afaiucol{}{}{}{}{}{}{Green}{Red}{}};
(0,4)*{\afaidnw{}{}}}
\qquad&
\atomicflow{
( 2,14)*{\afvjcol4{Green}};
( 0,10)*{\afvjcol{12}{Red}};
(16,10)*{\afvjcol{12}{Magenta}};
( 4, 8)*{\afacdcol{}{}{}{}{}{}{Green}{YellowOrange}{RawSienna}};
(10, 8)*{\afacucol{}{}{}{}{}{}{DarkOrchid}{ProcessBlue}{SpringGreen}};
( 2, 2)*{\afaiunw{}{}};
( 8, 2)*{\afvjcol4{DarkOrchid}};
(14, 2)*{\afaiunw{}{}};
( 8,12)*{\afaidnw{}{}}}
\qquad&
\atomicflow{
( 0,0)*{\afacucol{}{}{}{}{}{}{RawSienna}{Green}{Red}};
(10,0)*{\afacucol{}{}{}{}{}{}{YellowOrange}{DarkOrchid}{ProcessBlue}};
(20,0)*{\afacucol{}{}{}{}{}{}{Periwinkle}{SpringGreen}{Magenta}}}
\end{array}
\]
\caption{Examples of atomic flows associated with derivations.}
\label{FigExAF}
\end{figure}

Inference rules are usually called linear when they do not `create' nor `destroy' atoms. Linear rules of $\SKS$ are switch, medial and (every equation defining) rule $=$. Note that linear inference rules do not introduce any vertices in atomic flows.

We now define the notion of paths in atomic flows. Paths are sequences of adjacent edges that only `go down' or only `go up'.
%---------------------------------------
% TODO: define maximal paths
% TODO: put this where it belongs:
% Given a path $\epsilon_1,\dots,\epsilon_n$ such that $n=1$ or $up(\epsilon_1)=lo(\epsilon_2)$, we say that \emph{$\epsilon_1$ is the bottom edge} and \emph{$\epsilon_n$ is the top edge} of $\epsilon_1,\dots,\epsilon_n$.
\begin{defi}
Given an atomic flow $(V,E,\eta,\up,\lo)$ and $\epsilon_1,\dots,\epsilon_h\in E$ such that, for $1\le i<h$, we have $\lo(\epsilon_i)=\up(\epsilon_{i+1})$, $\up(\epsilon_1)=\nu$ and $\lo(\epsilon_h)=\nu'$, we say that $\epsilon_1,\dots,\epsilon_h$ is a \emph{path from $\nu$ to $\nu'$} and that $\epsilon_h,\dots,\epsilon_1$ is a \emph{path from $\nu'$ to $\nu$}.
\end{defi}
%===============================================================================
\section{Preliminaries}

\begin{lem}\label{LemSuperSwitch}
Given a context $\xi\vlhole$ and a formula $\alpha$ there exist derivations $\vlder{}{\{\swi\}}{\xi\{\alpha\}}{\vls(\alpha.\xi\{\ttt\})}$ and $\vlder{}{\{\swi\}}{\vls[\xi\{\fff\}.\alpha]}{\xi\{\alpha\}}$.
\end{lem}

\begin{proof}
We show how to construct the first derivation, the second one can be done by symmetry. We argue by induction on the number of atoms in $\xi\vlhole$. The base case, $\xi\vlhole=\vlhole$, is trivial and the inductive cases are:

\[
\vlderivation
{
 \vlin{=}{}{\xi\{\alpha\}}
 {
  \vlin{\swi}{}{\vls[\vlder{\Psi}{\{\swi\}}{\xi'\{\alpha\}}{\vls(\alpha.\xi'\{\ttt\})}.\beta]}
  {
   \vlin{=}{}{\vls(\alpha.[\xi'\{\ttt\}.\beta])}
   {
    \vlhy{\vls(\alpha.\xi\{\ttt\})}
   }
  }
 }
}\qquad\mbox{and}\qquad
\vlderivation
{
 \vlin{=}{}{\xi\{\alpha\}}
 {
  \vlin{=}{}{\vls(\vlder{\Psi'}{\{\swi\}}{\xi'\{\alpha\}}{\vls(\alpha.\xi'\{\ttt\})}.\beta)}
  {
   \vlhy{\vls(\alpha.\xi\{\ttt\})}
  }
 }
}\quad,
\]
for some $\xi'\vlhole$ and $\beta$ where $\beta$ is not a unit and $\Psi$ and $\Psi'$ exist by the inductive hypothesis.
\end{proof}

\begin{lem}\label{LemDecompInt}
Given a derivation $\vlder{\Phi}{}{\beta}{\alpha}$ with atomic flow $A$, there exists a derivation
\[
\vlder{}{\SKS\setminus\{\aid,\aiu\}}{\vls[\beta.\vlinf{\aiu}{}{\fff}{\vls(b_m.\bar b_m)}.\cdots.\vlinf{\aiu}{}{\fff}{\vls(b_1.\bar b_1)}]}{\vls(\vlinf{\aid}{}{\vls[a_1.\bar a_1]}{\ttt}.\cdots.\vlinf{\aid}{}{\vls[a_n.\bar a_n]}{\ttt}.\alpha)}\quad,
\]
for some atoms $a_1,\dots,a_n,b_1,\dots,b_n$ with atomic flow $A$.
\end{lem}
\begin{proof}
Using Lemma~\ref{LemSuperSwitch} apply the following transformations to each of the (co)interaction instances in $\Phi$:
\[
\vlderivation
{
 \vlde{\Psi'}{}{\delta}
 {
  \vlin{\aid}{}{\xi\vlsbr[a.{\bar a}]}
  {
   \vlde{\Psi}{}{\xi\{\ttt\}}
   {
    \vlhy{\gamma}
   }
  }
 }
}\quad\rightarrow\quad
\vlderivation
{
 \vlde{\Psi'}{}{\delta}
 {
  \vlde{}{\{\swi\}}{\xi\vlsbr[a.{\bar a}]}
  {
   \vlhy{\vlsbr(\vlinf{\aid}{}{\vls[a.{\bar a}]}{\ttt}.\vlder{\Psi}{}{\xi\{\ttt\}}{\gamma})}
  }
 }
}\qquad\mbox{and}\qquad
\vlderivation
{
 \vlde{\Psi'}{}{\delta}
 {
  \vlin{\aid}{}{\xi\{\fff\}}
  {
   \vlde{\Psi}{}{\xi\vlsbr(a.{\bar a})}
   {
    \vlhy{\gamma}
   }
  }
 }
}\quad\rightarrow\quad
\vlderivation
{
 \vlde{}{\{\swi\}}{\vlsbr[\vlder{\Psi'}{}{\delta}{\xi\{\fff\}}.\vlinf{\aiu}{}{\fff}{\vls(a.{\bar a})}]}
 {
  \vlde{\Psi}{}{\xi\vlsbr(a.{\bar a})}
  {
   \vlhy{\gamma}
  }
 }
}\quad.
\]
Note that no structural inference rules are changed, so the atomic flow of the resulting derivation is the same as the atomic flow of $\Phi$.
\end{proof}

\begin{defi}
Given a derivation $\vlder{\Phi}{}{\beta}{\alpha}$ and an atom $a$, we define $\vlder{\Phi\{a\ot\fff\}}{}{\beta\{a\ot\fff\}}{\alpha\{a\ot\fff\}}$:
\begin{itemize}
\item obtain $\Phi'$ by Lemma~\ref{LemDecompInt},
\item substitute each instance of $a$ in $\Phi'$ with $\fff$,
\item for each $\rho\in\{\acd,\acu,\awd,\awu\}$ where $a$ occurred substitute $\rho$ with $=$ and
\item substitute each $\vlinf{\aid}{}{\vls[a.\bar a]}{\ttt}$ and $\vlinf{\aiu}{}{\fff}{\vls(a.\bar a)}$ with $\vlinf{=}{}{\bar a}{\bar a}$ and $\vlinf{=}{}{\vls(\fff.\bar a)}{\vls(\fff.\bar a)}$, respectively.
\end{itemize}
We write $\Phi\{a,b\ot\fff\}$ as a shorthand for $\Phi\{a\ot\fff\}\{b\ot\fff\}$.
\end{defi}

\begin{pro}
Given a derivation $\Phi$ containing an atom $a$, $\Phi\{a\ot\fff\}$ is a valid derivation with a unique atomic flow.
\end{pro}

We now show how we can generalise the (co)contraction rules to work for formulae instead of atoms.

\newcommand{\contr}{\mathsf{c}}
\newcommand{\cod}{{\contr{\downarrow}}}
\newcommand{\cou}{{\contr{\uparrow}}}

\begin{lem}\label{LemGenericContraction}
Given a formula $\alpha$ and a positive integer $n$, there exist derivations $\vlder{}{\{\acd,\med\}}{\alpha}{\bigvee_{i=1}^{n}\alpha}$ and $\vlder{}{\{\acu,\med\}}{\bigwedge_{i=1}^{n}\alpha}{\alpha}$.
\end{lem}

\begin{rem}
In the non-atomic version of system $\SKS$ the above derivations correspond to repeated applications of (co)contractions. For this reason we sometimes write the inference rules $\vlinf{\cod}{}{\alpha}{\vls[\alpha.\alpha]}$ and $\vlinf{\cou}{}{\vls(\alpha.\alpha)}{\alpha}$ instead of the derivations $\vlder{}{\{\acd,\med\}}{\alpha}{\vls[\alpha.\alpha]}$ and $\vlder{}{\{\acu,\med\}}{\vls(\alpha.\alpha)}{\alpha}$.
\end{rem}

\subsection{Cores}

% TODO: somehow express that a_1,\dots,a_n are all of them

\begin{defi}\label{DefCore}
Given
\begin{itemize}
 \item a derivation $\vlder{\Phi}{}{\beta}{\alpha}$ and
 \item the distinct and pairwise non-dual atoms $a_1,\dots,a_n$, each of which appears in both interaction and cointeraction instance in $\Phi$,
\end{itemize}
a \emph{core of\/ $\Phi$} is a derivation 
\[
\vlder{}{}{\vls[\beta.(a_n.\bar a_n).\cdots.(a_1.\bar a_1)]}{\vls([a_1.\bar a_1].\cdots.[a_n.\bar a_n].\alpha)}
\]
where no atom occurs in both an interaction and a cointeraction instance.
\end{defi}

% TODO: say that a core is weakly streamlined

\begin{lem}\label{LemCoreExistence}
For any derivation $\Phi$ from $\alpha$ to $\beta$ a core of\/ $\Phi$ can be constructed.
\end{lem}

\begin{proof}
Let $a_1,\dots,a_n$ be the distinct and pairwise non-dual atoms each of which appears in both interaction and cointeraction instances in $\Phi$. Remove each (co)interaction instance where $a_1,\dots,a_n$ occurs from the result of applying Lemma~\ref{LemDecompInt} to $\Phi$. This yields
\[
\vlder{\Phi'}{}{\vls[\beta.(a_n.\bar a_n).\cdots.(a_n.\bar a_n).\cdots.(a_1.\bar a_1).\cdots.(a_1.\bar a_1)]}{\vls([a_1.\bar a_1].\cdots.[a_1.\bar a_1].\cdots.[a_n.\bar a_n].\cdots.[a_n.\bar a_n].\alpha)}\quad.
\]

We now construct a core of $\Phi$ from $\Phi'$ by using Lemma~\ref{LemGenericContraction}:
\[
\vlderivation
{
 \vlde{}{\{\acd,\med\}}{\vls[\beta.(a_n.{\bar a_n}).\cdots.(a_1.{\bar a_1})]}
 {
  \vlde{\Phi'}{}{\vls[\beta.(a_n.\bar a_n).\cdots.(a_n.\bar a_n).\cdots.(a_1.\bar a_1).\cdots.(a_1.\bar a_1)]}
  {
   \vlde{}{\{\acu,\med\}}{\vls([a_1.\bar a_1].\cdots.[a_1.\bar a_1].\cdots.[a_n.\bar a_n].\cdots.[a_n.\bar a_n].\alpha)}
   {
    \vlhy{\vls([a_1.{\bar a_1}].\cdots.[a_n.{\bar a_n}].\alpha)}
   }
  }
 }
}\quad.
\]
\end{proof}

\newcommand{\Core}{\mathsf{Core}}

% TODO: define associativity of contractions

Note that the core obtained using the construction in the above proof is not unique, several choices are made. However, we would like to argue that the cores only differ for inessential details, and in fact from the point of view of atomic flows they are all the same.

\newbox\upone\setbox\upone=\hbox{$
   \divide\atflowunit by5\multiply\atflowunit by3\afsetunits
   \atomicflow{(0,0)*{\afacu{}{}{}{}{}{}}}$}
\newbox\uptwo\setbox\uptwo=\hbox{$
   \divide\atflowunit by5\multiply\atflowunit by3\afsetunits
   \atomicflow{(0,0)*{\afacu{}{}{}{}{}{}}}$}
\newbox\upthree\setbox\upthree=\hbox{$
   \divide\atflowunit by5\multiply\atflowunit by3\afsetunits
   \atomicflow{(0,0)*{\afacu{}{}{}{}{}{}}}$}
\newbox\upfour\setbox\upfour=\hbox{$
   \divide\atflowunit by5\multiply\atflowunit by3\afsetunits
   \atomicflow{(0,0)*{\afacu{}{}{}{}{}{}}}$}
\newbox\downone\setbox\downone=\hbox{$
   \divide\atflowunit by5\multiply\atflowunit by3\afsetunits
   \atomicflow{(0,0)*{\afacd{}{}{}{}{}{}}}$}
\newbox\downtwo\setbox\downtwo=\hbox{$
   \divide\atflowunit by5\multiply\atflowunit by3\afsetunits
   \atomicflow{(0,0)*{\afacd{}{}{}{}{}{}}}$}
\newbox\downthree\setbox\downthree=\hbox{$
   \divide\atflowunit by5\multiply\atflowunit by3\afsetunits
   \atomicflow{(0,0)*{\afacd{}{}{}{}{}{}}}$}
\newbox\downfour\setbox\downfour=\hbox{$
   \divide\atflowunit by5\multiply\atflowunit by3\afsetunits
   \atomicflow{(0,0)*{\afacd{}{}{}{}{}{}}}$}


\begin{pro}\label{PropUniqueCore}
Given a derivation $\Phi$ with atomic flow
\[
\atomicflow
{
(-21, 6)*{\afvjm{4}};
(-13, 8)*{\afaidm{}{}{}{}{}{}};
( -5, 6)*{\afvjm{4}};
(-18, 0)*{\affr{8}{8}};
(-16, 2)*{a_1};
( -8, 0)*{\affr{8}{8}};
( -6, 2)*{\bar a_1};
( -5,-6)*{\afvjm{4}};
(-13,-8)*{\afaium{}{}{}{}{}{}};
(-21,-6)*{\afvjm{4}};
%------------
(0,0)*{\cdots};
%------------
(21, 6)*{\afvjm{4}};
(13, 8)*{\afaidm{}{}{}{}{}{}};
( 5, 6)*{\afvjm{4}};
( 8, 0)*{\affr{8}{8}};
(10, 2)*{a_n};
(18, 0)*{\affr{8}{8}};
(20, 2)*{\bar a_n};
( 5,-6)*{\afvjm{4}};
(13,-8)*{\afaium{}{}{}{}{}{}};
(21,-6)*{\afvjm{4}};
%------------
(28, 6)*{\afvjm4};
(28, 0)*{\affr{8}{8}};
(30, 2)*{A};
(28,-6)*{\afvjm4};
}\quad,
\]
where $A$ does not contain a path from an interaction to a cointeraction vertex, the atomic flow of a core of\/ $\Phi$ obtained as described in the proof of Lemma~\ref{LemCoreExistence} is
\[
\atomicflow
{
(-21,10)*{\afvjm{12}};
(-17,15)*{\afvj2};
(-17,10)*{\affr{6}{8}};
(-17,10)*{\box\upone};
(-17, 5)*{\afvjm{2}};
(-18, 0)*{\affr{8}{8}};
(-16, 2)*{a_1};
(-21,-10)*{\afvjm{12}};
(-17,-15)*{\afvj2};
(-17,-10)*{\affr{6}{8}};
(-17,-10)*{\box\downone};
(-17, -5)*{\afvjm{2}};
%
( -9,15)*{\afvj2};
( -9,10)*{\affr{6}{8}};
( -9,10)*{\box\uptwo};
( -9, 5)*{\afvjm{2}};
( -5,10)*{\afvjm{12}};
( -8, 0)*{\affr{8}{8}};
( -6, 2)*{\bar a_1};
( -9,-15)*{\afvj2};
( -9,-10)*{\affr{6}{8}};
( -9,-10)*{\box\downtwo};
( -9, -5)*{\afvjm{2}};
( -5,-10)*{\afvjm{12}};
( -8, 0)*{\affr{8}{8}};
%------------
(0,0)*{\cdots};
%------------
( 9,15)*{\afvj2};
( 9,10)*{\affr{6}{8}};
( 9,10)*{\box\upthree};
( 9, 5)*{\afvjm{2}};
( 5,10)*{\afvjm{12}};
( 8, 0)*{\affr{8}{8}};
(10, 2)*{a_n};
( 9,-15)*{\afvj2};
( 9,-10)*{\affr{6}{8}};
( 9,-10)*{\box\downthree};
( 9, -5)*{\afvjm{2}};
( 5,-10)*{\afvjm{12}};
( 8, 0)*{\affr{8}{8}};
%
(21,10)*{\afvjm{12}};
(17,15)*{\afvj2};
(17,10)*{\affr{6}{8}};
(17,10)*{\box\upfour};
(17, 5)*{\afvjm{2}};
(18, 0)*{\affr{8}{8}};
(20, 2)*{\bar a_n};
(21,-10)*{\afvjm{12}};
(17,-15)*{\afvj2};
(17,-10)*{\affr{6}{8}};
(17,-10)*{\box\downfour};
(17, -5)*{\afvjm{2}};
%---------
(28, 10)*{\afvjm{12}};
(28, 0)*{\affr{8}{8}};
(30, 2)*{A};
(28,-10)*{\afvjm{12}};
}\quad.
\]
\end{pro}

In other words the atomic flow of a core constructed as described in the proof of Lemma~\ref{LemCoreExistence} is unique modulo associativity of contractions, which justifies the following definition.

\begin{defi}\label{DefCanonicalCore}
A core of a derivation $\Phi$, constructed as described in the proof of Lemma~\ref{LemCoreExistence}, is called \emph{a canonical core of\/ $\Phi$}, written $\Core(\Phi)$.
\end{defi}

\section{Cut-elimination}

\begin{rem}\label{RemUglyHack}
The challenge when performing cut-elimination is to deal with the situation where an atom occurs in both interaction and cointeraction instances. Since that is the case we are interested in, we will assume, without loss of generality, that every atom in an $\SKS$ proof occurs in both interaction and cointeraction instances. The justification for doing this is the following: If a proof $\vlproof{\Phi}{\SKS}{\beta}$ contains the atom $a$, but $a$ does not occur in both an interaction and a cointeraction instance, we can consider the proof
\[
\vls[(\vlproof{\Phi}{\SKS}{\beta}.\vlinf{\aid}{}{\vls[\vlinf{\awu}{}{\ttt}{a}.\vlinf{\awu}{}{\ttt}{\bar a}]}{\ttt}).\vlinf{\aiu}{}{\fff}{\vls(\vlinf{\awd}{}{a}{\fff}.\vlinf{\awd}{}{\bar a}{\fff})}]
\]
instead.
\end{rem}

\newcommand{\Exp}{\mathsf{Exp}}

\begin{defi}\label{DefExperiment}
Given a proof, $\vlproof{\Phi}{\SKS}{\beta}$, where the distinct and non-dual atoms $a_1,\dots,a_n$ and their duals are all the atoms which occur, an \emph{experiment on $\Phi$ with respect to $a_1,\dots,a_n$}, denoted $\Exp(\Phi,a_1,\dots,a_n)$, is defined to be
\[
\vlder{\Phi\{\bar a_1,\dots,\bar a_n\ot\fff\}}{\SKS\setminus\{\aid,\aiu\}}{\vls[\vlder{}{\{\awd\}}{\beta}{\beta\{\bar a_1,\dots,\bar a_n\ot\fff\}}.(\vlinf{\awu}{}{\ttt}{a_1}.\fff).\dots.(\vlinf{\awu}{}{\ttt}{a_1}.\fff).\dots.(\vlinf{\awu}{}{\ttt}{a_n}.\fff).\dots.(\vlinf{\awu}{}{\ttt}{a_n}.\fff)]}{\vls(\vlder{}{\{\acu\}}{\vls(a_1.\dots.a_1)}{a_1}.\dots.\vlder{}{\{\acu\}}{\vls(a_n.\dots.a_n)}{a_n})}\quad.
\]
\end{defi}

Note that Remark~\ref{RemUglyHack} ensures that there is at least one of each of $a_1,\dots,a_n$ in both the premiss and the conclusion of $\Phi\{\bar a_1,\dots,\bar a_n\ot\fff\}$.

\begin{rem}
Note that there are $2^n$ different ways of choosing $a_1,\dots,a_n$ given $\Phi$.
\end{rem}

% TODO: add reference to AFI

\begin{pro}
Given a proof, $\vlproof{\Phi}{\SKS}{\beta}$, with atomic flow
\[
\atomicflow
{
(-18, 0)*{\affr{8}{8}};
(-16, 2)*{a_1};
(-21,-6)*{\afvjm4};
%
(-13,8)*{\afaidm{}{}{}{}{}{}};
(-13,-8)*{\afaium{}{}{}{}{}{}};
%
( -8, 0)*{\affr{8}{8}};
( -6, 2)*{\bar a_1};
( -5,-6)*{\afvjm4};
%------------
(0,0)*{\cdots};
%------------
( 8, 0)*{\affr{8}{8}};
(10, 2)*{a_n};
( 5,-6)*{\afvjm4};
%
(13,8)*{\afaidm{}{}{}{}{}{}};
(13,-8)*{\afaium{}{}{}{}{}{}};
%
(18, 0)*{\affr{8}{8}};
(20, 2)*{\bar a_n};
(21,-6)*{\afvjm4};
}\quad,
\]
the atomic flow of an experiment on $\Phi$ with respect to $a_1,\dots,a_n$ is
\[
\atomicflow
{
( -8,16)*{\afvj4};
( -8,10)*{\affr{8}{8}};
( -8, 5)*{\afvjm2};
( -8, 0)*{\affr{8}{8}};
( -6, 2)*{a_1};
(-11,-6)*{\afvjm4};
( -5,-8)*{\afawum{}{}{}{}};
%------------
(0,5)*{\cdots};
%------------
( 8,16)*{\afvj4};
( 8,10)*{\affr{8}{8}};
( 8, 5)*{\afvjm2};
( 8, 0)*{\affr{8}{8}};
(10, 2)*{a_n};
( 5,-8)*{\afawum{}{}{}{}};
(11,-6)*{\afvjm4};
%------------
(18,-4)*{\afawdm{}{}{}{\bar a_1}};
%------------
(22,-5)*{\cdots};
%------------
(26,-4)*{\afawdm{}{}{}{\bar a_n}};
}\quad.
\]
\end{pro}

In other words, $\Exp(\Phi,a_1,\dots,a_n)$ is not unique, but its atomic flow is unique modulo associativity of contractions.

% TODO: allow atomic flows to be named after the atom that maps to it

\begin{rem}\label{RemExperimentExistence}
Using the weakening reductions presented in \cite{GuGu08} we can use another approach to obtaining an experiment on the proof $\Phi$ with respect to $a_1,\dots,a_n$:

Simply consider the derivation
\[
\vlder{\Core(\Phi)}{}{\vls[\beta.\vlinf{\aiu}{}{\fff}{\vls(a_1.\bar a_1)}.\cdots.\vlinf{\aiu}{}{\fff}{\vls(a_n.\bar a_n)}]}{\vls([a_1.\vlinf{\awd}{}{\bar a_1}{\fff}].\cdots.[a_n.\vlinf{\awd}{}{\bar a_n}{\fff}])}\quad,
\]
with atomic flow
\[
\atomicflow
{
(-18,16)*{\afvj4};
(-18,10)*{\affr{8}{8}};
(-18, 5)*{\afvjm{2}};
(-18, 0)*{\affr{8}{8}};
(-16, 2)*{a_1};
(-21,-12)*{\afvjm{16}};
(-17,-10)*{\affr{6}{8}};
(-17, -5)*{\afvjm{2}};
%
(-13,-18)*{\afaiu{}{}{}{}{}{}};
%
( -8,18)*{\afawd{}{}{}{}};
( -8,10)*{\affr{8}{8}};
( -8, 5)*{\afvjm{2}};
( -8, 0)*{\affr{8}{8}};
( -6, 2)*{{\bar a}_1};
( -9,-10)*{\affr{6}{8}};
( -9, -5)*{\afvjm{2}};
( -5,-12)*{\afvjm{16}};
%------------
(0,0)*{\cdots};
%------------
( 8,16)*{\afvj4};
( 8,10)*{\affr{8}{8}};
( 8, 5)*{\afvjm{2}};
( 8, 0)*{\affr{8}{8}};
( 6, 2)*{a_n};
( 9,-10)*{\affr{6}{8}};
( 9, -5)*{\afvjm{2}};
( 5,-12)*{\afvjm{16}};
%
(13,-18)*{\afaiu{}{}{}{}{}{}};
%
(18,18)*{\afawd{}{}{}{}};
(18,10)*{\affr{8}{8}};
(18, 5)*{\afvjm{2}};
(18, 0)*{\affr{8}{8}};
(16, 2)*{{\bar a}_n};
(21,-12)*{\afvjm{16}};
(17,-10)*{\affr{6}{8}};
(17, -5)*{\afvjm{2}};
}\quad,
\]
and apply weakening reductions until a derivation with the desired atomic flow is obtained.
\end{rem}

% TODO: big remark or section on philosophy
% TODO: remark on symmetry/confluence

\newcommand{\Assignments}{\mathcal A}
\newcommand{\Sym}{\mathsf{Sym}}

% TODO: is it bad to give a name to something before arguing that it is unique?


\begin{defi}\label{DefSymmetricProof}
Given distinct and pairwise non-dual atoms, $a_1,\dots,a_n$, define
\begin{itemize}
\item the set $\Assignments_k=\{\{b_1,\dots,b_k\}|b_i\in\{a_i,\bar a_i\}\}$ for $1\leq k\leq n$ and
\item a \emph{symmetric proof of }$\bigvee_{\{b_1,\dots,b_k\}\in\Assignments_k}\vlsbr(b_1.\cdots.b_n)$, denoted $\Sym(a_1,\dots,a_k)$, by induction on $k$:

The base case is $\Sym(a_1)=\vlinf{\aid}{}{\vls[a_1.\bar a_1]}{\ttt}$ and the inductive case, for $1 < k \leq n$, is:
\[
\newbox\DerCap
\setbox\DerCap=
\hbox{$
\vlderivation
{
 \vlde{}{\{\acu,\med\}}{\bigwedge_{i=1}^{2^{k-1}}[b_k.\bar b_k]}
 {
  \vlin{\aid}{}{\vls[b_k.\bar b_k]}
  {
   \vlhy{\ttt}
  }
 }
}$
}
\newbox\DerCap
\setbox\DerCap=
\hbox{$
\vlderivation
{
 \vlde{}{\{\acu,\med\}}{\bigwedge_{i=1}^{2^{k-1}}\vls[b_k.\bar b_k]}
 {
  \vlin{\aid}{}{\vls[b_k.\bar b_k]}
  {
   \vlhy{\ttt}
  }
 }
}$
}
\Sym(a_1,\dots,a_k)\quad=\quad
\vlderivation
{
 \vlin{=}{}{\bigvee_{\{b_1,\dots,b_k\}\in \Assignments_k}\vlsbr(b_1.\cdots.b_k)}
 {
  \vlde{}{\{\swi\}}{\bigvee_{\{b_1,\dots,b_{k-1}\}\in \Assignments_{n-1}}\vlsbr[(b_1.\cdots.b_{k-1}.b_n).(b_1.\cdots.b_{k-1}.\bar b_k)]}
  {
  \vlpr{\Sym(a_1,\dots,a_{k-1})}{\{\aid,\acu,\swi,\med\}}{\vls(\box\DerCap.\bigvee_{\{b_1,\dots,b_{k-1}\}\in \Assignments_{k-1}}(\vlinf{\acu}{}{\vls(b_1.b_1)}{b_1}.\cdots.\vlinf{\acu}{}{\vls(b_{k-1}.b_{k-1})}{b_{k-1}}))}
  }
 }
}\quad.
\]
\end{itemize}
\end{defi}

Note that the derivation $\Sym(a_1,\dots,a_n)$ is not unique, but its atomic flow is unique modulo associativity of contractions:

\begin{pro}
The atomic flow of a $\Sym(a_1,\dots,a_n)$ is
% TODO: contractions and cocontractions
\[
\atomicflow
{
(-13, 8)*{\afaid{}{}{}{}{}{}};
(-18, 0)*{\affr{8}{8}};
(-16, 2)*{a_1};
( -8, 0)*{\affr{8}{8}};
( -6, 2)*{\bar a_1};
(-18,-6)*{\afvjm{4}};
( -8,-6)*{\afvjm{4}};
%------------
(0,0)*{\cdots};
%------------
(13, 8)*{\afaid{}{}{}{}{}{}};
( 8, 0)*{\affr{8}{8}};
(10, 2)*{a_n};
(18, 0)*{\affr{8}{8}};
(20, 2)*{\bar a_n};
( 8,-6)*{\afvjm{4}};
(18,-6)*{\afvjm{4}};
}\quad.
\]
\end{pro}


\begin{defi}
Given a proof, $\vlproof{\Phi}{}{\beta}$, and atoms $a_1,\dots,a_n$, such that in every interaction rule instance exactly one of $a_1,\dots,a_n$ appears and every $a_1,\dots,a_n$ occurs in an interaction rule instance, then \emph{a symmetric cut-free proof obtained from $\Phi$} is:
\[
\vlderivation
{
 \vlin{(2^n-1)\times\cod}{}{\beta}
 {
  \vlpr{\Sym(a_1,\dots,a_n)}{\{\aid,\acu,\swi,\med\}}{\bigvee_{\{b_1,\dots,b_n\}\in\Assignments_n}\left(\vlder{\Exp(\Phi,b_1,\dots,b_n)}{\SKS\setminus\{\aiu\}}{\beta}{\vls(b_1.\cdots.b_n)}\right)}
 }
}
\]
\end{defi}

\begin{pro}
Given a proof $\Phi$ and two symmetric cut-free proofs obtained from $\Phi$ the atomic flows of the two canonical cut-free proofs are equal modulo associativity of contraction.
\end{pro}

% TODO: Check literature about rewriting modulo

% TODO: maybe put this somewhere else
%
% \begin{cor}
% Given a proof of $\alpha$ in $\SKS$ there exists a canonical proof of $\alpha$ in $\KS$.
% \end{cor}


%===============================================================================
\section{Normaliser}

\newcommand{\Norm}{\mathsf{Norm}}

\begin{defi}
The \emph{normaliser}, $\Norm(\Phi,a_1,\dots,a_n)$, is an operator taking as input a sequence of atoms and a derivation of the form
\[
\vlder{\Phi}{}{\vls[\beta.(a_n.{\bar a_n}).\cdots.(a_1.{\bar a_1})]}{\vls([a_1.{\bar a_1}].\cdots.[a_n.{\bar a_n}].\alpha)}\quad,
\]
where $\alpha$ and $\beta$ are formulae and returning a derivation of the form
\[
\vlder{\Norm(\Phi,a_1,\dots,a_n)}{}{\beta}{\alpha}\quad.
\]

We define $\Norm$ inductively on the number of arguments. Let $\Norm(\Phi)=\Phi$ and for $n>0$ let $\Norm(\Phi,a_1,\dots,a_n)$ be
\newbox\DeltaTopK
\setbox\DeltaTopK=
\hbox{$
\vlderivation
{
 \vlde{\Norm(\Phi,a_1,\dots,a_{n-1})}{}{\vls[\beta.(\vlinf{\awu}{}{\ttt}{a_n}.\bar a_n)]}
 {
  \vlhy{\vls(\vlinf{\aid}{}{\vls[a_n.\bar a_n]}{\ttt}.\alpha)}
 }
}$
}
\newbox\DeltaBotK
\setbox\DeltaBotK=
\hbox{
$\vlderivation
{
 \vlde{\Norm(\Phi,a_1,\dots,a_{n-1})}{}{\vls[\beta.\vlinf{\aiu}{}{\fff}{\vls(a_n.\bar a_n)}]}
 {
  \vlhy{\vls([a_n.\vlinf{\awd}{}{\bar a_n}{\fff}].\alpha)}
 }
}$
}
\newbox\DeltaK
\setbox\DeltaK=
\hbox{$
\vlderivation
{
 \vlde{\Norm(\Phi,a_1,\dots,a_{n-1})}{}{\vls[\beta.(a_n.\vlinf{\awu}{}{\ttt}{\bar a_n})]}
 {
  \vlhy{\vls([\vlinf{\awd}{}{a_n}{\fff}.\bar a_n].\alpha)}
 }
}$
}
\[
\vlderivation
{
 \vlin{\cod}{}{\beta}
 {
  \vlin{\swi}{}{\vls[\vlinf{\cod}{}{\beta}{\vls[\beta.\beta]}.\box\DeltaBotK]}
  {
   \vlin{\swi}{}{\vls([\beta.\box\DeltaK].\alpha)}
   {
    \vlin{\cou}{}{\vls(\box\DeltaTopK.\vlinf{\cou}{}{\vls(\alpha.\alpha)}{\alpha})}
    {
     \vlhy{\alpha}
    }
   }
  }
 }
}\quad.
\]
\end{defi}

% TODO: define weakly streamlined

\begin{thm}
Given a derivation $\Phi$ from $\alpha$ to $\beta$, where $a_1,\dots,a_n$ are all the atoms that appear in both interaction and cointeraction instances then $\Norm(\Core(\Phi),a_1,\dots,a_n)$ is weakly streamlined.
\end{thm}

\begin{proof}
We argue by induction on $n$. The base case follows by the definition of $\Core$.

Consider the atomic flow of $\Norm(\Core(\Phi),a_1,\dots,a_{n-1})$ where the edges mapped to by $a_n$, $\bar a_n$ instances in the premiss and conclusion, but not in $\alpha$ or $\beta$ are singled out. Since this atomic flow is weakly streamlined we can represent it as follows:

\[
\atomicflow
{
(-8, 6)*{\afvjm{4}};
(-2, 6)*{\afvj{4}};
( 2, 6)*{\afvj{4}};
( 8, 6)*{\afvjm{4}};
(-5, 0)*{\affr{8}{8}};
(-3, 2)*{A};
( 5, 0)*{\affr{8}{8}};
( 7, 2)*{B};
( 8,-6)*{\afvjm{4}};
( 2,-6)*{\afvj{4}};
(-2,-6)*{\afvj{4}};
(-8,-6)*{\afvjm{4}};
}\quad.
\]

Now consider the atomic flow of $\Norm(\Core(\Phi),a_1,\dots,a_n)$,
\[
\atomicflow
{
% cocontractions
%  outer
(-13.5,36.5)*{\afacumexsqcol{}{}{}{}{}{}{33}{4}{}{Green}{Green}};
(  2.5,36.5)*{\afacumexsqcol{}{}{}{}{}{}{33}{4}{}{Green}{Green}};
%  inner
( -8, 13)*{\afvjmcol{18}{Green}};
( 14,  0)*{\afvjmcol{44}{Green}};
(  3, 26)*{\afacumnwexsqcol{}{}{}{}{11}{2}{Green}{Green}};
(  8, 13)*{\afvjm{18}};
( 30, 0)*{\afvjmcol{44}{Green}};
( 19, 26)*{\afacumnwexsqcol{}{}{}{}{11}{2}{}{Green}};
% top boxes
(-22, 34)*{\afaidcol{}{}{}{}{}{}{Red}{Red}};
(-27, 26)*{\affr{8}{8}};
(-25, 28)*{A_1};
(-17, 26)*{\affr{8}{8}};
(-15, 28)*{B_1};
(-24, 18)*{\afawucol{}{}{}{}{}{Red}};
( -9, 13)*{\afcjlcol{22}{18}{Red}};
% middle boxes
( -2,  8)*{\afawdcol{}{}{}{}{}{Green}};
(-5, 0)*{\affr{8}{8}};
(-3, 2)*{A_2};
( 5, 0)*{\affr{8}{8}};
( 7, 2)*{B_2};
(  2, -8)*{\afawucol{}{}{}{}{}{Red}};
% bottom boxes
( 22,-34)*{\afaiucol{}{}{}{}{}{}{Green}{Green}};
( 17,-26)*{\affr{8}{8}};
( 19,-24)*{A_3};
( 27,-26)*{\affr{8}{8}};
( 29,-24)*{B_3};
( 24,-18)*{\afawdcol{}{}{}{}{}{Green}};
(  9,-13)*{\afcjlcol{22}{18}{Green}};
% contractions
%  inner
( -8,-12.75)*{\afvjm{17.5}};
(-30,0.25)*{\afvjmcol{43.5}{Red}};
(-19,-27.5)*{\afacdmnwexsqcol{}{}{}{}{11}{2}{Red}{}};
(  8,-12.75)*{\afvjmcol{17.5}{Red}};
(-14,0.25)*{\afvjmcol{43.5}{Red}};
( -3,-27.5)*{\afacdmnwexsqcol{}{}{}{}{11}{2}{Red}{Red}};
%  outer
( 13.5,-36)*{\afacdmexsqcol{}{}{}{}{}{}{33}{4}{Red}{}{Red}};
( -2.5,-36)*{\afacdmexsqcol{}{}{}{}{}{}{33}{4}{Red}{}{Red}};
}\quad,
\]
where $A_1,A_2,A_3$ are isomorphic to $A$ and $B_1,B_2,B_3$ are isomorphic to $B$.

% TODO: passive form...

With the assistance of the atomic flow observe the following:
\begin{itemize}
\item The only paths between $A_1,A_2,A_3,A_4,B_1,B_2,B_3,B_4$ are paths mapped to from $a_n$ or $\bar a_n$, so since $\Norm(\Core(\Phi),a_1,\dots,a_{n-1})$ is weakly streamlined, there is no path from an interaction vertex to a cointeraction vertex which is mapped to by $a_1,\dots,a_{n-1}$.
\item None of the edges that could possibly be in a path from the interaction vertex (red) coincide with any of the edges that could possibly be in a path from the cointeraction vertex (green).
\end{itemize}

Since there are no paths from interaction vertices to cointeraction vertices, $\Norm(\Core(\Phi),a_1,\dots,a_n)$ is weakly streamlined.
\end{proof}



% \iflmcs\else\let\oldurl\url\renewcommand{\url}[1]{\hfill\break\oldurl{#1}}\fi
%
% \bibliographystyle{alpha}
% \bibliography{di-biblio}

\end{document}