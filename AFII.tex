\documentclass[a4paper]{amsart}

%                  Trash .aux file after toggling
\usepackage{stmaryrd}
\usepackage{graphicx}
\usepackage[margin=1in]{geometry}
\usepackage[lutzsyntax]{virginialake}\aftrianglefalse
\usepackage[pdfborder={0 0 0}]{hyperref}
\usepackage[urw-garamond]{mathdesign}

%--------- Theorem etc
\newtheorem{thm}{Theorem}[section]
\newtheorem{cor}[thm]{Corollary}
\newtheorem{lem}[thm]{Lemma}
\newtheorem{pro}[thm]{Proposition}

\theoremstyle{remark}
\newtheorem{rem}[thm]{Remark}
\newtheorem{exa}[thm]{Example}

\theoremstyle{definition}
\newtheorem{defi}[thm]{Definition}
%---------

\begin{document}

\title[Normalisation Control in Deep Inference   via Atomic Flows II]
      {Normalisation Control in Deep Inference\\ via Atomic Flows II}

\author{Alessio Guglielmi and Tom Gundersen}
%\address{University of Bath, Bath BA2 7AY, UK}

\thanks{This work was in part funded by an Overseas Research Scholarship and a Research Studentship, both from the University of Bath, and by the British Council Alliance Programme.}

\keywords{Normalisation, deep inference, cut elimination, atomic flows}

\subjclass{F.4.1 Mathematical Logic---Proof theory}

% \begin{abstract}
% \end{abstract}

\maketitle

%===============================================================================
\section{Introduction}


%===============================================================================
\section{Background on Deep Inference}

\newcommand{\fff}{\mathsf f}
\newcommand{\ttt}{\mathsf t}
\newcommand{\ot}{\mathbin\shortleftarrow}

% TODO: check that we only every use the variable names in the following definition

%---------------------------------------
\begin{defi}\label{DefFormulae}
\emph{Formulae}, $\alpha$, $\beta$, $\gamma$, $\delta$ are freely built from: \emph{units}, $\fff$ (false), $\ttt$ (true); \emph{atoms}, $a$, $b$, $c$, $d$; \emph{disjunction} and \emph{conjunction}, ${\vlsbr[\alpha.\beta]}$ and $\vlsbr(\alpha.\beta)$. On the set of atoms a (non-identical) involution $\bar\cdot$ is defined, and dual atom occurrences, as $a$ and $\bar a$, can appear in formulae. We denote \emph{contexts}, \emph{i.e.}, formulae with a hole, by $\xi\vlhole$ and $\zeta\vlhole$; we also use \emph{multiple} contexts, $\xi\vlhole\cdots\vlhole$, \emph{i.e.}, formulae with many holes; for example, if $\xi\{a\}$ is $\vls(b.[a.c])$, then $\xi\vlhole$ is $\vls(b.[\vlhole.c])$, $\xi\{b\}$ is $\vls(b.[b.c])$ and $\xi\vlscn(a.d)$ is $\vls(b.[(a.d).c])$; if $\xi\{a\}\{b\}\{c\}$ is $\vls(b.[(a.d).c])$ then $\xi\{b\}\{c\}\{a\}$ is $\vls(c.[(b.d).a])$.
\end{defi}

%---------------------------------------
\begin{rem}
Negation is only defined for atoms, which is not a limitation thanks to De Morgan laws.
\end{rem}

\newcommand{\one}{{\mathchoice{\scriptstyle\mathbf1}
                              {\scriptstyle\mathbf1}
                              {\scriptstyle\mathbf1}
                              {\scriptscriptstyle\mathbf1}}}
\newcommand{\two}{{\mathchoice{\scriptstyle\mathbf2}
                              {\scriptstyle\mathbf2}
                              {\scriptstyle\mathbf2}
                              {\scriptscriptstyle\mathbf2}}}
%---------------------------------------
\begin{defi}\label{DefDerivation}
\emph{Inference rules}, $\rho$, have one \emph{premiss} and one \emph{conclusion}, and their \emph{instances} are used in \emph{inference steps} to rewrite inside formulae. A \emph{derivation}, $\Phi$, from $\alpha$ (\emph{premiss}) to $\beta$ (\emph{conclusion}) is a chain of inference steps with $\alpha$ at the top and $\beta$ at the bottom, and is usually indicated by $\vlder{\Phi}{\mathcal S}{\beta}{\alpha}$, where $\mathcal S$ is the name of the deductive system or a set of inference rules; a \emph{proof} is a derivation from $\ttt$; besides $\Phi$, we denote derivations with $\Psi$. We denote with $\xi\{\Phi\}$ the result of including every formula of the derivation $\vlder{\Phi}{}{\beta}{\alpha}$ into the context $\xi\vlhole$. Since we adopt deep inference, $\vlder{\xi\{\Phi\}}{}{\xi\{\beta\}}{\xi\{\alpha\}}$ is a valid derivation. Furthermore, $\xi\left\{\vlder{}{}{\beta_1}{\alpha_1}\right\}\cdots\left\{\vlder{}{}{\beta_n}{\alpha_n}\right\}$ denotes
\[
\vlderivation
{
 \vlin{=}{}{\xi\{\beta_1\}\cdots\{\beta_{n-1}\}\left\{\vlder{}{}{\beta_n}{\alpha_n}\right\}}
 {
  \vlin{=}{}{\vdots}
  {
   \vlin{=}{}{\xi\{\beta_1\}\cdots\{\beta_{i-1}\}\left\{\vlder{}{}{\beta_i}{\alpha_i}\right\}\{\alpha_{i+1}\}\cdots\{\alpha_n\}}
   {
    \vlin{=}{}{\vdots}
    {
     \vlhy{\xi\left\{\vlder{}{}{\beta_1}{\alpha_1}\right\}\{\alpha_2\}\cdots\{\alpha_n\}}
    }
   }
  }
 }
}\quad.
\]
\end{defi}

\newcommand{\KS}{\mathsf{KS}}
\newcommand{\SKS}{\mathsf{SKS}}

\newcommand{\ai}{\mathsf{ai}}
\newcommand{\aw}{\mathsf{aw}}
\newcommand{\ac}{\mathsf{ac}}
\newcommand{\aid}{{\ai{\downarrow}}}
\newcommand{\awd}{{\aw{\downarrow}}}
\newcommand{\acd}{{\ac{\downarrow}}}
\newcommand{\aiu}{{\ai{\uparrow}}}
\newcommand{\awu}{{\aw{\uparrow}}}
\newcommand{\acu}{{\ac{\uparrow}}}
\newcommand{\swi}{\mathsf{s}}
\newcommand{\med}{\mathsf{m}}
%---------------------------------------
\begin{defi}
System $\SKS$ in the calculus of structures is defined by the following \emph{structural} rules:
\[
\begin{array}{@{}c@{}c@{}c@{}}
      \vlinf{\aid}{}{\vls[a.{\bar a}]}{\ttt}&
\qquad\vlinf{\awd}{}a\fff&
\qquad\vlinf{\acd}{}a{\vls[a.a]}\\
\noalign{\smallskip}
      \emph{interaction}&
\qquad\emph{weakening}&
\qquad\emph{contraction}\\
\noalign{\bigskip}
      \vlinf{\aiu}{}\fff{\vls(a.{\bar a})}&
\qquad\vlinf{\awu}{}\ttt a&
\qquad\vlinf{\acu}{}{\vls (a.a)}a\\
\noalign{\smallskip}
      \emph{cointeraction}&
\qquad\emph{coweakening}&
\qquad\emph{cocontraction}\\
\end{array}\quad,
\]
and by the two \emph{logical} rules:
\[
\begin{array}{@{}c@{}c@{}}
\vlinf{\swi}{}{\vls[(\alpha.\beta).\gamma]}{\vls(\alpha.[\beta.\gamma])}&\qquad
\vlinf{\med}{}{\vls([\alpha.\gamma].[\beta.\delta])}
              {\vls[(\alpha.\beta).(\gamma.\delta)]}\\
\noalign{\smallskip}
\emph{switch}&\qquad\emph{medial}\\
\end{array}\quad.
\]
The rule cointeraction is also called an (\emph{atomic}) \emph{cut}. In addition to the rules shown, there is a rule $\vldownsmash{\vlinf={}\delta\gamma}$, such that $\gamma$ and $\delta$ are opposite sides in one of the following equations:
\vlstore{
\vls[\alpha.\beta]         &=\vls[\beta.\alpha]         \quad,&
\vls[\alpha.\fff]          &=\vls[\alpha]               \quad,\\
\vls(\alpha.\beta)         &=\vls(\beta.\alpha)         \quad,&
\vls(\alpha.\ttt)          &=\vls(\alpha)               \quad,\\
\vls[[\alpha.\beta].\gamma]&=\vls[\alpha.[\beta.\gamma]]\quad,&
\vls[\ttt.\ttt]            &=\vls[\ttt]                 \quad,\\
\vls((\alpha.\beta).\gamma)&=\vls(\alpha.(\beta.\gamma))\quad,&
\vls(\fff.\fff)            &=\vls(\fff)                 \quad\vldot}
\begin{align*}
\vlread
\end{align*}
We do not always show the instances of rule $=$, and when we do show them, we gather several contiguous instances into one. System $\KS$ is the same as $\SKS$, but without the rules $\aiu$, $\awu$ and $\acu$. A \emph{cut-free} derivation is a derivation where $\aiu$ is not used. All derivations in this paper are in $\SKS$, unless indicated otherwise.
\end{defi}

\begin{rem}
The representations of $\SKS$ derivations in this paper are sometimes ambiguous. This is not a problem, as the derivations themselves are well defined and we can always get a more detailed representation should we need to, for instance when extracting atomic flows from derivations. The ambiguity arises because we omit or collapse equations and because we do not distinguish the different equation rules. In particular we need to know if
\[
\vlinf{=}{}{\vls((a.a).a)}{\vls(a.(a.a))}\quad,
\]
is an application of associativity $\left(\vlinf{=}{}{\vls((a.b).c)}{\vls(a.(b.c))}\right)$ or commutativity $\left(\vlinf{=}{}{\vls((b.c).a)}{\vls(a.(b.c))}\right)$ to be able to map atom occurrences in the premiss to atom occurrences in the conclusion.
\end{rem}

% TODO: find the right place for this example

\begin{exa}\label{ExaFormalismA}
Consider the $\SKS$ derivation
\[
\vls[\vlinf{\acd}{}{a}{\vls[a.a]}.\vlinf{\aiu}{}{\fff}{\vls(\vlinf{\acd}{}{b}{\vls[b.b]}.\bar b)}]\quad,
\]
which is a shorthand for
\[
\vlderivation
{
 \vlin{\aiu}{}{a}
 {
  \vlin{\acd}{}{\vls[a.(b.\bar b)]}
  {
   \vlin{\acd}{}{\vls[a.([b.b].\bar b)]}
   {
    \vlhy{\vls[a.a.([b.b].\bar b)]}
   }
  }
 }
}.
\]
It is implicit in Definition~\ref{DefFormulae} that the ordering of holes in a formula context with multiple holes is given. This decides the order in which we `sequentialise' the short-hand representation of a derivation in Definition~\ref{DefDerivation}. In this example we used a left-to-right ordering, but we could just as well have used a right-to-left ordering:
\[
\vlderivation
{
 \vlin{\acd}{}{a}
 {
  \vlin{\aiu}{}{\vls[a.a]}
  {
   \vlin{\acd}{}{\vls[a.a.(b.\bar b)]}
   {
    \vlhy{\vls[a.a.([b.b].\bar b)]}
   }
  }
 }
}.
\]
In Formalism A, a new deep-inference formalism currently under development, the above shorthand is a representative of the equivalence class containing both the left-to-right and the right-to-left orderings, in addition to the intermediate:
\[
\vlderivation
{
 \vlin{\aiu}{}{a}
 {
  \vlin{\acd}{}{\vls[a.(b.\bar b)]}
  {
   \vlin{\acd}{}{\vls[a.a.(b.\bar b)]}
   {
    \vlhy{\vls[a.a.([b.b].\bar b)]}
   }
  }
 }
}.
\]
For the purposes of this paper, which of these three derivations we use is inessential, as the atomic flows associated with each of them are are the same. For simplicity we let the shorthand above refer to one unique derivation, but we could just as well have worked in Formalism A.
\end{exa}

%===============================================================================

\section{Background on Atomic Flows}

\newbox\contrup\setbox\contrup=\hbox{$
   \divide\atflowunit by5\multiply\atflowunit by3\afsetunits
   \atomicflow{(0,0)*{\afacu{}{}{}{}{}{}}}$}
\newbox\contrdown\setbox\contrdown=\hbox{$
   \divide\atflowunit by5\multiply\atflowunit by3\afsetunits
   \atomicflow{(0,0)*{\afacd{}{}{}{}{}{}}}$}
\newbox\interdown\setbox\interdown=\hbox{$
   \divide\atflowunit by5\multiply\atflowunit by3\afsetunits
   \atomicflow{(0,0)*{\afaid{}{}{}{}{}{}}}$}
\newbox\interup\setbox\interup=\hbox{$
   \divide\atflowunit by5\multiply\atflowunit by3\afsetunits
   \atomicflow{(0,0)*{\afaiu{}{}{}{}{}{}}}$}
\newbox\weakdown\setbox\weakdown=\hbox{$
   \divide\atflowunit by5\multiply\atflowunit by3\afsetunits
   \atomicflow{(0,0)*{\afawd{}{}{}{}{}{}}}$}
\newbox\weakup\setbox\weakup=\hbox{$
   \divide\atflowunit by5\multiply\atflowunit by3\afsetunits
   \atomicflow{(0,0)*{\afawu{}{}{}{}{}{}}}$}
%===============================================================================
\section{Streamlining}

Streamlining is an up-down symmetric generalisation of cut-elimination which applies to derivations as well as proofs. We recall the definition from \cite{GuglGund:07:Normalis:lr}:

%---------------------------------------
\begin{defi}
An $\SKS$ derivation is \emph{streamlined} if, in its associated atomic flow, there are no paths from interaction or weakening vertices to cointeraction or coweakening vertices.
\end{defi}

%---------------------------------------
\begin{rem}\label{RemStr}
It immediately follows from the definition that the diagram below describes the shape of a streamlined derivation:
\[
\atomicflow{
(-10,11)*{\afvjm4};
%---
(-15, 5)*{\copy\contrup};
(-10, 5)*{\affr{28}8};
( -5, 5)*{\copy\contrdown};
( 10, 5)*{\copy\interdown};
( 10, 5)*{\affr88};
( 20, 5)*{\copy\weakdown};
( 20, 5)*{\affr88};
%---
(-20, 0)*{\afvjm2};
(-10, 0)*{\afvjm2};
(  0, 0)*{\afvjm2};
( 10, 0)*{\afvjm2};
( 20, 0)*{\afvjm2};
%---
(-20,-5)*{\copy\weakup};
(-20,-5)*{\affr88};
(-10,-5)*{\copy\interup};
(-10,-5)*{\affr88};
(  5,-5)*{\copy\contrup};
( 10,-5)*{\affr{28}8};
( 15,-5)*{\copy\contrdown};
%---
(  10,-11)*{\afvjm4};
}\quad.
\]
\end{rem}

From our point of view, the main challenge in streamlining a derivation is to make sure there are no paths from axioms to cuts. Once this is achieved it is straightforward to use (confluent and strongly normalising) weakening reductions to obtain a streamlined derivation. This motivates the following definition:

%---------------------------------------
\begin{defi}
An $\SKS$ derivation is \emph{weakly streamlined} if, in its associated atomic flow, there are no paths from interaction vertices to cointeraction vertices.
\end{defi}

%---------------------------------------
\begin{rem}\label{RemStr}
It immediately follows from the definition that the diagram below describes the shape of a weakly streamlined derivation:
\[
\atomicflow{
(-5, 11)*{\afvjm4};
%---
( -5, 5)*{\affr{18}8};
(-10, 5)*{\copy\contrup};
( -5, 5)*{\copy\weakdown};
(  0, 5)*{\copy\contrdown};
( 10, 5)*{\affr88};
( 10, 5)*{\copy\interdown};
%---
(-10, 0)*{\afvjm2};
(  0, 0)*{\afvjm2};
( 10, 0)*{\afvjm2};
%---
(-10,-5)*{\affr88};
(-10,-5)*{\copy\interup};
(  5,-5)*{\affr{18}8};
(  0,-5)*{\copy\contrup};
(  5,-5)*{\copy\weakup};
( 10,-5)*{\copy\contrdown};
%---
(  5,-11)*{\afvjm4};
}\quad.
\]
\end{rem}

\subsection{The Core}

As a consequence of having atomic structural inference rules, deep inference allows us to trivially assume that all axioms happen in the premiss and all cuts happen in the conclusion of the derivation. Furthermore, we can (co)contract axioms and cuts so that every atom occurs in at most one axiom and at most one cut. If a derivation, $\Phi$, has this shape we can obtain a weakly streamlined derivation simply by considering all the atoms which occur in both an axiom and a cut and replacing the axiom and the cut by their conclusion and premiss respectively. This weakly streamlined derivation, clearly does not have the same premiss and conclusion as $\Phi$, but, as will be made precise later, their atomic flows are almost the same and for this reason we call this the \emph{core of $\Phi$}. The core will be the building block we will use to build a weakly streamlined derivation with the same premiss and conclusion as $\Phi$.

\newcommand{\Core}{\mathsf{Core}}

\begin{defi}\label{DefFlowCore}
Given an atomic flow
\[
A=\atomicflow
{
(-21, 8.5)*{\afvjm{9}};
(-13, 8)*{\afaidm{}{}{}{}{}{}};
( -5, 8.5)*{\afvjm{9}};
(-18, 0)*{\affr{8}{8}};
(-16, 2)*{a_1};
( -8, 0)*{\affr{8}{8}};
( -6, 2)*{\bar a_1};
( -5,-8.5)*{\afvjm{9}};
(-13,-8)*{\afaium{}{}{}{}{}{}};
(-21,-8.5)*{\afvjm{9}};
%------------
(0,0)*{\cdots};
%------------
(21, 8.5)*{\afvjm{9}};
(13, 8)*{\afaidm{}{}{}{}{}{}};
( 5, 8.5)*{\afvjm{9}};
( 8, 0)*{\affr{8}{8}};
(10, 2)*{a_n};
(18, 0)*{\affr{8}{8}};
(20, 2)*{\bar a_n};
( 5,-8.5)*{\afvjm{9}};
(13,-8)*{\afaium{}{}{}{}{}{}};
(21,-8.5)*{\afvjm{9}};
%------------
(33, 11)*{\afvjm4};
%---
( 33, 5)*{\affr{18}8};
( 28, 5)*{\copy\contrup};
( 33, 5)*{\copy\weakdown};
( 38, 5)*{\copy\contrdown};
( 48, 5)*{\affr88};
( 48, 5)*{\copy\interdown};
%---
( 28, 0)*{\afvjm2};
( 38, 0)*{\afvjm2};
( 48, 0)*{\afvjm2};
%---
( 28,-5)*{\affr88};
( 28,-5)*{\copy\interup};
( 43,-5)*{\affr{18}8};
( 38,-5)*{\copy\contrup};
( 43,-5)*{\copy\weakup};
( 48,-5)*{\copy\contrdown};
%---
( 43,-11)*{\afvjm4};
}\quad,
\]
the \emph{core of $A$} is defined to be
\[
\Core(A)=
\atomicflow
{
(-21,10)*{\afvjm{12}};
(-17,15)*{\afvj2};
(-17,10)*{\affr{6}{8}};
(-17,10)*{\copy\contrup};
(-17, 5)*{\afvjm{2}};
(-18, 0)*{\affr{8}{8}};
(-16, 2)*{a_1};
(-21,-10)*{\afvjm{12}};
(-17,-15)*{\afvj2};
(-17,-10)*{\affr{6}{8}};
(-17,-10)*{\copy\contrdown};
(-17, -5)*{\afvjm{2}};
%
( -9,15)*{\afvj2};
( -9,10)*{\affr{6}{8}};
( -9,10)*{\copy\contrup};
( -9, 5)*{\afvjm{2}};
( -5,10)*{\afvjm{12}};
( -8, 0)*{\affr{8}{8}};
( -6, 2)*{\bar a_1};
( -9,-15)*{\afvj2};
( -9,-10)*{\affr{6}{8}};
( -9,-10)*{\copy\contrdown};
( -9, -5)*{\afvjm{2}};
( -5,-10)*{\afvjm{12}};
( -8, 0)*{\affr{8}{8}};
%------------
(0,0)*{\cdots};
%------------
( 9,15)*{\afvj2};
( 9,10)*{\affr{6}{8}};
( 9,10)*{\copy\contrup};
( 9, 5)*{\afvjm{2}};
( 5,10)*{\afvjm{12}};
( 8, 0)*{\affr{8}{8}};
(10, 2)*{a_n};
( 9,-15)*{\afvj2};
( 9,-10)*{\affr{6}{8}};
( 9,-10)*{\copy\contrdown};
( 9, -5)*{\afvjm{2}};
( 5,-10)*{\afvjm{12}};
( 8, 0)*{\affr{8}{8}};
%
(21,10)*{\afvjm{12}};
(17,15)*{\afvj2};
(17,10)*{\affr{6}{8}};
(17,10)*{\copy\contrup};
(17, 5)*{\afvjm{2}};
(18, 0)*{\affr{8}{8}};
(20, 2)*{\bar a_n};
(21,-10)*{\afvjm{12}};
(17,-15)*{\afvj2};
(17,-10)*{\affr{6}{8}};
(17,-10)*{\copy\contrdown};
(17, -5)*{\afvjm{2}};
%---------
(33, 12.5)*{\afvjm7};
%---
( 33, 5)*{\affr{18}8};
( 28, 5)*{\copy\contrup};
( 33, 5)*{\copy\weakdown};
( 38, 5)*{\copy\contrdown};
( 48, 5)*{\affr88};
( 48, 5)*{\copy\interdown};
%---
( 28, 0)*{\afvjm2};
( 38, 0)*{\afvjm2};
( 48, 0)*{\afvjm2};
%---
( 28,-5)*{\affr88};
( 28,-5)*{\copy\interup};
( 43,-5)*{\affr{18}8};
( 38,-5)*{\copy\contrup};
( 43,-5)*{\copy\weakup};
( 48,-5)*{\copy\contrdown};
%---
( 43,-12.5)*{\afvjm7};
}\quad,
\]
where the subflow of $A$ labelled $a_i$ (resp., $\bar a_i$) is isomorphic to the sublfow of $\Core(A)$ labelled $a_i$ (resp., $\bar a_i$) for every $1\leq i\leq n$ and the rightmost subflow of $A$ is isomorphic to the rightmost sublfow of $\Core(A)$.
\end{defi}

\begin{defi}\label{DefCore}
Given a derivation $\vlder{\Phi}{}{\beta}{\alpha}$ with associated atomic flow $A$, a \emph{core of\/ $\Phi$} is defined to be a derivation $\vlder{\Core(\Phi)}{}{\vls[\beta.(a_n.{\bar a_n}).\cdots.(a_1.{\bar a_1})]}{\vls([a_1.{\bar a_1}].\cdots.[a_n.{\bar a_n}].\alpha)}$ with associated atomic flow $\Core(A)$.
\end{defi}

\begin{pro}\label{PropStreamlinedCore}
Any $\Core(\Phi)$ is weakly streamlined.
\end{pro}

\begin{lem}\label{LemSuperSwitch}
Given a context $\xi\vlhole$ and a formula $\alpha$ there exist derivations $\vlder{}{\{\swi\}}{\xi\{\alpha\}}{\vls(\alpha.\xi\{\ttt\})}$ and $\vlder{}{\{\swi\}}{\vls[\xi\{\fff\}.\alpha]}{\xi\{\alpha\}}$.
\end{lem}

\begin{proof}
We show how to construct the first derivation, the second one can be done by symmetry. We argue by induction on the number of atoms in $\xi\vlhole$. The base case, $\xi\vlhole=\vlhole$, is trivial and the inductive cases are:

\[
\vlderivation
{
 \vlin{=}{}{\xi\{\alpha\}}
 {
  \vlin{\swi}{}{\vls[\vlder{\Psi}{\{\swi\}}{\xi'\{\alpha\}}{\vls(\alpha.\xi'\{\ttt\})}.\beta]}
  {
   \vlin{=}{}{\vls(\alpha.[\xi'\{\ttt\}.\beta])}
   {
    \vlhy{\vls(\alpha.\xi\{\ttt\})}
   }
  }
 }
}\qquad\mbox{and}\qquad
\vlderivation
{
 \vlin{=}{}{\xi\{\alpha\}}
 {
  \vlin{=}{}{\vls(\vlder{\Psi'}{\{\swi\}}{\xi'\{\alpha\}}{\vls(\alpha.\xi'\{\ttt\})}.\beta)}
  {
   \vlhy{\vls(\alpha.\xi\{\ttt\})}
  }
 }
}\quad,
\]
for some $\xi'\vlhole$ and $\beta$ where $\beta$ is not a unit and $\Psi$ and $\Psi'$ exist by the inductive hypothesis.
\end{proof}

\begin{lem}\label{LemDecompInt}
Given a derivation $\vlder{}{}{\beta}{\alpha}$ with associated atomic flow $A$, there exists a derivation
\[
\vlder{}{\SKS\setminus\{\aid,\aiu\}}{\vls[\beta.\vlinf{\aiu}{}{\fff}{\vls(b_m.\bar b_m)}.\cdots.\vlinf{\aiu}{}{\fff}{\vls(b_1.\bar b_1)}]}{\vls(\vlinf{\aid}{}{\vls[a_1.\bar a_1]}{\ttt}.\cdots.\vlinf{\aid}{}{\vls[a_n.\bar a_n]}{\ttt}.\alpha)}
\]
with associated atomic flow $A$, for some atoms $a_1,\dots,a_n,b_1,\dots,b_m$.
\end{lem}

\begin{proof}
Using Lemma~\ref{LemSuperSwitch} apply the following transformations to each of the (co)interaction instances in $\Phi$:
\[
\vlderivation
{
 \vlde{\Psi'}{}{\delta}
 {
  \vlin{\aid}{}{\xi\vlsbr[a.{\bar a}]}
  {
   \vlde{\Psi}{}{\xi\{\ttt\}}
   {
    \vlhy{\gamma}
   }
  }
 }
}\quad\rightarrow\quad
\vlderivation
{
 \vlde{\Psi'}{}{\delta}
 {
  \vlde{}{\{\swi\}}{\xi\vlsbr[a.{\bar a}]}
  {
   \vlhy{\vlsbr(\vlinf{\aid}{}{\vls[a.{\bar a}]}{\ttt}.\vlder{\Psi}{}{\xi\{\ttt\}}{\gamma})}
  }
 }
}\qquad\mbox{and}\qquad
\vlderivation
{
 \vlde{\Psi'}{}{\delta}
 {
  \vlin{\aid}{}{\xi\{\fff\}}
  {
   \vlde{\Psi}{}{\xi\vlsbr(a.{\bar a})}
   {
    \vlhy{\gamma}
   }
  }
 }
}\quad\rightarrow\quad
\vlderivation
{
 \vlde{}{\{\swi\}}{\vlsbr[\vlder{\Psi'}{}{\delta}{\xi\{\fff\}}.\vlinf{\aiu}{}{\fff}{\vls(a.{\bar a})}]}
 {
  \vlde{\Psi}{}{\xi\vlsbr(a.{\bar a})}
  {
   \vlhy{\gamma}
  }
 }
}\quad.
\]
\end{proof}

\begin{lem}\label{LemGenericContraction}
Given a formula $\alpha$ and a positive integer $n$, there exist derivations $\vlder{}{\{\acd,\med\}}{\alpha}{\bigvee_{i=1}^{n}\alpha}$ and $\vlder{}{\{\acu,\med\}}{\bigwedge_{i=1}^{n}\alpha}{\alpha}$.
\end{lem}

\begin{thm}
Given any derivation $\vlder{\Phi}{}{\beta}{\alpha}$, $\Core(\Phi)$ exists.
\end{thm}

\begin{proof}
We build $\Core(\Phi)$ as follows:
\[
\vlderivation
{
 \vlde{\Psi_2}{\{\acd,\med\}}{\vls[\beta.(a_n.{\bar a_n}).\cdots.(a_1.{\bar a_1})]}
 {
  \vlde{\Phi'}{\SKS\setminus\{\aid,\aiu\}}{{\vls[\beta.\vlinf{\aiu}{}{\fff}{\vls(c_l.\bar c_l)}.\cdots.\vlinf{\aiu}{}{\fff}{\vls(c_1.\bar c_1)}.(a_n.\bar a_n).\cdots.(a_n.\bar a_n).\cdots.(a_1.\bar a_1).\cdots.(a_1.\bar a_1)]}}
  {
   \vlde{\Psi_1}{\{\acu,\med\}}{{\vls([a_1.\bar a_1].\cdots.[a_1.\bar a_1].\cdots.[a_n.\bar a_n].\cdots.[a_n.\bar a_n].\vlinf{\aid}{}{\vls[b_1.\bar b_1]}{\ttt}.\cdots.\vlinf{\aid}{}{\vls[b_k.\bar b_k]}{\ttt}.\alpha)}}
   {
    \vlhy{\vls([a_1.{\bar a_1}].\cdots.[a_n.{\bar a_n}].\alpha)}
   }
  }
 }
}\quad,
\]
where $a_1,\dots,a_n$ are distinct and pairwise non-dual atoms and there are no atoms in common between $b_1,\dots,b_k$ and their duals and $c_1,\dots,c_l$ and their duals, $\Phi'$ exists by Lemma~\ref{LemDecompInt} and $\Psi_1$ and $\Psi_2$ exist by Lemma~\ref{LemGenericContraction}.
\end{proof}


\subsection{The Normaliser}

We now show how to build a weakly streamlined derivation. We present a `skeleton' with black boxes where we can plug the core of the derivation we want to normalise. The novelty of this method is that no knowledge of the shape of the core is required. The only information needed to build the normaliser is the number of atoms which occur in both axioms and cuts in the original derivation. The procedure is strongly normalising, but not confluent. Two kinds of choices have to be made, the order in which the atoms are eliminated and for each atom which comes first, $a$ or $\bar a$, all these choices will change the shape of the resulting derivation and atomic flow.

\newcommand{\contr}{\mathsf{c}}
\newcommand{\cod}{{\contr{\downarrow}}}
\newcommand{\cou}{{\contr{\uparrow}}}

\begin{rem}
In the non-atomic version of system $\SKS$ the derivations shown in Lemma~\ref{LemGenericContraction} correspond to repeated applications of (co)contractions. For this reason we sometimes write the inference rules $\vlinf{\cod}{}{\alpha}{\vls[\alpha.\alpha]}$ and $\vlinf{\cou}{}{\vls(\alpha.\alpha)}{\alpha}$ instead of the derivations $\vlder{}{\{\acd,\med\}}{\alpha}{\vls[\alpha.\alpha]}$ and $\vlder{}{\{\acu,\med\}}{\vls(\alpha.\alpha)}{\alpha}$.
\end{rem}

\newcommand{\Norm}{\mathsf{Norm}}

\begin{defi}
The \emph{normaliser}, $\Norm(\Phi,a_1,\dots,a_n)$, is an operator taking as input a sequence of atoms and a derivation of the form
\[
\vlder{\Phi}{}{\vls[\beta.(a_n.{\bar a_n}).\cdots.(a_1.{\bar a_1})]}{\vls([a_1.{\bar a_1}].\cdots.[a_n.{\bar a_n}].\alpha)}\quad,
\]
where $\alpha$ and $\beta$ are formulae and returning a derivation of the form
\[
\vlder{\Norm(\Phi,a_1,\dots,a_n)}{}{\beta}{\alpha}\quad.
\]

We define $\Norm$ inductively on the number of arguments. Let $\Norm(\Phi)=\Phi$ and for $n>0$ let $\Norm(\Phi,a_1,\dots,a_n)$ be
\newbox\DeltaTopK
\setbox\DeltaTopK=
\hbox{$
\vlderivation
{
 \vlde{\Norm(\Phi,a_1,\dots,a_{n-1})}{}{\vls[\beta.(\vlinf{\awu}{}{\ttt}{a_n}.\bar a_n)]}
 {
  \vlhy{\vls(\vlinf{\aid}{}{\vls[a_n.\bar a_n]}{\ttt}.\alpha)}
 }
}$
}
\newbox\DeltaBotK
\setbox\DeltaBotK=
\hbox{
$\vlderivation
{
 \vlde{\Norm(\Phi,a_1,\dots,a_{n-1})}{}{\vls[\beta.\vlinf{\aiu}{}{\fff}{\vls(a_n.\bar a_n)}]}
 {
  \vlhy{\vls([a_n.\vlinf{\awd}{}{\bar a_n}{\fff}].\alpha)}
 }
}$
}
\newbox\DeltaK
\setbox\DeltaK=
\hbox{$
\vlderivation
{
 \vlde{\Norm(\Phi,a_1,\dots,a_{n-1})}{}{\vls[\beta.(a_n.\vlinf{\awu}{}{\ttt}{\bar a_n})]}
 {
  \vlhy{\vls([\vlinf{\awd}{}{a_n}{\fff}.\bar a_n].\alpha)}
 }
}$
}
\[
\vlderivation
{
 \vlin{\cod}{}{\beta}
 {
  \vlin{\swi}{}{\vls[\vlinf{\cod}{}{\beta}{\vls[\beta.\beta]}.\box\DeltaBotK]}
  {
   \vlin{\swi}{}{\vls([\beta.\box\DeltaK].\alpha)}
   {
    \vlin{\cou}{}{\vls(\box\DeltaTopK.\vlinf{\cou}{}{\vls(\alpha.\alpha)}{\alpha})}
    {
     \vlhy{\alpha}
    }
   }
  }
 }
}\quad.
\]
\end{defi}

\begin{pro}\label{PropFlowNorm}
If the atomic flow of
\[\vlder{\Norm(\Phi,a_1,\dots,a_{n-1})}{}{\vls[\beta.(a_n.\bar a_n)]}{\vls([a_n.\bar a_n].\alpha)}
\quad\mbox{is}\quad
\atomicflow
{
(-8, 6)*{\afvjm{4}};
(-2, 6)*{\afvju{4}{a_n}{}};
( 2, 6)*{\afvju{4}{}{\bar a_n}};
( 8, 6)*{\afvjm{4}};
(-5, 0)*{\affr{8}{8}};
(-3, 2)*{A};
( 5, 0)*{\affr{8}{8}};
( 7, 2)*{B};
( 8,-6)*{\afvjm{4}};
(-2,-6)*{\afvjd{4}{a_n}{}};
( 2,-6)*{\afvjd{4}{}{\bar a_n}};
(-8,-6)*{\afvjm{4}};
}\quad,
\]
then the atomic flow of
\[
\vlder{\Norm(\Phi,a_1,\dots,a_n)}{}{\beta}{\alpha}
\quad\mbox{is}\quad
\atomicflow
{
% cocontractions
%  outer
(-13.5,36.5)*{\afacumexsqcol{}{}{}{}{}{}{33}{4}{}{Green}{Green}};
(  2.5,36.5)*{\afacumexsqcol{}{}{}{}{}{}{33}{4}{}{Green}{Green}};
%  inner
( -8, 13)*{\afvjmcol{18}{Green}};
( 14,  0)*{\afvjmcol{44}{Green}};
(  3, 26)*{\afacumnwexsqcol{}{}{}{}{11}{2}{Green}{Green}};
(  8, 13)*{\afvjm{18}};
( 30, 0)*{\afvjmcol{44}{Green}};
( 19, 26)*{\afacumnwexsqcol{}{}{}{}{11}{2}{}{Green}};
% top boxes
(-22, 34)*{\afaidcol{}{}{}{}{}{}{Red}{Red}};
(-27, 26)*{\affr{8}{8}};
(-25, 28)*{A_1};
(-17, 26)*{\affr{8}{8}};
(-15, 28)*{B_1};
(-24, 18)*{\afawucol{}{}{}{}{}{Red}};
( -9, 13)*{\afcjlcol{22}{18}{Red}};
% middle boxes
( -2,  8)*{\afawdcol{}{}{}{}{}{Green}};
(-5, 0)*{\affr{8}{8}};
(-3, 2)*{A_2};
( 5, 0)*{\affr{8}{8}};
( 7, 2)*{B_2};
(  2, -8)*{\afawucol{}{}{}{}{}{Red}};
% bottom boxes
( 22,-34)*{\afaiucol{}{}{}{}{}{}{Green}{Green}};
( 17,-26)*{\affr{8}{8}};
( 19,-24)*{A_3};
( 27,-26)*{\affr{8}{8}};
( 29,-24)*{B_3};
( 24,-18)*{\afawdcol{}{}{}{}{}{Green}};
(  9,-13)*{\afcjlcol{22}{18}{Green}};
% contractions
%  inner
( -8,-12.75)*{\afvjm{17.5}};
(-30,0.25)*{\afvjmcol{43.5}{Red}};
(-19,-27.5)*{\afacdmnwexsqcol{}{}{}{}{11}{2}{Red}{}};
(  8,-12.75)*{\afvjmcol{17.5}{Red}};
(-14,0.25)*{\afvjmcol{43.5}{Red}};
( -3,-27.5)*{\afacdmnwexsqcol{}{}{}{}{11}{2}{Red}{Red}};
%  outer
( 13.5,-36)*{\afacdmexsqcol{}{}{}{}{}{}{33}{4}{Red}{}{Red}};
( -2.5,-36)*{\afacdmexsqcol{}{}{}{}{}{}{33}{4}{Red}{}{Red}};
}\quad,
\]
where $A_1,A_2,A_3$ are isomorphic to $A$ and $B_1,B_2,B_3$ are isomorphic to $B$ and all the edges that might be in paths from the evidenced interaction vertex are colored in red and all the edges that might be in paths from the evidenced cointeraction node are colored in green.
\end{pro}

\begin{lem}\label{LemStreamlinedNorm}
Given a derivation $\Phi$ containing the atoms $a_1,\dots,a_n$ such that\/ $\Norm(\Phi,a_1,\dots,a_{k-1})$ and\/ $\Norm(\Phi,a_1,\dots,a_k)$ exist for some $0\leq k\leq n$, if\/ $\Norm(\Phi,a_1,\dots,a_{k-1})$ is weakly streamlined and none of the atoms $a_k,\dots,a_n$ occur in interaction nor cointeraction instances in\/ $\Norm(\Phi,a_1,\dots,a_{k-1})$ then
\begin{itemize}
 \item none of the atoms $a_{k+1},\dots,a_n$ occur in interaction nor cointeraction instances in $\Norm(\Phi,a_1,\dots,a_k)$ and
 \item $\Norm(\Phi,a_1,\dots,a_n)$ is weakly streamlined.
\end{itemize}
\end{lem}

\begin{proof}
Refer to the atomic flow in Proposition~\ref{PropFlowNorm} to observe the following:
\begin{itemize}
 \item The only atoms which occur in (co)interaction instances in $\Norm(\Phi,a_1,\dots,a_k)$ which did not in $\Norm(\Phi,a_1,\dots,a_{k-1})$ are $a_k$ and $\bar a_k$.
 \item The only interaction and cointeraction nodes mapped to by $a_k$ in the atomic flow associated with $\Norm(\Phi,a_1,\dots,a_k)$ are the once that are evidenced and since the red and the green edges never coincide there can be no path between them. Furthermore, since $\Norm(\Phi,a_1,\dots,a_{k-1})$ is weakly streamlined a path from an interaction to a cointeraction vertex in the atomic flow associated with $\Norm(\Phi,a_1,\dots,a_k)$ must contain the red edge between $B_1$ and $B_2$ or the green edge between $A_2$ and $A_3$. However, $a_k$ and $\bar a_k$ map to these edges so there can be no path from an interaction to a cointeraction vertex.
\end{itemize}
\end{proof}

\begin{thm}
Given a derivation $\vlder{\Phi}{}{\beta}{\alpha}$, there are atoms $a_1,\dots,a_n$ in $\Phi$ such that $\vlder{\Norm(\Core(\Phi),a_1,\dots,a_n)}{}{\beta}{\alpha}$ is weakly streamlined.
\end{thm}

% TODO: check for style

\begin{proof}
Choose $a_1,\dots,a_n$ and their duals such that no other atom maps to a path from an interaction to a cointeraction node in the atomic flow associated with $\Phi$, then the result follows by Proposition~\ref{PropStreamlinedCore} and Lemma~\ref{LemStreamlinedNorm}.
\end{proof}

%===========================================

\section{Conclusion}


\bibliographystyle{alpha}
\bibliography{di-biblio}

\end{document}