\documentclass[a4paper]{amsart}

\usepackage[lutzsyntax]{virginialake}\aftrianglefalse
\usepackage[urw-garamond]{mathdesign} % Comment this to use Times fonts
  \expandafter\ifx\csname leqslant\endcsname\relax\usepackage{txfonts}\fi
\usepackage[pdfborder={0 0 0}]{hyperref}
%\usepackage[dvipsnames,usenames]{color}
%\usepackage{draftwatermark}

%-------------------------------------------

\hyphenation{co-weak-en-ing}
\hyphenation{La-mar-che}
\hyphenation{quasi-poly-no-mial}

\renewcommand{\le}{\leqslant}
\renewcommand{\ge}{\geqslant}

%-------------------------------------------

\newtheorem{theorem}{Theorem}[section]
\newtheorem{lemma}[theorem]{Lemma}
\newtheorem{proposition}[theorem]{Proposition}

\theoremstyle{definition}
\newtheorem{definition}[theorem]{Definition}
\newtheorem{example}[theorem]{Example}

\theoremstyle{remark}
\newtheorem{remark}[theorem]{Remark}
%-------------------------------------------

\begin{document}

\title{Normalisation Control in Deep Inference \\ via Atomic Flows II}

\author{Alessio Guglielmi}
\address{University of Bath, Bath BA2 7AY, UK \and INRIA, Nancy-Grand Est, France}
\thanks{Guglielmi is supported by EPSRC grant EP/E042805/1 \emph{Complexity and Non-determinism in Deep Inference} and by an ANR \emph{Senior Chaire d'Excellence} titled \emph{Identity and Geometric Essence of Proofs}.}

\author{Tom Gundersen}
\address{University of Bath, Bath BA2 7AY, UK}
\thanks{Gundersen is supported by an \emph{Overseas Research Scholarship} and a \emph{Research Studentship} both of the University of Bath.}



%===============================================================================

\maketitle

%===============================================================================
\section{Introduction}

%TODO: say something clever at the start of the second sentence

We are interested in the normalisation of deep-inference derivations in propositional classical logic. Cuts are admissible from proofs and, dually, identities are admissible from contradictions. However, neither are admissible from derivations. We therefore work with \emph{streamlining}, introduced in \cite{GuglGund:07:Normalis:lr}, a new, symmetric, notion of normalisation for derivations, which generalises both cut and identity elimination.

At the core of our work lie \emph{atomic flows}, which were introduced in \cite{GuglGund:07:Normalis:lr}. Atomic flows are graphs, similar to Buss flow graphs \cite{Buss:91:The-Unde:uq} and proof nets \cite{Gira:87:Linear-L:wm}, obtained from derivations by tracing their atom occurrences and forgetting everything except how atoms are created, copied, contracted and destroyed. Atomic flows are largely syntax independent and bureaucracy free (in the sense of Girard \cite{Gira:89:Geometry:sh}). We have shown how atomic flows are useful in defining new normal forms for derivations and in arguing about normalisation.

In particular, streamlining was defined based on atomic flows. Intuitively, a derivation is streamlined if every path in the associated atomic flow can be extended to reach the top or the bottom of the flow. Seen from the point of view of derivations it means; given an atom occurrence in a streamlined derivation, either all possible ways of tracing the atom upwards will reach the premiss or all possible ways of tracing the atom downwards will reach the conclusion. Since a proof has no atoms in its premiss (only the unit `true'), tracing atom occurrences upwards from a cut can not lead to the premiss. Hence, a streamlined proof is cut free.

In this paper, we present a new streamlining procedure. Similarly to our previous result the procedure is based on a particular way of gluing together pieces of derivation, which is possible due to the symmetries of deep inference. However, the novelty is that much less information about the atomic flow associated with the derivation is used to guide the procedure. In particular, we only need to know which identities are connected with which cuts. Since we use less information, all the identities and cuts we are eliminating are indistinguishable, so, unlike the previous procedures, no strategy for streamlining is necessary.

Contrary to what one might expect from cut elimination, the complexity of the procedure is not determined by the number of cuts being eliminated. The complexity is $O(2^n)$, where $n$ is the number of atoms which occur in at least one of the cuts we eliminate. In particular, every step of the procedure eliminate all the cuts where a given atom occurs, making termination a triviality.

We present our streamlining procedure as an operator, called the \emph{normaliser}. The normaliser can be thought of as a `shape' with holes. To streamline a derivation, it is inserted into the holes of the normaliser and the atoms of the derivation are associated with parts of the shape. We can observe that features of the shape are analogous to properties of a normalisation procedure. The fact that the shape is finite gives termination, its size givse the complexity, its asymmetries gives non-determinism, etc.

\newcommand{\SKS}{\mathsf{SKS}}
The results in this paper are presented in the deep-inference formalism the calculus of structures \cite{Gugl:06:A-System:kl}, in particular system $\SKS$ \cite{BrunTiu:01:A-Local-:mz,Brun:04:Deep-Inf:rq}, but we strive at generality and it should not be difficult to adapt our results to any deep-inference formalism and any propositional system as long as we have atomic structural rules and linear logical rules (something we always expect in deep inference and something which is not achievable elsewhere).

In the future, we believe it will be possible to improve on these results by extending them to modal \cite{Brun:07:Deep-Seq:fk,HeinStew:05:Purity-T:tg,StewStou:05:A-System:tg,Stou:06:A-Deep-I:rt} and first order \cite{Brun:04:Deep-Inf:rq,Brun:06:Cut-Elim:cq} logics and by making the procedure quasipolynomial, along the lines of a quasipolynomial cut-elimination procedure we are working on.

%===============================================================================
\section{Propositional Logic in Deep Inference}\label{SectDI}

In the range of the deep-inference methodology, we can define several formalisms, \emph{i.e.} general prescriptions on how to design proof systems. For example, the sequent calculus and natural deduction are formalisms in Gentzen-style proof theory, where the structure of proofs is determined by the tree structure of the formulae they prove.

The first, and conceptually simplest, formalism that has been defined in deep inference is called the \emph{calculus of structures}, or \emph{CoS} \cite{Gugl:06:A-System:kl}. CoS is now well developed for classical \cite{Brun:03:Atomic-C:oz,Brun:06:Cut-Elim:cq,Brun:06:Locality:zh,BrunTiu:01:A-Local-:mz,Brun:06:Deep-Inf:qy}, intuitionistic \cite{Tiu:06:A-Local-:gf}, linear \cite{Stra:02:A-Local-:ul,Stra:03:MELL-in-:oy}, modal \cite{Brun::Deep-Seq:ay,GoreTiu:06:Classica:uq,Stou:06:A-Deep-I:rt} and com\-mu\-ta\-tive/non-commutative logics \cite{Gugl:06:A-System:kl,Tiu:06:A-System:ai,Stra:03:Linear-L:lp,Brus:02:A-Purely:wd,Di-G:04:Structur:wy,GuglStra:01:Non-comm:rp,GuglStra:02:A-Non-co:lq,GuglStra:02:A-Non-co:dq,Kahr:06:Reducing:hc,Kahr:07:System-B:fk}.

%TODO: do not focus on complexity
The standard proof system of propositional logic in CoS is called $\SKS$. The basic proof-complexity properties of $\SKS$, and, as a consequence, of propositional logic in CoS, have been studied in \cite{BrusGugl:07:On-the-P:fk}:
\begin{itemize}
%---------------------------------------
\item $\SKS$ is polynomially equivalent to Frege proof systems.
%---------------------------------------
\item $\SKS$ can be extended with Tseitin's extension and substitution, and the proof systems so obtained are polynomially equivalent to Frege proof systems augmented by extension and substitution.
%---------------------------------------
\item Analytic $\SKS$ polynomially simulates analytic Gentzen proof systems, but the converse does not hold: in fact, Statman's tautologies admit polynomial proofs in analytic $\SKS$ but, as is well known, only exponential ones in analytic Gentzen \cite{Stat:78:Bounds-f:fj}.
%---------------------------------------
\end{itemize}

%TODO: do not talk about threshold formulae
In this paper, we work in CoS and $\SKS$, but we introduce a new notation for CoS. We do so to conveniently describe certain derivations related to threshold formulae, which would seem very cumbersome otherwise (we mainly have in mind Definition~\ref{DefThrDer}). In related work, we are defining a new formalism, currently dubbed \emph{Formalism A}, which generalises CoS and formally allows for the new notation.

In this section, we quickly introduce all the necessary notions. The standard reference for $\SKS$ in CoS and its typical constructions is \cite{Brun:04:Deep-Inf:rq}.

\newcommand{\fff}{\mathsf f}
\newcommand{\ttt}{\mathsf t}
\emph{Formulae}, denoted by $\alpha$, $\beta$, $\gamma$ and $\delta$ are freely built from: \emph{units}, $\fff$ (false), $\ttt$ (true); \emph{atoms}, denoted by $a$, $b$, $c$, $d$ and $e$; \emph{disjunction} and \emph{conjunction}, ${\vlsbr[\alpha.\beta]}$ and $\vlsbr(\alpha.\beta)$. The different brackets have the only purpose of improving legibility; we usually omit external brackets of formulae, and sometimes we omit superfluous brackets under associativity. On the set of atoms a (non-identical) involution $\bar\cdot$ is defined and called \emph{negation}; $a$ and $\bar a$ are \emph{dual} atoms. We denote \emph{contexts}, \emph{i.e.}, formulae with a hole, by $\xi\vlhole$ and $\zeta\vlhole$; for example, if $\xi\vlscn[a]$ is $\vls(b.[a.c])$, then $\xi\vlhole$ is $\vls(b.[\vlhole.c])$, $\xi\{b\}$ is $\vls(b.[b.c])$ and $\xi\vlscn(a.d)$ is $\vls(b.[(a.d).c])$.

Note that negation is only defined for atoms, and this is not a limitation because, thanks to De Morgan laws, negation can always be `pushed to' atoms. Also, note that there are no negative or positive atoms in an absolute sense; we can only say that if we arbitrarily consider $\bar a$ positive, then $a$ must be negative, for example.

A CoS (\emph{inference}) \emph{rule} $\rho$ is an expression $\vlinf\rho{}\beta\alpha$, where the formulae $\alpha$ and $\beta$ are called \emph{premiss} and \emph{conclusion}, respectively; an inference rule \emph{instance} $\vlupsmash{\vlinf\rho{}\delta\gamma}$, where $\gamma$ and $\delta$ are instances of $\alpha$ and $\beta$, respectively, generates an (\emph{inference}) \emph{step} $\vlinf\rho{}{\xi\vlscn[\delta]}{\xi\vlscn[\gamma]}$, for each context $\xi\vlhole$. A \emph{derivation}, $\Phi$, \emph{from} $\alpha$ (\emph{premiss}) \emph{to} $\beta$ (\emph{conclusion}) is a chain of inference steps with $\alpha$ at the top and $\beta$ at the bottom, and is usually indicated by $\vlder\Phi{\mathcal S}{\beta}{\alpha}$, where $\mathcal S$ is the name of the proof system or a set of inference rules (we might omit $\Phi$ and $\mathcal S$); a \emph{proof}, often denoted by $\Pi$, is a derivation with premiss $\ttt$; besides $\Phi$, we denote derivations with $\Psi$.

\newcommand{\ai  }{\mathsf{ai}}
\newcommand{\aw  }{\mathsf{aw}}
\newcommand{\ac  }{\mathsf{ac}}
\newcommand{\aid }{{\ai{\downarrow}}}
\newcommand{\awd }{{\aw{\downarrow}}}
\newcommand{\acd }{{\ac{\downarrow}}}
\newcommand{\aiu }{{\ai{\uparrow}}}
\newcommand{\awu }{{\aw{\uparrow}}}
\newcommand{\acu }{{\ac{\uparrow}}}
\newcommand{\swi }{\mathsf{s}}
\newcommand{\med }{\mathsf{m}}
\emph{System\/ $\SKS$} is a CoS proof system, defined by the following \emph{structural} inference rules:
\[
\begin{array}{@{}c@{}c@{}c@{}}
      \vlinf\aid{}{\vls[a.{\bar a}]}\ttt&
\qquad\vlinf\awd{}a\fff                 &
\qquad\vlinf\acd{}a{\vls[a.a]}          \\
\noalign{\smallskip}
      \emph{identity}                   &
\qquad\emph{weakening}                  &
\qquad\emph{contraction}                \\
\noalign{\bigskip}
      \vlinf\aiu{}\fff{\vls(a.{\bar a})}&
\qquad\vlinf\awu{}\ttt a                &
\qquad\vlinf\acu{}{\vls (a.a)}a         \\
\noalign{\smallskip}
      \emph{cut}&
\qquad\emph{coweakening}&
\qquad\emph{cocontraction}\\
\end{array}
\quad,
\]
and by the following two \emph{logical} inference rules:
\[
\begin{array}{@{}c@{}c@{}}
\vlinf\swi{}{\vls[(\alpha.\beta).\gamma]}{\vls(\alpha.[\beta.\gamma])}&\qquad
\vlinf\med{}{\vls([\alpha.\gamma].[\beta.\delta])}
            {\vls[(\alpha.\beta).(\gamma.\delta)]}                    \\
\noalign{\smallskip}
\emph{switch}                                                         &\qquad
\emph{medial}                                                         \\
\end{array}
\quad.
\]
In addition to these rules, there is a rule $\vlsmash{\vlinf={}\delta\gamma}$, such that $\gamma$ and $\delta$ are opposite sides in one of the following equations:
\begin{equation}\label{Eq}
\begin{array}{@{}r@{}l@{}r@{}l@{}}
\vls[\alpha.\beta]         &{}=\vls[\beta.\alpha]         &\qquad\qquad
\vls[\alpha.\fff]          &{}=\vls[\alpha]               \\
\noalign{\smallskip}
\vls(\alpha.\beta)         &{}=\vls(\beta.\alpha)         &\qquad\qquad
\vls(\alpha.\ttt)          &{}=\vls(\alpha)               \\
\noalign{\smallskip}
\vls[[\alpha.\beta].\gamma]&{}=\vls[\alpha.[\beta.\gamma]]&\qquad\qquad
\vls[\ttt.\ttt]            &{}=\vls[\ttt]                 \\
\noalign{\smallskip}
\vls((\alpha.\beta).\gamma)&{}=\vls(\alpha.(\beta.\gamma))&\qquad\qquad
\vls(\fff.\fff)            &{}=\vls(\fff)                 
\end{array}
\quad.
\end{equation}
We do not always show the instances of rule $=$, and when we do show them, we gather several contiguous instances into one. We consider the $=$ rule as implicitly present in all systems. The first row in Figure~\ref{FigExAF} shows some $\SKS$ example derivations.

%TODO: remove this?
The equality relation $=$ on formulae is defined by closing the equations in \eqref{Eq} by reflexivity, symmetry, transitivity and by stipulating that $\alpha=\beta$ implies $\xi\vlscn[\alpha]=\xi\vlscn[\beta]$; to indicate literal equality of the formulae $\alpha$ and $\beta$ we adopt the notation $\alpha\equiv\beta$.

A \emph{cut-free} derivation is a derivation where $\aiu$ is not used, \emph{i.e.}, a derivation in $\SKS\setminus\{\aiu\}$.

%TODO: consider removing remarks about complexity
\newcommand  {\SKSg}{\mathsf{SKSg}}
\newcommand{\contr}{\mathsf{c}}
\newcommand{\cod}{{\contr{\downarrow}}}
\newcommand{\cou}{{\contr{\uparrow}}}
Besides $\SKS$, another standard deep-inference system is $\SKSg$, which is the same as $\SKS$, except that it does not contain medial and its structural rules are not restricted to atoms. In particular, we use in this paper the rules
\[
\vlinf\cod{}\alpha{\vls[\alpha.\alpha]}
\qquad\text{and}\qquad
\vlinf\cou{}{\vls(\alpha.\alpha)}\alpha
\quad.
\]
Clearly, a derivation in $\SKS$ is also a derivation in $\SKSg$. It can easily be proved that $\SKS$ and all its fragments containing the logical and $=$ rules polynomially simulate, respectively, $\SKSg$ and its corresponding fragments \cite{BrusGugl:07:On-the-P:fk}. For example, $\{\swi,\med,=,\acd\}$ polynomially simulates $\{\swi,=,\cod\}$.

\newcommand{\KS}{\mathsf{KS}}
A notable analytic system is $\KS=\{\swi,\med,=,\aid,\awd,\acd\}$, which is complete for propositional logic \cite{BrunTiu:01:A-Local-:mz,Brun:04:Deep-Inf:rq}; this, of course, entails completeness for all the systems that contain $\KS$, such as $\SKS$.

We can replace instances of nonatomic structural rules by derivations with the same premiss and conclusion, and that only contain atomic structural rules. The price to pay is a quadratic growth in size. This is stated by the following, routine proposition (keep in mind that, from now on, we consider the $=$ rule as implicitly present in all systems). An example is the rightmost upper derivation in Figure~\ref{FigExAF}, which stands for a nonatomic cocontraction.

%-------------------------------------------------------------------------------
%TODO: consider removing this
%\begin{proposition}\label{PropGenAtPol}
%Rule instances of\/ $\gwd$, $\gwu$, $\gcd$ and\/ $\gcu$ can be derived in quadratic time by %derivations in\/ $\{\awd\}$, $\{\awu\}$, $\{\med,\acd\}$ and\/ $\{\med,\acu\}$, respectively.
%\end{proposition}

Sometimes, we use a nonatomic rule instance to stand for some derivation in $\SKS$ that derives that instance, as per Remark~\ref{RemGenericContraction}.

For CoS proofs, we adopt a special notation that allows us considerable efficiency in describing derivations, especially in the crucial Definition~\ref{DefNorm}. We denote with $\xi\vlscn[\Phi]$ the result of including every formula of $\Phi$ into the context $\xi\vlhole$: since we adopt deep inference, $\xi\vlscn[\Phi]$ is a valid derivation. Then, given the two derivations $\vldownsmash{\vlder\Phi{}\beta\alpha}$ and $\vldownsmash{\vlder\Psi{}\delta\gamma}$, by $\vls[\Phi.\Psi]$ and $\vls(\Phi.\Psi)$ we denote, respectively,
\[
\vlinf={}{\vlsbr[\beta\;\;.\;\;\vlder\Psi{}\delta\gamma]}
         {\vlsbr[\vlder\Phi{}\beta\alpha\;\;.\;\;\gamma]}
\qquad\text{and}\qquad
\vlinf={}{\vlsbr(\beta\;\;.\;\;\vlder\Psi{}\delta\gamma)}
         {\vlsbr(\vlder\Phi{}\beta\alpha\;\;.\;\;\gamma)}
\quad,
\]
or any other CoS derivations obtained by interleaving $\Phi$ and $\Psi$ and respecting the specified logical relations between $\Phi$ and $\Psi$. We call this the \emph{Formalism A} notation. Examples of Formalism A derivations are in the second row of Figure~\ref {FigExAF}, in correspondence with CoS derivations in the first row. Note that we omit structural rule names in Formalism A notation (since they are easily inferable, this improves legibility). Because of its convenience, the Formalism A notation is currently being developed as a full-fledged deep-inference formalism.

%===============================================================================
\section{Atomic Flows}\label{SectAF}

Atomic flows, which have been introduced in \cite{GuglGund:07:Normalis:lr}, are, essentially, specialised Buss flow graphs \cite{Buss:91:The-Unde:uq}. They are particular directed graphs associated with $\SKS$ derivations: every derivation yields one atomic flow obtained by tracing the atom occurrences inside the derivation. Infinitely many derivations correspond to each atomic flow; this suggests that much of the information inside a derivation is lost in its associated atomic flow; in particular, there is no information about instances of logical rules, only structural rules play a role. As shown in \cite{GuglGund:07:Normalis:lr}, it turns out that atomic flows contain sufficient structure to control normalisation procedures, providing in particular induction measures that can be used to ensure termination. Such normalisation procedures require exponential time on the size of the derivation to be normalised. In the present work we improve the complexity of proof normalisation to quasipolynomial time, but an essential role is played by the complex logical relations of threshold formulae, which are external and independent from the given proof. This means that atomic flows are not sufficient to define the normalisation procedure; however, they still are a very convenient tool for defining and understanding several of its aspects.

We can single out three features of atomic flows that, in general, and not just in this work, help in designing normalisation procedures:

%TODO: rewrite
\begin{enumerate}
%---------------------------------------
\item\label{ItemUseTop} Atomic flows conveniently express the topological structure of atom occurrences in a proof. This is especially useful for defining the `simple form' of proofs, in Definition~\ref{DefSimpleForm}.
%---------------------------------------
\item\label{ItemUseSubst} Atomic flows provide for an efficient way to control substitutions for atom occurrences in derivations. This is especially useful for defining the `cut-free form' of proofs, in Definition~\ref{DefNorm}.
%---------------------------------------
\item\label{ItemUseNorm} We can define graph rewriting systems over atomic flows that control normalisation procedures on derivations. This could be used for obtaining the `analytic form' of proofs, as we do in Theorem~\ref{ThNormAn}. 
\end{enumerate}
Our aim now is to quickly and informally provide the necessary notions about atomic flows, especially concerning aspects \eqref{ItemUseTop} and \eqref{ItemUseSubst} above. Although the feature \eqref{ItemUseNorm} of atomic flows did help us in obtaining proofs in analytic form, we estimate that formally introducing the necessary machinery is unjustified in this paper. In fact, given our limited needs here, we can operate directly on derivations, without the intermediate support of atomic flows. Nonetheless, being aware of the underlying atomic-flow methods is useful for the reader who wishes to further investigate this matter. So, we informally provide, in Section~\ref{SectNorm}, enough material to make the connection with the atomic-flow techniques that are fully developed in \cite{GuglGund:07:Normalis:lr}.

We obtain one atomic flow from each derivation by tracing all its atom occurrences and by keeping track of their creation and destruction (in identity/cut and weakening/coweakening instances), their duplication (in contraction/cocontraction instances) and their duality (in identity/cut instances). Technically, atomic flows are directed graphs of a special kind, but it is more intuitive to consider them as diagrams generated by composing \emph{elementary atomic flows} that belong to one of seven kinds.

The first kind of elementary atomic flow is the \emph{edge}
\[
\atomicflow{
(0,0)*{\afvj4{}{}{}{}}}\quad,
\]
which corresponds to one or more occurrences of the same atom in a given derivation, all of which are not active in any structural rule instance, \emph{i.e.}, they are not the atom occurrences that instantiate a structural rule.

The other six kinds of elementary diagrams are associated with the six structural inference rules, as shown in Figure~\ref{FigVertAF}, and they are called \emph{vertices}; each vertex has some incident edges. At the left of each arrow, we see an instance of a structural rule, where the atom occurrences are labelled by small numerals; at the right of the arrow, we see the vertex corresponding to the rule instance, whose incident edges are labelled in accord with the atom occurrences they correspond to. We qualify each vertex according to the rule it corresponds to; for example, in a given atomic flow, we might talk about a \emph{contraction vertex}, or a \emph{cut vertex}, and so on. Instead of small numerals, sometimes we use $\epsilon$ or $\iota$ or colour to label edges (as well as atom occurrences), but we do not always use labels.

\newcommand{\one  }{{\mathchoice{\scriptstyle      \mathbf1}
                                {\scriptstyle      \mathbf1}
                                {\scriptstyle      \mathbf1}
                                {\scriptscriptstyle\mathbf1}}}
\newcommand{\two  }{{\mathchoice{\scriptstyle      \mathbf2}
                                {\scriptstyle      \mathbf2}
                                {\scriptstyle      \mathbf2}
                                {\scriptscriptstyle\mathbf2}}}
\newcommand{\three}{{\mathchoice{\scriptstyle      \mathbf3}
                                {\scriptstyle      \mathbf3}
                                {\scriptstyle      \mathbf3}
                                {\scriptscriptstyle\mathbf3}}}
\newcommand{\four }{{\mathchoice{\scriptstyle      \mathbf4}
                                {\scriptstyle      \mathbf4}
                                {\scriptstyle      \mathbf4}
                                {\scriptscriptstyle\mathbf4}}}
\newcommand{\five }{{\mathchoice{\scriptstyle      \mathbf5}
                                {\scriptstyle      \mathbf5}
                                {\scriptstyle      \mathbf5}
                                {\scriptscriptstyle\mathbf5}}}
%-------------------------------------------------------------------------------
\begin{figure}
\[
\begin{array}{@{}c@{}c@{}c@{}c@{}c@{}c@{}}
\vlinf\aid{}{\vls[a^\one.\bar a^\two]}\ttt&\quad{\to}\quad
	\atomicflow{(0,0)*{\afaid\one{}{}\two{}{}}}&\qquad\qquad
\vlinf\awd{}{a^\one}\fff&\quad{\to}\quad
	\atomicflow{(0,0)*{\afawd{}{}{}\one}}&\qquad\qquad
\vlinf\acd{}{a^\three}{\vls[a^\one.a^\two]}&\quad{\to}\quad
	\atomicflow{(0,0)*{\afacd\one{}{}\two{}\three}}
\\
\noalign{\bigskip}
\vlinf\aiu{}\fff{\vls(a^\one.\bar a^\two)}&\quad{\to}\quad
	\atomicflow{(0,0)*{\afaiu\one{}{}\two{}{}}}&\qquad\qquad
\vlinf\awu{}\ttt{a^\one}&\quad{\to}\quad
	\atomicflow{(0,0)*{\afawu{}{}{}\one}}&\qquad\qquad
\vlinf\acu{}{\vls(a^\one.a^\two)}{a^\three}&\quad{\to}\quad
	\atomicflow{(0,0)*{\afacu\one{}{}\two{}\three}}\\
\end{array}
\]
\caption{Vertices of atomic flows.}
\label{FigVertAF}
\end{figure}

All edges are directed, but we do not explicitly show the orientation. Instead, we consider it as implicitly given by the way we draw them, namely, edges are oriented along the vertical direction. So, the vertices corresponding to dual rules, in Figure~\ref{FigVertAF}, are distinct, for example, an identity vertex and a cut vertex are different because the orientation of their edges is different. On the other hand, the horizontal direction plays no role in distinguishing atomic flows; this corresponds to commutativity of logical relations.

\newcommand{\ppl}{{\mathchoice{\scriptstyle+}
                              {\scriptstyle+}
                              {\scriptstyle+}
                              {\scriptscriptstyle+}}}
\newcommand{\pmi}{{\mathchoice{\scriptstyle-}
                              {\scriptstyle-}
                              {\scriptstyle-}
                              {\scriptscriptstyle-}}}
We can define (\emph{atomic}) \emph{flows} as the smallest set of diagrams containing elementary atomic flows, and closed under the composition operation consisting in identifying zero or more edges such that no cycle is created. In addition, for a diagram to be an atomic flow, it must be possible to assign it a polarity, according to the following definition. A \emph{polarity assignment} is a mapping of each edge to an element of $\{\pmi,\ppl\}$, such that the two edges of each identity or cut vertex map to different values and the three edges of each contraction or cocontraction vertex map to the same value. We denote atomic flows by $\phi$ and $\psi$.

Let us see some examples. The flow
\begin{equation}\label{ExFlow}
\atomicflow{
(17,12)*{\afaid{}{}{}{}{}{}};
(-3, 8)*{\afvjd8{}{}};
(-1, 8)*{\afvjd8{}{}};
( 1, 8)*{\afvjd8{}{}};
( 4, 8)*{\afvjd8{}{}};
(10, 8)*{\afacu{}{}{}{}{}{}};
(17, 4)*{\afaiu{}{}{}{}{}{}};
( 6, 2)*{\afaiunw{}{}}}
\end{equation}
is obtained by juxtaposing (\emph{i.e.}, composing by identifying zero edges):
\begin{itemize}
\item three edges, 
\item a flow obtained by composing a cut vertex with a cocontraction vertex, and
\item a flow obtained by composing an identity vertex with a cut vertex.
\end{itemize}
Note that there are no cycles in the flow, and that we can find 32 different polarity assignments, \emph{i.e.}, two for each of the five connected components of the flow (this is a general rule).

Let us see another example. These are three different representations of the same flow:
\[
\atomicflow{
(10,8)*{\afacu\four{}{}{}{}\two};
( 0,8)*{\afvjd8\one{}};
( 4,8)*{\afvjd8{}\five};
( 6,2)*{\afaiunw{}{}};
( 6,0)*{\afaiuex{}{}{}\three{}{}31}}
\quad,\qquad
\atomicflow{
( 0,6)*{\afvjd{8}\one\ppl};
( 6,6)*{\afacu\three{}{}\four\two\pmi};
(12,6)*{\afvjd{8}\ppl\five};
(10,0)*{\afaiunw{}{}};
( 2,0)*{\afaiunw{}{}}}
\qquad\text{and}\qquad
\atomicflow{
( 8,10)*{\afacu{}\three{}\four\two\ppl};
( 0, 8)*{\afvjd{12}\one\pmi};
( 4,10)*{\afvjd{8}\five\pmi};
( 5, 4)*{\afex24};
(10, 4)*{\afvj4};
( 2, 0)*{\afaiunw{}{}};
( 8, 0)*{\afaiunw{}{}}}
\quad,
\]
where we label edges to show their correspondence. In the two rightmost flows, we indicate the two different polarity assignments that are possible.

The following two diagrams are not atomic flows:
\[
\atomicflow{
(4,11.7)*{\afacu{}{}{}{}{}{}};
(0, 3.7)*{\afacd{}{}{}{}{}{}};
(8, 7.7)*{\afvj{16}};
(4,16);(8,16)**[|<\atflowthickone>]\crv{(4,18)&(6,20)&(8,18)};
(0,0);(8,0)**[|<\atflowthickone>]\crv{(0,-2)&(4,-4)&(8,-2)}}
\qquad\text{and}\qquad
\atomicflow{
(0,4)*{\afaidnw{}{}};
(0,0)*{\afacd{}{}{}{}{}{}}}
\quad.
\]
The left one is not a flow because it contains a cycle, and the right one because there is no possible polarity assignment.

Let us see how to extract atomic flows from derivations. Given an $\SKS$ derivation $\Phi$, we obtain, by the following prescriptions, a unique atomic flow $\phi$, such that there is a surjective map between atom occurrences in $\Phi$ and edges of $\phi$:
\begin{itemize}
%-------------------
\item Each structural inference step in $\Phi$ is associated with one and only one vertex in $\phi$, such that active atom occurrences in the rule instance map to edges incident with the vertex. The correspondence is indicated in Figure~\ref{FigVertAF}. For example, the flow associated with the inference step at the left is indicated at the right:
\[
\vlinf\acd
      {}
      {\vls(a^\one.[b^\two.a^\five])}
      {\vls(a^\one.[b^\two.[a^\three.a^\four]])}
\qquad\text{and}\qquad
\vcenter{\hbox{$\atomicflow{
( 0,0)*{\afvjd8\one{}};
( 4,0)*{\afvjd8\two{}};
(10,0)*{\afacd\three{}{}\four{}\five}}$}}
\quad.
\]
Note that the nonactive atoms are `traced' by associating each trace with one edge; this corresponds well to abbreviating, say, the inference step $\vldownsmash{\vlinf\acd{}{\xi\vlscn[a]}{\xi\vlscn[a.a]}}$ by $\xi\left\{\vlinf{}{}a{\vls[a.a]}\right\}$.
%-------------------
\item For each other inference step in $\Phi$, all the atom occurrences in the premiss are respectively mapped to the same edges of $\phi$ as the atom occurrences in the conclusion. For example, the flow associated with the inference step
\[
\vlinf\med
      {}
      {\vls(a^\one.([b^\two.d^\four]).([c^\three.e^\five]))}
      {\vls(a^\one.[(b^\two.c^\three).(d^\four.e^\five)])}
\qquad\text{is}\qquad
\atomicflow{
( 0,0)*{\afvjd8\one{}};
( 4,0)*{\afvjd8\two{}};
( 8,0)*{\afvjd8\three{}};
(12,0)*{\afvjd8\four{}};
(16,0)*{\afvjd8\five{}}}
\quad.
\]
\end{itemize}
The flow $\phi$ so obtained is called the atomic flow \emph{associated with} the derivation $\Phi$. We show three examples in Figure~\ref{FigExAF}: in the top row we see three $\SKS$ derivations in the standard CoS syntax; in the row below, we show the same derivations in the Formalism A notation; in the bottom row, we see the three corresponding atomic flows.

\newcommand{\RD}[1]{{\color{Red}#1}}
\newcommand{\GR}[1]{{\color{Green}#1}}
\newcommand{\DO}[1]{{\color{DarkOrchid}#1}}
\newcommand{\PB}[1]{{\color{ProcessBlue}#1}}
\newcommand{\MG}[1]{{\color{Magenta}#1}}
\newcommand{\SG}[1]{{\color{SpringGreen}#1}}
\newcommand{\RS}[1]{{\color{RawSienna}#1}}
\newcommand{\YO}[1]{{\color{YellowOrange}#1}}
\newcommand{\PW}[1]{{\color{Periwinkle}#1}}
%-------------------------------------------------------------------------------
\begin{figure}
\[
%---------------------------------------
\begin{array}{@{}c@{}c@{}c@{}}
\vlderivation                                                {
\vlin=   {}{\ttt                                  }         {
\vlin\aiu{}{\vls[\fff.\ttt]                       }        {
\vlin=   {}{\vls[(\GR{a}.\RD{\bar a}).\ttt]       }       {
\vlin\swi{}{\vls[[(\RD{\bar a}.\GR{a}).\ttt].\ttt]}      {
\vlin=   {}{\vls[(\RD{\bar a}.[\GR{a}.\ttt]).\ttt]}     {
\vlin\swi{}{\vls[([\GR{a}.\ttt].\RD{\bar a}).\ttt]}    {
\vlin=   {}{\vls([\GR{a}.\ttt].[\RD{\bar a}.\ttt])}   {
\vlin\med{}{\vls([\GR{a}.\ttt].[\ttt.\RD{\bar a}])}  {
\vlin=   {}{\vls[(\GR{a}.\ttt).(\ttt.\RD{\bar a})]} {
\vlin\aid{}{\vls[\GR{a}.\RD{\bar a}]              }{
\vlhy      {\ttt                                  }}}}}}}}}}}}
\qquad&
%-------------------
\vlderivation                                                              {
\vlin\aiu{}
   {\vls(\DO{a}.\fff)                                            }        {
\vlin=   {}
   {\vls(\DO{a}.(\PB{a}.\MG{\bar a}))                            }       {
\vlin\acu{}
   {\vls((\DO{a}.\PB{a}).\MG{\bar a})                            }      {
\vlin=   {}
   {\vls(\SG{a}.\MG{\bar a})                                     }     {
\vlin\aiu{}
   {\vls([\fff.\SG{a}].\MG{\bar a})                              }    {
\vlin\acd{}
   {\vls([(\RD{a}.\RS{\bar a}).\SG{a}].\MG{\bar a})              }   {
\vlin\swi{}
   {\vls([(\RD{a}.[\GR{\bar a}.\YO{\bar a}]).\SG{a}].\MG{\bar a})}  {
\vlin=   {}
   {\vls((\RD{a}.[[\GR{\bar a}.\YO{\bar a}].\SG{a}]).\MG{\bar a})} {
\vlin\aid{}
   {\vls((\RD{a}.[\GR{\bar a}.[\YO{\bar a}.\SG{a}]]).\MG{\bar a})}{
\vlhy        
   {\vls((\RD{a}.[\GR{\bar a}.\ttt]).\MG{\bar a})                }}}}}}}}}}}
\qquad&
%-------------------
\vlderivation                                                            {
\vlin=   {}{\vls(([\RS{a}.\YO{b}].\PW{a}).([\GR{a}.\DO{b}].\SG{a}))}    {
\vlin\med{}{\vls(([\RS{a}.\YO{b}].[\GR{a}.\DO{b}]).(\PW{a}.\SG{a}))}   {
\vlin\acu{}{\vls([(\RS{a}.\GR{a}).(\YO{b}.\DO{b})].(\PW{a}.\SG{a}))}  {
\vlin\acu{}{\vls([(\RS{a}.\GR{a}).(\YO{b}.\DO{b})].\MG{a})         } {
\vlin\acu{}{\vls([(\RS{a}.\GR{a}).\PB{b}].\MG{a})                  }{
\vlhy      {\vls([\RD{a}.\PB{b}].\MG{a})                           }}}}}}}
\\
\noalign{\bigskip}
%---------------------------------------
\vlderivation                                                      {
\vlin\swi{}{\vlsbr[\vlinf{\swi}
                         {}
                         {\vls[\vlinf{}
                                     {}
                                     {\fff}
                                     {\vls(\GR{a}.\RD{\bar a})}
                              \;.\;
                              \ttt]}
                         {\vls([\GR{a}.\ttt].\RD{\bar a})}
                  \;\;.\;\;
                   \ttt
                  ]                                            }  {
\vlin\med{}{\vls([\GR{a}.\ttt].[\ttt.\RD{\bar a}])             } {
\vlin{}  {}{\vls[\GR{a}.\RD{\bar a}]                           }{
\vlhy      {\ttt                                               }}}}}
\qquad&
%-------------------
\vlinf=
      {}
      {\vls(\DO{a}\;.\;\vlinf{}{}\fff{\vls(\PB{a}.\MG{\bar a})})}      
      {\vlsbr(\vlinf\swi
                    {}
                    {\vls[\vlinf{}
                                {}
                                \fff
                                {\vls(\RD{a}
                                     \;.\;\vlinf{}
                                            {}
                                            {\RS{\bar a}}
                                            {\vls[\GR{\bar a}.\YO{\bar a}]}
                                     )}
                         \;\;.\;\;
                         \vlinf{}{}{\vls(\DO{a}.\PB{a})}{\SG{a}}
                         ]}
                    {\vls(\RD{a}
                         \;.\;[\GR{\bar a}
                          \;.\;\vlinf{}
                                 {}
                                 {\vls[\YO{\bar a}.\SG{a}]}
                                 \ttt
                          ]
                         )}
            \;\;\;.\;\;\;
            \MG{\bar a}
            )}
\qquad&
%-------------------
\vls(\vlinf\med
           {}
           {\vls([\RS{a}.\YO{b}].[\GR{a}.\DO{b}])}
           {\vls[\vlinf{}{}{\vls(\RS{a}.\GR{a})}{\RD{a}}
                \;.\;{\vlinf{}{}{\vls(\YO{b}.\DO{b})}{\PB{b}}}
                ]}
    \;\;.\;\;
     \vlinf{}{}{\vls(\PW{a}.\SG{a})}{\MG{a}}
    )
\\
\noalign{\bigskip}
%---------------------------------------
\atomicflow{
(0,0)*{\afaiucol{}{}{}{}{}{}{Green}{Red}{}};
(0,4)*{\afaidnw{}{}}}
\qquad&
%-------------------
\atomicflow{
( 2,14)*{\afvjcol4{Green}};
( 0,10)*{\afvjcol{12}{Red}};
(16,10)*{\afvjcol{12}{Magenta}};
( 4, 8)*{\afacdcol{}{}{}{}{}{}{Green}{YellowOrange}{RawSienna}};
(10, 8)*{\afacucol{}{}{}{}{}{}{DarkOrchid}{ProcessBlue}{SpringGreen}};
( 2, 2)*{\afaiunw{}{}};
( 8, 2)*{\afvjcol4{DarkOrchid}};
(14, 2)*{\afaiunw{}{}};
( 8,12)*{\afaidnw{}{}}}
\qquad&
%-------------------
\atomicflow{
( 0,0)*{\afacucol{}{}{}{}{}{}{RawSienna}{Green}{Red}};
( 6,0)*{\afacucol{}{}{}{}{}{}{YellowOrange}{DarkOrchid}{ProcessBlue}};
(12,0)*{\afacucol{}{}{}{}{}{}{Periwinkle}{SpringGreen}{Magenta}}}
\end{array}
\]
\caption{Examples of derivations in CoS and Formalism A notation, and associated atomic flows.}
\label{FigExAF}
\end{figure}

Perhaps surprisingly, it can be proved that every flow is associated with infinitely many $\SKS$ derivations (see \cite{GuglGund:07:Normalis:lr}).

We introduce now some graphical shortcuts. When certain details of a flow are not important, but only the vertex kinds and its upper and lower edges are, we can use boxes, labelled with all the vertex kinds that can appear in the flow they represent. For example, the following left and centre flows could represent the previously seen flow~\eqref{ExFlow}, whereas the right flow cannot:
\newbox\contrup\setbox\contrup=\hbox{$
   \divide\atflowunit by6\multiply\atflowunit by3\afsetunits
   \atomicflow{(0,0)*{\afacu{}{}{}{}{}{}}}$}
\newbox\contrdown\setbox\contrdown=\hbox{$
   \divide\atflowunit by6\multiply\atflowunit by3\afsetunits
   \atomicflow{(0,0)*{\afacd{}{}{}{}{}{}}}$}
\newbox\interdown\setbox\interdown=\hbox{$
   \divide\atflowunit by6\multiply\atflowunit by3\afsetunits
   \atomicflow{(0,0)*{\afaid{}{}{}{}{}{}}}$}
\newbox\interup\setbox\interup=\hbox{$
   \divide\atflowunit by6\multiply\atflowunit by3\afsetunits
   \atomicflow{(0,0)*{\afaiu{}{}{}{}{}{}}}$}
\newbox\weakdown\setbox\weakdown=\hbox{$
   \divide\atflowunit by6\multiply\atflowunit by3\afsetunits
   \atomicflow{(0,0)*{\afawd{}{}{}{}{}{}}}$}
\newbox\weakup\setbox\weakup=\hbox{$
   \divide\atflowunit by6\multiply\atflowunit by3\afsetunits
   \atomicflow{(0,0)*{\afawu{}{}{}{}{}{}}}$}
\[
%---------------------------------------
\atomicflow{
( 1   ,12)*{\afvj4};
( 3.75,12)*{\afvj4};
( 6.5 ,12)*{\afvj4};
( 9.25,12)*{\afvj4};
(12   ,12)*{\afvj4};
(11   , 9)*{\aflabelright\phi};
( 2   , 6)*{\copy\interdown};
( 6   , 6)*{\copy\interup};
( 6.5 , 6)*{\affr{13}8};
(10   , 6)*{\copy\contrup};
( 1   , 0)*{\afvj4};
( 4.67, 0)*{\afvj4};
( 8.33, 0)*{\afvj4};
(12   , 0)*{\afvj4}}
\quad,\qquad
%---------------------------------------
\atomicflow{
(11  ,14  )*{\afaid{}{}{}{}{}{}};
(-3  ,12.5)*{\afvj5};
(-1  ,12.5)*{\afvj5};
( 3  ,12.5)*{\afvj5};
( 5  ,12.5)*{\afvj5};
( 7  ,12.5)*{\afvj5};
(-2  , 9  )*{\aflabelright\psi};
( 7.5, 9  )*{\aflabelright{\psi'}};
(-2  , 6  )*{\affr48};
(-2  , 6  )*{\copy\weakdown};
( 6  , 6  )*{\affr88};
( 4  , 6  )*{\copy\interup};
( 7  , 6  )*{\copy\contrup};
(13  , 6  )*{\afvj8};
(11  ,-2  )*{\afaiu{}{}{}{}{}{}};
(-3  ,-0.5)*{\afvj5};
(-1  ,-0.5)*{\afvj5};
( 3  ,-0.5)*{\afvj5};
( 6  ,-0.5)*{\afvj5}}
\qquad\text{and}\qquad
%---------------------------------------
\atomicflow{
(11,14  )*{\afaid{}{}{}{}{}{}};
(-3,12.5)*{\afvj5};
(-1,12.5)*{\afvj5};
( 3,12.5)*{\afvj5};
( 5,12.5)*{\afvj5};
( 7,12.5)*{\afvj5};
(-2, 6  )*{\affr48};
(-2, 6  )*{\copy\weakdown};
( 4, 6  )*{\copy\contrdown};
( 6, 6  )*{\affr88};
( 7, 6  )*{\copy\contrup};
(13, 6  )*{\afvj8};
(11,-2  )*{\afaiu{}{}{}{}{}{}};
(-3,-0.5)*{\afvj5};
(-1,-0.5)*{\afvj5};
( 5,-0.5)*{\afvj5}}
\quad.
\]
The flow at the right cannot represent flow~\eqref{ExFlow} because it has the wrong number of lower edges and because a necessary cut vertex is not allowed by the labelling of the boxes. As just shown, we sometimes label boxes with the name of the flow they represent. For example, flow $\phi$ above could represent flow~\eqref{ExFlow}, and, if the centre flow stands for \eqref{ExFlow}, then flows $\psi$ and $\psi'$ are, respectively,
\[
\atomicflow{
(0,7.5)*{\afvjd9{}{}};
(2,7.5)*{\afvjd9{}{}}}
\qquad\text{and}\qquad
\atomicflow{
( 4,8  )*{\afvjd8{}{}};
(10,8  )*{\afacu{}{}{}{}{}{}};
( 1,7.5)*{\afvjd9{}{}};
(14,7.5)*{\afvjd9{}{}};
(12,2.5)*{\afvjd1{}{}};
( 6,2  )*{\afaiunw{}{}}}
\quad.
\]
When no vertex labels appear on a box, we assume that the vertices in the corresponding flow can be any (so, it does not mean that there are no vertices in the flow).

We sometimes use a double line notation for representing multiple edges. For example, the following diagrams represent the same flow:
\[
\atomicflow{
(0,10)*{\afvjd4{\epsilon_1}{}};
(2,10)*{\cdots};
(4,10)*{\afvjd4{}{\epsilon_l}};
(4, 7)*{\aflabelright\psi};
(2, 5)*{\affr86};
(0, 0)*{\afvju4{\iota_1}{}};
(2, 0)*{\cdots};
(4, 0)*{\afvju4{}{\iota_m}}}
\qquad\text{and}\qquad
\atomicflow{
(2,10)*{\afvjdm4{}{\boldsymbol\epsilon_1^l}};
(4, 7)*{\aflabelright\psi};
(2, 5)*{\affr86};
(2, 0)*{\afvjum4{}{\boldsymbol\iota_1^m}}}
\quad,
\]
where $l,m\ge0$; note that we use  $\boldsymbol\epsilon_1^l$ to denote the vector $(\epsilon_1,\dots,\epsilon_l)$. We might label multiple edges with one of the formulae that the associated atom occurrences form in a derivation.

We extend the double line notation to collections of isomorphic flows. For example, for $m\ge0$, the following diagrams represent the same flow:
\[
\atomicflow{
( 4,6)*{\afawd{}{}{\iota_1}{}};
(14,6)*{\afawd{}{}{\iota_m}{}};
( 0,4)*{\afvj4};
( 7,4)*{\cdots};
(10,4)*{\afvj4};
( 2,0)*{\afaiunw{}{}};
(12,0)*{\afaiunw{}{}}}
\qquad\text{and}\qquad
\atomicflow{
( 4,6)*{\afawdm{}{}{}{\boldsymbol\iota_1^m}};
( 0,4)*{\afvjm4};
( 2,0)*{\afaiunw{}{}}}
\quad.
\]

%TODO: check if we need this, or if we should use something more specific
We observe that the flow of every $\SKS$ derivation can always be represented as a collection of $m\ge0$ connected components as follows:
\[
%---------------------------------------
\atomicflow{
(13  ,14  )*{\afaidmex{}{}{}{}{}{}21};
( 2  ,12.5)*{\afvjm5};
(24  ,12.5)*{\afvjm5};
( 9.5, 9  )*{\aflabelright{\phi_1}};
(24.5, 9  )*{\aflabelright{\psi_1}};
( 1  , 6  )*{\copy\weakdown};
( 3  , 6  )*{\copy\weakup};
( 5.5, 6  )*{\affr{13}8};
( 6  , 6  )*{\copy\contrdown};
( 9  , 6  )*{\copy\contrup};
(16  , 6  )*{\copy\weakdown};
(18  , 6  )*{\copy\weakup};
(20.5, 6  )*{\affr{13}8};
(21  , 6  )*{\copy\contrdown};
(24  , 6  )*{\copy\contrup};
( 2  ,-0.5)*{\afvjm5};
(24  ,-0.5)*{\afvjm5};
(13  ,-2  )*{\afaiumex{}{}{}{}{}{}21};
%-------------------
(30,6)*{\cdots};
(34,0)="A";
"A"+(13  ,14  )*{\afaidmex{}{}{}{}{}{}21};
"A"+( 2  ,12.5)*{\afvjm5};
"A"+(24  ,12.5)*{\afvjm5};
"A"+( 9  , 9  )*{\aflabelright{\phi_m}};
"A"+(24  , 9  )*{\aflabelright{\psi_m}};
"A"+( 1  , 6  )*{\copy\weakdown};
"A"+( 3  , 6  )*{\copy\weakup};
"A"+( 5.5, 6  )*{\affr{13}8};
"A"+( 6  , 6  )*{\copy\contrdown};
"A"+( 9  , 6  )*{\copy\contrup};
"A"+(16  , 6  )*{\copy\weakdown};
"A"+(18  , 6  )*{\copy\weakup};
"A"+(20.5, 6  )*{\affr{13}8};
"A"+(21  , 6  )*{\copy\contrdown};
"A"+(24  , 6  )*{\copy\contrup};
"A"+( 2  ,-0.5)*{\afvjm5};
"A"+(24  ,-0.5)*{\afvjm5};
"A"+(13  ,-2  )*{\afaiumex{}{}{}{}{}{}21}}
\quad,
\]
such that each edge in flow $\phi_i$ is associated with some occurrence of some atom $a_i$, and each edge in flow $\psi_i$ is associated with some occurrence of atom $\bar a_i$. Note that it might happen that for $i\ne j$ we have $\vlsmash{a_i\equiv a_j}$. If we do not insist on dealing with connected components, we can adopt the same representation as above and stipulate that $i\ne j$ implies $\vlsmash{a_i\not\equiv a_j,\bar a_j}$. This would mean that the derivation only contains occurrences of atoms $a_1$, \dots, $a_m$, such that these atoms and their dual are all mutually distinct.

%TODO: remove paragraph?
Note that no matter how we assign a polarity, all the edges in $\phi_i$ and all those in $\psi_i$ are respectively mapped to dual polarity values. Given a polarity assignment, we talk about \emph{negative} and \emph{positive} rule instances of (co)weakening and (co)contraction rules, according to whether the edges incident with the associated vertices map to $\pmi $ or $\ppl$, respectively.

%TODO: last sentence? add a paragraph
In the following, when informally dealing with derivations, we freely transfer to them notions defined for their flows. For example, we can say that an atom occurrence is negative for a given polarity assignment (if the edge associated with the atom occurrence maps to $\pmi$) or that two atom occurrences are connected (if the associated edges belong to the same connected component). In fact, one of the advantages of working with flows is that they provide us with convenient geometrical notions.


%===============================================================================
\section{Streamlining}\label{SectStreamlining}

We know that the cut rule is admissible for derivations with premiss $\ttt$ (proofs) and, dually, that the identity rule is admissible for derivations with conclusion $\fff$ (contradictions). However, neither the cut nor the identity are admissible for generic derivations, which motivated the discovery of `streamlining'. Streamlining is a generalisation of both cut and identity elimination to derivations with no restrictions on their premiss or conclusion.

%TODO: define maximal path

Intuitively, a derivation is streamlined if every maximal path in the atomic flow associated with the derivation starts at the top or ends at the bottom of the flow. We recall the definition from \cite{GuglGund:07:Normalis:lr}:

%---------------------------------------
\begin{definition}
An $\SKS$ derivation is \emph{streamlined} if its associated atomic flow can be represented as follows:
\[
\atomicflow{
(-10,11)*{\afvjm4};
%---
(-15, 5)*{\copy\contrup};
(-10, 5)*{\affr{28}8};
( -5, 5)*{\copy\contrdown};
( 10, 5)*{\copy\interdown};
( 10, 5)*{\affr88};
( 20, 5)*{\copy\weakdown};
( 20, 5)*{\affr88};
%---
(-20, 0)*{\afvjm2};
(-10, 0)*{\afvjm2};
(  0, 0)*{\afvjm2};
( 10, 0)*{\afvjm2};
( 20, 0)*{\afvjm2};
%---
(-20,-5)*{\copy\weakup};
(-20,-5)*{\affr88};
(-10,-5)*{\copy\interup};
(-10,-5)*{\affr88};
(  5,-5)*{\copy\contrup};
( 10,-5)*{\affr{28}8};
( 15,-5)*{\copy\contrdown};
%---
(  10,-11)*{\afvjm4};
}\quad.
\]
\end{definition}

%TODO: what is a path?

Note that an atomic flow associated with a proof has no upper edges, so the top left and the two bottom left boxes in the above atomic flow would be empty. Hence, a streamlined proof is cut free and, dually, a streamlined contradiction is identity free.

The main challenge in streamlining a derivation is to make sure there are no path from an identity instance to a cut instance. Once this is achieved it is straightforward, as shown in \cite{GuglGund:07:Normalis:lr}, to use confluent and strongly normalising weakening reductions to obtain (in linear time) a streamlined derivation. This motivates the following definition:

%---------------------------------------
\begin{definition}
An $\SKS$ derivation is \emph{weakly streamlined} if its associated atomic flow can be represented as follows:
\[
\atomicflow{
(-5, 11)*{\afvjm4};
%---
( -5, 5)*{\affr{18}8};
(-10, 5)*{\copy\contrup};
( -5, 5)*{\copy\weakdown};
(  0, 5)*{\copy\contrdown};
( 10, 5)*{\affr88};
( 10, 5)*{\copy\interdown};
%---
(-10, 0)*{\afvjm2};
(  0, 0)*{\afvjm2};
( 10, 0)*{\afvjm2};
%---
(-10,-5)*{\affr88};
(-10,-5)*{\copy\interup};
(  5,-5)*{\affr{18}8};
(  0,-5)*{\copy\contrup};
(  5,-5)*{\copy\weakup};
( 10,-5)*{\copy\contrdown};
%---
(  5,-11)*{\afvjm4};
}\quad.
\]
\end{definition}

In the rest of this section we show how to weakly streamline a derivation. This is done in two steps. First, we extract the `core of the derivation', which amounts to removing each pair of connected identity and cut instances, then we construct the `normaliser', which is an operator that adds pairs of identity and cut instances to a derivation in such a way that they are ensured not to be connected. A weakly streamlined derivation is obtained by applying the normaliser to the core.

\subsection{The Core}

%TODO: reread

In this subsection, we show a procedure for removing connected identities and cuts from a derivation. The result of this procedure is weakly streamlined and we call it the `core' of the derivation. We first define the procedure in terms of atomic flows, where the reason for the name `core' is made clear. We remove the top (the identities) and the bottom (the cuts) of the atomic flow and what remains is the core. Based on the definition of the core of an atomic flow the core of a derivation follows naturally.

Notice that the core of a derivation does not have the same premiss and conclusion as the original derivation. In the next subsection we will see how we can glue several cores together to obtain a weakly streamlined derivation with the correct premiss and conclusion.

We define the core of an atomic flow:

\newcommand{\Core}{\mathsf{Core}}

%TODO: labels to edges and remark something about the uniqueness of the (co)contraction boxes
%TODO: the boxes need not be connected...

\begin{definition}\label{DefFlowCore}
Given an atomic flow
\[
\phi\;\;=\;\;\atomicflow
{
(-20, 8.5)*{\afvjm{9}};
(-13, 8)*{\afaidm{}{}{}{}{}{}};
( -6, 8.5)*{\afvjm{9}};
(-18, 0)*{\affr{8}{8}};
(-17, 2)*{\aflabelright{\phi_1}};
( -8, 0)*{\affr{8}{8}};
( -7, 2)*{\aflabelright{\phi'_1}};
( -6,-8.5)*{\afvjm{9}};
(-13,-8)*{\afaium{}{}{}{}{}{}};
(-20,-8.5)*{\afvjm{9}};
%------------
(0,0)*{\cdots};
%------------
(20, 8.5)*{\afvjm{9}};
(13, 8)*{\afaidm{}{}{}{}{}{}};
( 6, 8.5)*{\afvjm{9}};
( 8, 0)*{\affr{8}{8}};
( 9, 2)*{\aflabelright{\phi_n}};
(18, 0)*{\affr{8}{8}};
(19, 2)*{\aflabelright{\phi'_n}};
( 6,-8.5)*{\afvjm{9}};
(13,-8)*{\afaium{}{}{}{}{}{}};
(20,-8.5)*{\afvjm{9}};
%------------
(35, 11)*{\afvjm4};
%---
( 35, 5)*{\affr{18}8};
( 41.5, 7)*{\aflabelright{\psi_1}};
( 30, 5)*{\copy\contrup};
( 35, 5)*{\copy\weakdown};
( 40, 5)*{\copy\contrdown};
( 50, 5)*{\affr88};
( 51.5, 7)*{\aflabelright{\psi_2}};
( 50, 5)*{\copy\interdown};
%---
( 30, 0)*{\afvjm2};
( 40, 0)*{\afvjm2};
( 50, 0)*{\afvjm2};
%---
( 30,-5)*{\affr88};
( 31.5,-3)*{\aflabelright{\psi_3}};
( 30,-5)*{\copy\interup};
( 45,-5)*{\affr{18}8};
( 51.5,-3)*{\aflabelright{\psi_4}};
( 40,-5)*{\copy\contrup};
( 45,-5)*{\copy\weakup};
( 50,-5)*{\copy\contrdown};
%---
( 45,-11)*{\afvjm4};
}\quad,
\]
where, for $1\le i\le n$, $\phi_i$ is connected and contains no identity or cut vertices, we define the \emph{core of $\phi$} to be
\[
\Core(\phi)\;\;=\;\;
\atomicflow
{
(-21,10)*{\afvjm{12}};
(-17,15)*{\afvj2};
(-17,10)*{\affr{6}{8}};
(-17,10)*{\copy\contrup};
(-17, 5)*{\afvjm{2}};
(-18, 0)*{\affr{8}{8}};
(-17, 2)*{\aflabelright{\phi_1}};
(-21,-10)*{\afvjm{12}};
(-17,-15)*{\afvj2};
(-17,-10)*{\affr{6}{8}};
(-17,-10)*{\copy\contrdown};
(-17, -5)*{\afvjm{2}};
%
( -9,15)*{\afvj2};
( -9,10)*{\affr{6}{8}};
( -9,10)*{\copy\contrup};
( -9, 5)*{\afvjm{2}};
( -5,10)*{\afvjm{12}};
( -8, 0)*{\affr{8}{8}};
( -7, 2)*{\aflabelright{\phi'_1}};
( -9,-15)*{\afvj2};
( -9,-10)*{\affr{6}{8}};
( -9,-10)*{\copy\contrdown};
( -9, -5)*{\afvjm{2}};
( -5,-10)*{\afvjm{12}};
( -8, 0)*{\affr{8}{8}};
%------------
(0,0)*{\cdots};
%------------
( 9,15)*{\afvj2};
( 9,10)*{\affr{6}{8}};
( 9,10)*{\copy\contrup};
( 9, 5)*{\afvjm{2}};
( 5,10)*{\afvjm{12}};
( 8, 0)*{\affr{8}{8}};
( 9, 2)*{\aflabelright{\phi_n}};
( 9,-15)*{\afvj2};
( 9,-10)*{\affr{6}{8}};
( 9,-10)*{\copy\contrdown};
( 9, -5)*{\afvjm{2}};
( 5,-10)*{\afvjm{12}};
( 8, 0)*{\affr{8}{8}};
%
(21,10)*{\afvjm{12}};
(17,15)*{\afvj2};
(17,10)*{\affr{6}{8}};
(17,10)*{\copy\contrup};
(17, 5)*{\afvjm{2}};
(18, 0)*{\affr{8}{8}};
(19, 2)*{\aflabelright{\phi'_n}};
(21,-10)*{\afvjm{12}};
(17,-15)*{\afvj2};
(17,-10)*{\affr{6}{8}};
(17,-10)*{\copy\contrdown};
(17, -5)*{\afvjm{2}};
%---------
(35, 11)*{\afvjm4};
%---
( 35, 5)*{\affr{18}8};
( 41.5, 7)*{\aflabelright{\psi_1}};
( 30, 5)*{\copy\contrup};
( 35, 5)*{\copy\weakdown};
( 40, 5)*{\copy\contrdown};
( 50, 5)*{\affr88};
( 51.5, 7)*{\aflabelright{\psi_2}};
( 50, 5)*{\copy\interdown};
%---
( 30, 0)*{\afvjm2};
( 40, 0)*{\afvjm2};
( 50, 0)*{\afvjm2};
%---
( 30,-5)*{\affr88};
( 31.5,-3)*{\aflabelright{\psi_3}};
( 30,-5)*{\copy\interup};
( 45,-5)*{\affr{18}8};
( 51.5,-3)*{\aflabelright{\psi_4}};
( 40,-5)*{\copy\contrup};
( 45,-5)*{\copy\weakup};
( 50,-5)*{\copy\contrdown};
%---
( 45,-11)*{\afvjm4};
}\quad.
\]
\end{definition}

%TODO: give an example

The core of a derivation is defined based on the core of its atomic flow:

\begin{definition}\label{DefCore}
Given a derivation $\vlder{\Phi}{}{\beta}{\alpha}$ with associated atomic flow $\phi$, a \emph{core of\/ $\Phi$} is defined to be a derivation
\[
\vlder{}{}{\vls[\beta.(a_n.{\bar a_n}).\cdots.(a_1.{\bar a_1})]}{\vls([a_1.{\bar a_1}].\cdots.[a_n.{\bar a_n}].\alpha)}
\]
with associated atomic flow $\Core(\phi)$.
\end{definition}

The following proposition can easily by verified by studying the atomic flows in Definition~\ref{DefFlowCore}.

%TODO: reconsider (ask about comment, can't read it)

\begin{proposition}\label{PropStreamlinedCore}
A core of a derivation $\Phi$ is weakly streamlined and every atom occurrence that maps to an edge of a path between an identity and cut vertex in the atomic flow of $\Phi$ does not occur in an identity or cut instance in a core of $\Phi$.\end{proposition}

%TODO: Alessio said: `why?'. Why did he say that?

Notice that a derivation can have more than one core. However, we show how a core can be extracted, and we will single out the core obtained in this way and refer to it as \emph{the core}.

To be able to remove identity and cut instances from a derivation, they must first be `pulled' towards the premiss and conclusion respectively. The following lemma shows how a subformula can be `pulled' towards the `outside' of the derivation, both going up and going down.

\begin{lemma}\label{LemSuperSwitch}
Given a context $\xi\vlhole$ and a formula $\alpha$ there exist derivations $\vlder{}{\{\swi\}}{\xi\{\alpha\}}{\vls(\alpha.\xi\{\ttt\})}$ and $\vlder{}{\{\swi\}}{\vls[\xi\{\fff\}.\alpha]}{\xi\{\alpha\}}$.
\end{lemma}

\begin{proof}
We show how to construct the first derivation, the second one can be done symmetrically. We argue by induction on the number of atoms in $\xi\vlhole$. The base case, $\xi\vlhole=\vlhole$, is trivial and the inductive cases are:

\[
\vlderivation
{
 \vlin{=}{}{\xi\{\alpha\}}
 {
  \vlin{\swi}{}{\vlsbr[\vlder{\Psi}{\{\swi\}}{\xi'\{\alpha\}}{\vls(\alpha.\xi'\{\ttt\})}\;\;.\;\;\beta]}
  {
   \vlin{=}{}{\vls(\alpha.[\xi'\{\ttt\}.\beta])}
   {
    \vlhy{\vls(\alpha.\xi\{\ttt\})}
   }
  }
 }
}\qquad\mbox{and}\qquad
\vlderivation
{
 \vlin{=}{}{\xi\{\alpha\}}
 {
  \vlin{=}{}{\vlsbr(\vlder{\Psi'}{\{\swi\}}{\xi'\{\alpha\}}{\vls(\alpha.\xi'\{\ttt\})}\;\;.\;\;\beta)}
  {
   \vlhy{\vls(\alpha.\xi\{\ttt\})}
  }
 }
}\quad,
\]
for some $\xi'\vlhole$ and $\beta$ where $\beta$ is not a unit and $\Psi$ and $\Psi'$ exist by the inductive hypothesis.
\end{proof}

We show how the previous lemma can be used to pull identity instances out and up and cut instances out and down, without affecting the atomic flow.

\begin{lemma}\label{LemDecompInt}
Given a derivation $\vlder{}{}{\beta}{\alpha}$ with associated atomic flow $\phi$, there exists a derivation
\[
\vlder{}{\SKS\setminus\{\aid,\aiu\}}{\vlsbr[\beta\;.\;\vlinf{}{}{\fff}{\vls(b_m.\bar b_m)}\;.\;\cdots\;.\;\vlinf{}{}{\fff}{\vls(b_1.\bar b_1)}]}{\vlsbr(\vlinf{}{}{\vls[a_1.\bar a_1]}{\ttt}\;.\;\cdots\;.\;\vlinf{}{}{\vls[a_n.\bar a_n]}{\ttt}\;.\;\alpha)}
\]
with associated atomic flow $\phi$, for some atoms $a_1,\dots,a_n,b_1,\dots,b_m$.
\end{lemma}

\begin{proof}
Using Lemma~\ref{LemSuperSwitch} apply the following transformations to each of the identity and cut instances in $\Phi$:
\[
\vlderivation
{
 \vlde{\Psi'}{}{\beta}
 {
  \vlin{}{}{\xi\vlsbr[a.{\bar a}]}
  {
   \vlde{\Psi}{}{\xi\{\ttt\}}
   {
    \vlhy{\alpha}
   }
  }
 }
}\quad\rightarrow\quad
\vlderivation
{
 \vlde{\Psi'}{}{\beta}
 {
  \vlde{}{\{\swi\}}{\xi\vlsbr[a.{\bar a}]}
  {
   \vlhy{\vlsbr(\vlinf{}{}{\vls[a.{\bar a}]}{\ttt}\;\;.\;\;\vlder{\Psi}{}{\xi\{\ttt\}}{\alpha})}
  }
 }
}\qquad\mbox{and}\qquad
\vlderivation
{
 \vlde{\Psi'}{}{\beta}
 {
  \vlin{}{}{\xi\{\fff\}}
  {
   \vlde{\Psi}{}{\xi\vlsbr(a.{\bar a})}
   {
    \vlhy{\alpha}
   }
  }
 }
}\quad\rightarrow\quad
\vlderivation
{
 \vlde{}{\{\swi\}}{\vlsbr[\vlder{\Psi'}{}{\beta}{\xi\{\fff\}}\;\;.\;\;\vlinf{}{}{\fff}{\vls(a.{\bar a})}]}
 {
  \vlde{\Psi}{}{\xi\vlsbr(a.{\bar a})}
  {
   \vlhy{\alpha}
  }
 }
}\quad.
\]
\end{proof}

%TODO: rewrite and say that it is routine
%The way the normaliser in the next section works is by stitching together atoms from the conclusion in one copy of the core with atoms from the premiss of another copy of the core. It is therefore convenient that the number of occurrences of each atom is the same in the premiss and in the conclusion. We use (co)contractions to make sure we have exactly one occurrence of every atom.

\begin{lemma}\label{LemGenericContraction}
Given a formula $\alpha$ and a positive integer $n$, there exist derivations $\vlupsmash{\vlder{}{\{\acd,\med\}}{\alpha}{\bigvee_{i=1}^{n}\alpha}}$ and $\vlupsmash{\vlder{}{\{\acu,\med\}}{\bigwedge_{i=1}^{n}\alpha}{\alpha}}$.
\end{lemma}

\begin{proof}
%TODO
\end{proof}

\begin{remark}\label{RemGenericContraction}
In the non-atomic version of system $\SKS$ the derivations shown in Lemma~\ref{LemGenericContraction} correspond to repeated applications of (co)contractions. For this reason we sometimes write the inference rules $\vlinf{\cod}{}{\alpha}{\vls[\alpha.\alpha]}$ and $\vlinf{\cou}{}{\vls(\alpha.\alpha)}{\alpha}$ instead of the derivations $\vlder{}{\{\acd,\med\}}{\alpha}{\vls[\alpha.\alpha]}$ and $\vlupsmash{\vlder{}{\{\acu,\med\}}{\vls(\alpha.\alpha)}{\alpha}}$.
\end{remark}

\begin{theorem}\label{ThmExistCore}
Given a derivation $\vlder{\Phi}{}{\beta}{\alpha}$, a core of $\Phi$ exists.
\end{theorem}

\begin{proof}
Let $\phi$ be the atomic flow of $\Phi$ and label the sublfows of $\phi$ as in Definition~\ref{DefFlowCore}. Let atom occurrences of the atoms $a_1,\dots,a_n$ map to edges in the subflows $\phi_1,\dots,\phi_n$ respectively, let atom occurrences of the atoms $b_1,\dots,b_k$ map to edges in the subflow $\psi_2$ and let atom occurrences of the atoms $c_1,\dots,c_l$ map to edges in the subflow $\psi_3$. Then we build a core of $\Phi$ as follows:
\[
\vlderivation
{
 \vlde{\Psi_2}{\{\acd,\med\}}{\vls[\beta.(a_n.{\bar a_n}).\cdots.(a_1.{\bar a_1})]}
 {
  \vlde{\Phi'}{\SKS\setminus\{\aid,\aiu\}}{{\vlsbr[\beta\;.\;\vlinf{}{}{\fff}{\vls(c_l.\bar c_l)}\;.\;\cdots\;.\;\vlinf{}{}{\fff}{\vls(c_1.\bar c_1)}\;.\;(a_n.\bar a_n)\;.\;\cdots\;.\;(a_n.\bar a_n)\;.\;\cdots\;.\;(a_1.\bar a_1)\;.\;\cdots\;.\;(a_1.\bar a_1)]}}
  {
   \vlde{\Psi_1}{\{\acu,\med\}}{{\vlsbr([a_1.\bar a_1]\;.\;\cdots\;.\;[a_1.\bar a_1]\;.\;\cdots\;.\;[a_n.\bar a_n]\;.\;\cdots\;.\;[a_n.\bar a_n]\;.\;\vlinf{}{}{\vls[b_1.\bar b_1]}{\ttt}\;.\;\cdots\;.\;\vlinf{}{}{\vls[b_k.\bar b_k]}{\ttt}\;.\;\alpha)}}
   {
    \vlhy{\vls([a_1.{\bar a_1}].\cdots.[a_n.{\bar a_n}].\alpha)}
   }
  }
 }
}\quad,
\]
where $\Phi'$ exists by Lemma~\ref{LemDecompInt} and $\Psi_1$ and $\Psi_2$ exist by Lemma~\ref{LemGenericContraction}. By studying the proofs of Lemma~\ref{LemDecompInt} and Lemma~\ref{LemGenericContraction}, we can observe that the derivation has atomic flow $\Core(\phi)$.
\end{proof}

%TODO: in what sense is this unique

\begin{definition}
Given a derivation $\Phi$, the core of $\Phi$ obtained as described in the proof of Theorem~\ref{ThmExistCore} is called \emph{the core of $\Phi$}, denoted $\Core(\Phi)$.
\end{definition}

\subsection{The Normaliser}

We present here the main result of our work, a family of operators called the `normalisers'. Each normaliser can be thought of as a shape with holes where a derivation can be plugged. The effect of plugging a derivation into a normaliser is the same as adding identity and cut instances to the premiss and conclusion of the derivation, respectively. However, it is done in such a way as to not create any path between the identity and cut instances we add. It should now be clear how our normalisation works: the core is obtained by removing identity and cut instances and the normaliser adds them back, in a way that preserves weak streamlining.

%TODO: we don't plug in the derivation we want to normalise, but the CORE of the derivation we want to normalise

The novelty of the normalisers is that they are built independently of the derivations we want to normalise. Which normaliser to plug a derivation into is decided by the number of atoms we want to eliminate from the premiss and conclusion of the derivation.

%TODO: define 2\times\cou and 2\times\cod

\newcommand{\Norm}{\mathsf{Norm}}
\begin{definition}\label{DefNorm}
For every $n\ge 0$ the \emph{normaliser}, $\Norm_n(a_1,\dots,a_n,\Phi)$, is an operator taking as input a sequence of atoms and a derivation of the form
\[
\vlder{\Phi}{}{\vls[\beta.(a_n.{\bar a_n}).\cdots.(a_1.{\bar a_1})]}{\vls([a_1.{\bar a_1}].\cdots.[a_n.{\bar a_n}].\alpha)}\quad,
\]
and returning a derivation of the form $\vlupsmash{\vlder{\Norm_n(a_1,\dots,a_n,\Phi)}{}{\beta}{\alpha}}$. We define $\Norm_n$ inductively on $n$. Let $\Norm_0(\Phi)=\Phi$ and, for $n>0$, let $\Norm_n(a_1,\dots,a_n,\Phi)$ be
\newbox\DeltaTopK
\setbox\DeltaTopK=
\hbox{$
\vlderivation
{
 \vlde{\Norm_{n-1}(a_1,\dots,a_{n-1},\Phi)}{}{\vls[\beta.(\vlinf{\awu}{}{\ttt}{a_n}.\bar a_n)]}
 {
  \vlhy{\vls(\vlinf{\aid}{}{\vls[a_n.\bar a_n]}{\ttt}.\alpha)}
 }
}$
}
\newbox\DeltaBotK
\setbox\DeltaBotK=
\hbox{
$\vlderivation
{
 \vlde{\Norm_{n-1}(a_1,\dots,a_{n-1},\Phi)}{}{\vls[\beta.\vlinf{\aiu}{}{\fff}{\vls(a_n.\bar a_n)}]}
 {
  \vlhy{\vls([a_n.\vlinf{\awd}{}{\bar a_n}{\fff}].\alpha)}
 }
}$
}
\newbox\DeltaK
\setbox\DeltaK=
\hbox{$
\vlderivation
{
 \vlde{\Norm_{n-1}(a_1,\dots,a_{n-1},\Phi)}{}{\vls[\beta.(a_n.\vlinf{\awu}{}{\ttt}{\bar a_n})]}
 {
  \vlhy{\vls([\vlinf{\awd}{}{a_n}{\fff}.\bar a_n].\alpha)}
 }
}$
}
\[
\vlderivation
{
 \vlin{2\times\cod}{}{\beta}
 {
  \vlin{\swi}{}{\vlsbr[\beta\;\;\;.\;\;\;\beta\;\;\;.\;\;\;\box\DeltaBotK]}
  {
   \vlin{\swi}{}{\vlsbr([\beta\;\;\;.\;\;\;\box\DeltaK].\alpha)}
   {
    \vlin{2\times\cou}{}{\vlsbr(\box\DeltaTopK\;\;\;.\;\;\;\alpha\;\;\;.\;\;\;\alpha)}
    {
     \vlhy{\alpha}
    }
   }
  }
 }
}\quad.
\]
\end{definition}

%TODO: Green looks better than blue...

\begin{remark}\label{RemFlowNorm}
If the atomic flow of $\vlder{\Norm_{n-1}(a_1,\dots,a_{n-1},\Phi)}{}{\vls[\beta.(a_n.\bar a_n)]}{\vls([a_n.\bar a_n].\alpha)}$ is
\[
\atomicflow
{
(-8, 6)*{\afvjm{4}};
(-2, 6)*{\afvju{4}{a_n}{}};
( 2, 6)*{\afvju{4}{}{\bar a_n}};
( 8, 6)*{\afvjm{4}};
(-5, 0)*{\affr{8}{8}};
(-4, 2)*{\aflabelright\phi};
( 5, 0)*{\affr{8}{8}};
( 6, 2)*{\aflabelright\psi};
( 8,-6)*{\afvjm{4}};
(-2,-6)*{\afvjd{4}{a_n}{}};
( 2,-6)*{\afvjd{4}{}{\bar a_n}};
(-8,-6)*{\afvjm{4}};
}\quad,
\]
then the atomic flow of $\vlder{\Norm_n(a_1,\dots,a_n,\Phi)}{}{\beta}{\alpha}$ is
\[
\atomicflow
{
% cocontractions
%  outer
(-13.5,36.5)*{\afacumexsqcol{}{}{}{}{}{}{33}{4}{}{Blue}{Blue}};
(  2.5,36.5)*{\afacumexsqcol{}{}{}{}{}{}{33}{4}{}{Blue}{Blue}};
%  inner
( -8, 13)*{\afvjmcol{18}{Blue}};
( 14,  0)*{\afvjmcol{44}{Blue}};
(  3, 26)*{\afacumnwexsqcol{}{}{}{}{11}{2}{Blue}{Blue}};
(  8, 13)*{\afvjm{18}};
( 30, 0)*{\afvjmcol{44}{Blue}};
( 19, 26)*{\afacumnwexsqcol{}{}{}{}{11}{2}{}{Blue}};
% top boxes
(-22, 34)*{\afaidcol{}{}{}{}{}{}{Red}{Red}};
(-27, 26)*{\affr{8}{8}};
(-26, 28)*{\aflabelright{\phi}};
(-17, 26)*{\affr{8}{8}};
(-16, 28)*{\aflabelright{\psi}};
(-24, 18)*{\afawucol{}{}{}{}{}{Red}};
( -9, 13)*{\afcjlcol{22}{18}{Red}};
% middle boxes
(-2,  8)*{\afawdcol{}{}{}{}{}{Blue}};
(-5, 0)*{\affr{8}{8}};
(-4, 2)*{\aflabelright{\phi}};
( 5, 0)*{\affr{8}{8}};
( 6, 2)*{\aflabelright{\psi}};
(  2, -8)*{\afawucol{}{}{}{}{}{Red}};
% bottom boxes
( 22,-34)*{\afaiucol{}{}{}{}{}{}{Blue}{Blue}};
( 17,-26)*{\affr{8}{8}};
( 18,-24)*{\aflabelright{\phi}};
( 27,-26)*{\affr{8}{8}};
( 28,-24)*{\aflabelright{\psi}};
( 24,-18)*{\afawdcol{}{}{}{}{}{Blue}};
(  9,-13)*{\afcjlcol{22}{18}{Blue}};
% contractions
%  inner
( -8,-12.75)*{\afvjm{17.5}};
(-30,0.25)*{\afvjmcol{43.5}{Red}};
(-19,-27.5)*{\afacdmnwexsqcol{}{}{}{}{11}{2}{Red}{}};
(  8,-12.75)*{\afvjmcol{17.5}{Red}};		
(-14,0.25)*{\afvjmcol{43.5}{Red}};
( -3,-27.5)*{\afacdmnwexsqcol{}{}{}{}{11}{2}{Red}{Red}};
%  outer
( 13.5,-36)*{\afacdmexsqcol{}{}{}{}{}{}{33}{4}{Red}{}{Red}};
( -2.5,-36)*{\afacdmexsqcol{}{}{}{}{}{}{33}{4}{Red}{}{Red}};
}\quad,
\]
%TODO: explain better
where all the edges that might be in paths from the evidenced identity vertex are colored in red and all the edges that might be in paths to the evidenced cut vertex are colored in blue.
\end{remark}

%TODO: explain `evidenced'
%TODO: define pahts (from AFI) and make sure the `from' and `to' makes sense above

By studying Definition~\ref{DefFlowCore} and Remark~\ref{RemFlowNorm}, we can see how a weakly streamlined derivation can be built.

%TODO: redo lemma and proof of next theorem. check comments again.

\begin{lemma}\label{LemStreamlinedNorm}
Given a derivation $\Phi$ containing the atoms $a_1,\dots,a_n$, and such that\/ $\Norm_{k-1}(a_1,\dots,a_{k-1},\Phi)$ and\/ $\Norm_k(a_1,\dots,a_k,\Phi)$ exist for some $0<k\le n$, if\/ $\Norm_{k-1}(a_1,\dots,a_{k-1},\Phi)$ is weakly streamlined and none of the atoms $a_k,\dots,a_n$ occur in identity or cut instances in\/ $\Norm_{k-1}(a_1,\dots,a_{k-1},\Phi)$ then
\begin{itemize}
 \item none of the atoms $a_{k+1},\dots,a_n$ occur in identity or cut instances in $\Norm_k(a_1,\dots,a_k,\Phi)$, and
 \item $\Norm_k(a_1,\dots,a_k,\Phi)$ is weakly streamlined.
\end{itemize}
\end{lemma}

\begin{proof}
Refer to the atomic flow in Remark~\ref{RemFlowNorm} to observe the following:
\begin{itemize}
 \item The only atoms which occur in identity or cut instances in $\Norm_k(a_1,\dots,a_k,\Phi)$ which did not in $\Norm_{k-1}(a_1,\dots,a_{k-1},\Phi)$ are $a_k$ and $\bar a_k$.
 \item The only identity and cut vertices mapped to by $a_k$ in the atomic flow associated with $\Norm_k(a_1,\dots,a_k,\Phi)$ are the once that are evidenced; and since the red and the blue edges never coincide there can be no path between them. Furthermore, since $\Norm_{k-1}(a_1,\dots,a_{k-1},\Phi)$ is weakly streamlined a path from an identity to a cut vertex in the atomic flow associated with $\Norm_k(a_1,\dots,a_k,\Phi)$ must contain the red edge between $\psi_1$ and $\psi_2$ or the blue edge between $\phi_2$ and $\phi_3$. However, $a_k$ and $\bar a_k$ map to these edges so there can be no path from an identity to a cut vertex.
\end{itemize}
\end{proof}

%TODO: big exclamation mark at the second derivation in the following theorem

\begin{theorem}
Given a derivation $\vlder{\Phi}{}{\beta}{\alpha}$, there are atoms $a_1,\dots,a_n$ in $\Phi$ such that $\vlder{\Norm_n(a_1,\dots,a_n,\Core(\Phi))}{}{\beta}{\alpha}$ is weakly streamlined.
\end{theorem}

\begin{proof}
Choose $a_1,\dots,a_n$ such that no atoms except for $a_1,\dots,a_n$ and their duals map to a path from an identity to a cut vertex in the atomic flow associated with $\Phi$, then the result follows by Proposition~\ref{PropStreamlinedCore} and Lemma~\ref{LemStreamlinedNorm}.
\end{proof}

%===========================================
\section{Conclusion}

\bibliographystyle{alpha}
\bibliography{biblio}

\end{document}